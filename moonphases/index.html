<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Phase Lab</title>
    
    <!-- 1. Tailwind CSS for styling (loaded from web) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0F172A; font-family: sans-serif; }
        canvas { touch-action: none; } /* Prevents scrolling on mobile */
        
        /* Custom Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #A855F7;
            cursor: pointer;
            margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: #475569;
            border-radius: 2px;
        }
    </style>
</head>
<body>

    <!-- APP CONTAINER - Updated height to dynamic viewport height (dvh) for mobile -->
    <div id="app" class="w-full h-[100dvh] flex flex-col text-slate-100">
        
        <!-- LOGIN SCREEN (Hidden by default) -->
        <div id="login-screen" class="flex-grow flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-700">
                <h1 class="text-3xl font-bold text-center text-blue-400 mb-6">Moon Lab</h1>
                <form id="login-form" class="space-y-4">
                    <input type="text" id="student-name" placeholder="First Name" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-600 focus:border-blue-500 outline-none text-white" required>
                    <input type="text" id="teacher-name" placeholder="Teacher (Optional)" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-600 focus:border-blue-500 outline-none text-white">
                    <button type="submit" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg transition">Start Lab</button>
                </form>
                <div class="mt-6 pt-6 border-t border-slate-700 text-center">
                    <button id="btn-teacher-view" class="text-slate-500 hover:text-slate-300 text-sm flex gap-2 mx-auto items-center">
                        <i data-lucide="users" width="16"></i> Teacher View
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN INTERFACE (Hidden by default) -->
        <div id="main-ui" class="flex flex-col h-full hidden">
            <!-- Header -->
            <div class="bg-slate-800 p-2 shadow-md flex flex-col sm:flex-row justify-between items-center z-10 shrink-0 border-b border-slate-700 gap-2">
                <div class="flex items-center gap-4">
                    <h1 id="user-display" class="text-lg font-bold text-white hidden sm:block">Student</h1>
                    
                    <!-- Tabs -->
                    <div id="tabs-student" class="flex bg-slate-900 rounded-lg p-1">
                        <button onclick="setMode('explore')" id="tab-explore" class="px-3 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-colors bg-purple-600 text-white">
                            <i data-lucide="move" width="16"></i> Explore
                        </button>
                        <button onclick="setMode('drag-moons')" id="tab-moons" class="px-3 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-colors text-slate-400 hover:text-white">
                            <i data-lucide="mouse-pointer-2" width="16"></i> Phase Match
                        </button>
                        <button onclick="setMode('drag-labels')" id="tab-labels" class="px-3 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-colors text-slate-400 hover:text-white">
                            <i data-lucide="type" width="16"></i> Label Match
                        </button>
                    </div>
                </div>

                <div class="flex gap-2 items-center">
                    <span id="feedback-msg" class="text-xs text-slate-400 hidden sm:block">Welcome!</span>
                    <button id="btn-submit" onclick="checkAnswers()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold flex gap-2 items-center text-sm hidden">
                        <i data-lucide="check" width="16"></i> Submit
                    </button>
                    <!-- Teacher Controls -->
                    <div id="teacher-controls" class="hidden flex gap-2">
                        <button onclick="purgeData()" class="px-3 py-1.5 bg-rose-900/50 text-rose-300 border border-rose-800 rounded text-xs font-bold">Clear Data</button>
                        <button onclick="logout()" class="px-3 py-1.5 bg-slate-700 rounded text-xs font-bold">Exit</button>
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div id="canvas-container" class="flex-grow relative bg-slate-900 overflow-hidden">
                <canvas id="game-canvas" class="absolute inset-0 cursor-crosshair"></canvas>
                
                <!-- Explore Slider -->
                <div id="explore-slider-container" class="absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-md px-8">
                    <input type="range" min="0" max="360" value="0" id="explore-slider" class="w-full">
                    <div class="flex justify-between text-xs text-slate-500 mt-2 font-bold px-1">
                        <span>Left</span><span>Bottom</span><span>Right</span><span>Top</span><span>Left</span>
                    </div>
                </div>

                <!-- Teacher Table -->
                <div id="teacher-table-container" class="absolute inset-0 bg-slate-900 p-6 overflow-auto hidden">
                    <div class="max-w-5xl mx-auto bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-950 text-slate-400 uppercase font-bold">
                                <tr><th class="p-4">Name</th><th class="p-4">Teacher</th><th class="p-4">Phases</th><th class="p-4">Labels</th><th class="p-4">Time</th></tr>
                            </thead>
                            <tbody id="score-table-body" class="divide-y divide-slate-700 text-slate-300">
                                <!-- Rows injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MAIN JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // üö® PASTE YOUR CONFIG HERE üö®
        // ==========================================
        const firebaseConfig = {
            // apiKey: "...",
            // authDomain: "...",
            // ... paste everything between the curly braces here
        };

        // --- Init Firebase ---
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                signInAnonymously(auth);
            } else {
                console.warn("‚ö†Ô∏è NO FIREBASE CONFIG FOUND. App will run in offline mode (no saving).");
            }
        } catch(e) { console.error(e); }

        // --- Game State ---
        const state = {
            mode: 'explore', // explore | drag-moons | drag-labels
            user: null,
            name: '',
            teacher: '',
            isTeacher: false,
            items: [],
            zones: [],
            stars: [],
            width: 0,
            height: 0,
            dragId: null,
            dragOffset: {x:0, y:0},
            explorer: { angle: Math.PI, label: 'New Moon', sliderVal: 0 }
        };

        // --- Constants ---
        const MOON_R = 30;
        const ORBIT_SCALE = 0.35;
        const EARTH_IMG_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/The_Earth_seen_from_Apollo_17.jpg/600px-The_Earth_seen_from_Apollo_17.jpg";
        
        // --- Data ---
        const MOON_DATA = [
            { id: '1', type: 'new-moon', label: 'New Moon', correctZone: 1 },
            { id: '2', type: 'waxing-crescent', label: 'Waxing Crescent', correctZone: 2 },
            { id: '3', type: 'first-quarter', label: 'First Quarter', correctZone: 3 },
            { id: '4', type: 'waxing-gibbous', label: 'Waxing Gibbous', correctZone: 4 },
            { id: '5', type: 'full-moon', label: 'Full Moon', correctZone: 5 },
            { id: '6', type: 'waning-gibbous', label: 'Waning Gibbous', correctZone: 6 },
            { id: '7', type: 'third-quarter', label: 'Third Quarter', correctZone: 7 },
            { id: '8', type: 'waning-crescent', label: 'Waning Crescent', correctZone: 8 },
        ];

        // --- DOM Elements ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const loginScreen = document.getElementById('login-screen');
        const mainUi = document.getElementById('main-ui');
        const sliderContainer = document.getElementById('explore-slider-container');
        const slider = document.getElementById('explore-slider');
        const feedbackEl = document.getElementById('feedback-msg');
        const userDisplay = document.getElementById('user-display');
        const teacherTable = document.getElementById('teacher-table-container');
        const submitBtn = document.getElementById('btn-submit');
        const canvasContainer = document.getElementById('canvas-container'); // Get container for better sizing

        // --- Images ---
        const earthImg = new Image();
        earthImg.crossOrigin = "anonymous";
        earthImg.src = EARTH_IMG_URL;

        // --- Init ---
        function init() {
            // Generate stars
            for(let i=0; i<100; i++) state.stars.push({ x: Math.random(), y: Math.random(), size: Math.random()*2+0.5, opacity: Math.random(), speed: Math.random()*2+0.5 });
            
            // Show Login
            loginScreen.classList.remove('hidden');
            lucide.createIcons();
            
            resize();
            requestAnimationFrame(loop);
        }

        // --- Logic ---
        function resetGame(newMode) {
            state.mode = newMode;
            state.dragId = null;
            
            // Update UI Tabs
            document.querySelectorAll('#tabs-student button').forEach(b => {
                b.className = "px-3 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-colors text-slate-400 hover:text-white";
            });
            const activeBtn = document.getElementById(newMode === 'drag-moons' ? 'tab-moons' : newMode === 'drag-labels' ? 'tab-labels' : 'tab-explore');
            // Colors: Explore=Purple, Phase=Blue, Label=Emerald
            let colorClass = newMode === 'explore' ? 'bg-purple-600' : newMode === 'drag-moons' ? 'bg-blue-600' : 'bg-emerald-600';
            activeBtn.className = `px-3 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-colors text-white ${colorClass}`;

            // Visibility
            sliderContainer.style.display = newMode === 'explore' ? 'block' : 'none';
            submitBtn.style.display = newMode === 'explore' ? 'none' : 'flex';

            // Items
            if (newMode === 'explore') {
                state.items = [];
                updateExplorerFromSlider(0); // Reset to New Moon (Left)
                setFeedback('Drag moon, use slider, or arrow keys.');
            } else {
                // Shuffle items
                const shuffled = [...MOON_DATA].sort(() => Math.random() - 0.5);
                state.items = shuffled.map((m, idx) => ({
                    id: m.id,
                    type: m.type,
                    text: newMode === 'drag-labels' ? m.label : null,
                    x: 0, y: 0,
                    isDragging: false, currentZone: null, isLocked: false, bankIndex: idx
                }));
                setFeedback(newMode === 'drag-moons' ? 'Drag moons to orbit.' : 'Drag labels to moons.');
            }
            recalcLayout();
        }

        function recalcLayout() {
            if(!state.width) return;
            const cx = state.width / 2;
            const cy = (state.height - 120) * 0.5;
            const r = Math.min(state.width, state.height - 120) * ORBIT_SCALE;

            // Zones
            state.zones = [];
            for (let i = 1; i <= 8; i++) {
                let deg = 0;
                if(i===1) deg=180; else if(i===2) deg=135; else if(i===3) deg=90;
                else if(i===4) deg=45; else if(i===5) deg=0; else if(i===6) deg=315;
                else if(i===7) deg=270; else if(i===8) deg=225;
                const rad = deg * (Math.PI/180);
                state.zones.push({ id: i, x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad) });
            }

            // Snap Items to Bank or Zone
            const bankY = state.height - 60;
            const itemW = state.mode === 'drag-labels' ? 100 : 70;
            const totalW = 8 * itemW;
            const startX = (state.width - totalW)/2 + itemW/2;

            state.items.forEach(item => {
                if(item.isDragging) return;
                if(item.currentZone) {
                    const z = state.zones.find(z => z.id === item.currentZone);
                    if(z) {
                        item.x = z.x;
                        item.y = state.mode === 'drag-labels' ? z.y + 45 : z.y;
                    }
                } else {
                    item.x = startX + item.bankIndex * itemW;
                    item.y = bankY;
                }
            });
        }

        // --- Interaction Logic ---
        function updateExplorerFromSlider(val) {
            state.explorer.sliderVal = Number(val);
            slider.value = val;
            
            // Map 0 (Left) -> 360 (Left)
            // At slider 0, we want angle 180 (PI)
            // At slider 180 (Right), we want angle 0
            // Angle = 180 - slider
            
            const angleDeg = 180 - val;
            const rad = angleDeg * (Math.PI / 180);
            
            state.explorer.angle = rad;
            state.explorer.label = getPhaseLabelFromAngle(rad);
        }

        function getPhaseLabelFromAngle(rad) {
            let deg = rad * (180/Math.PI);
            while(deg <= -180) deg += 360;
            while(deg > 180) deg -= 360;
            const d = Math.abs(deg);
            if(d > 160) return 'New Moon';
            if(d > 110) return deg > 0 ? 'Waxing Crescent' : 'Waning Crescent';
            if(d > 70) return deg > 0 ? 'First Quarter' : 'Third Quarter';
            if(d > 20) return deg > 0 ? 'Waxing Gibbous' : 'Waning Gibbous';
            return 'Full Moon';
        }

        // --- Render Helpers ---
        function drawEarth(cx, cy, r) {
            ctx.save(); ctx.translate(cx, cy);
            if(earthImg.complete && earthImg.naturalWidth) {
                ctx.save(); ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.clip();
                ctx.drawImage(earthImg, -r, -r, r*2, r*2);
                // Terminator shadow
                const grad = ctx.createLinearGradient(-r, 0, r, 0);
                grad.addColorStop(0, 'rgba(0,0,0,0)');
                grad.addColorStop(0.5, 'rgba(0,0,0,0.1)');
                grad.addColorStop(1, 'rgba(0,0,0,0.85)');
                ctx.fillStyle = grad; ctx.fillRect(-r,-r,r*2,r*2);
                ctx.restore();
            } else {
                ctx.fillStyle = '#2563EB'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            }
            // Halo
            const halo = ctx.createRadialGradient(0,0,r*0.9, 0,0,r*1.2);
            halo.addColorStop(0, 'rgba(59,130,246,0.4)'); halo.addColorStop(1, 'rgba(59,130,246,0)');
            ctx.fillStyle = halo; ctx.beginPath(); ctx.arc(0,0,r*1.3,0,Math.PI*2); ctx.fill();
            ctx.restore();
        }

        function drawContinuousMoon(angle, x, y, r) {
            ctx.save(); ctx.translate(x, y);
            // Dark Base
            ctx.fillStyle = '#18181B'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            
            // Lit Path
            ctx.fillStyle = '#F4F4F5'; ctx.beginPath();
            let ang = angle % (Math.PI*2);
            if(ang < 0) ang += Math.PI*2;
            const xTerm = r * Math.cos(ang);

            if(ang >= 0 && ang < Math.PI) { // Waxing (Bottom)
                ctx.arc(0, 0, r, -Math.PI/2, Math.PI/2); // Right arc
                ctx.ellipse(0, 0, Math.abs(xTerm), r, 0, Math.PI/2, 3*Math.PI/2, xTerm < 0);
            } else { // Waning (Top)
                ctx.arc(0, 0, r, Math.PI/2, 3*Math.PI/2); // Left arc
                ctx.ellipse(0, 0, Math.abs(xTerm), r, 0, 3*Math.PI/2, Math.PI/2, xTerm < 0);
            }
            ctx.fill();
            ctx.restore();
        }

        function drawStaticMoon(type, x, y, r, inBank) {
            ctx.save(); ctx.translate(x, y);
            ctx.fillStyle = '#18181B'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            
            ctx.fillStyle = '#F4F4F5';
            const half = (right) => { ctx.beginPath(); ctx.arc(0,0,r, right?-Math.PI/2:Math.PI/2, right?Math.PI/2:-Math.PI/2); ctx.fill(); };
            
            if(type.includes('full')) { ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); }
            else if(type.includes('first')) half(true);
            else if(type.includes('third')) half(false);
            else if(type.includes('waxing-crescent')) { half(true); ctx.fillStyle='#18181B'; ctx.beginPath(); ctx.ellipse(0,0,r*0.6,r,0,0,Math.PI*2); ctx.fill(); }
            else if(type.includes('waning-crescent')) { half(false); ctx.fillStyle='#18181B'; ctx.beginPath(); ctx.ellipse(0,0,r*0.6,r,0,0,Math.PI*2); ctx.fill(); }
            else if(type.includes('waxing-gibbous')) { half(true); ctx.beginPath(); ctx.ellipse(0,0,r*0.6,r,0,0,Math.PI*2); ctx.fill(); }
            else if(type.includes('waning-gibbous')) { half(false); ctx.fillStyle='#F4F4F5'; ctx.beginPath(); ctx.ellipse(0,0,r*0.6,r,0,0,Math.PI*2); ctx.fill(); }

            if(inBank) {
                ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
            }
            ctx.restore();
        }

        function drawLabel(text, x, y, isLocked) {
            ctx.save(); ctx.translate(x,y);
            ctx.font = 'bold 12px sans-serif';
            const w = ctx.measureText(text).width + 20;
            ctx.fillStyle = isLocked ? '#22C55E' : '#334155';
            ctx.strokeStyle = isLocked ? '#166534' : '#94A3B8';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.roundRect(-w/2, -13, w, 26, 4); ctx.fill(); ctx.stroke();
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }

        function loop() {
            // 1. Background
            ctx.fillStyle = '#0F172A'; ctx.fillRect(0,0,state.width, state.height);
            
            // Stars
            state.stars.forEach(s => {
                ctx.globalAlpha = Math.abs(Math.sin(Date.now() * s.speed * 0.001)) * s.opacity;
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(s.x*state.width, s.y*state.height, s.size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1.0;

            // Sun
            const sunGrad = ctx.createLinearGradient(0,0,150,0);
            sunGrad.addColorStop(0, 'rgba(253, 186, 116, 0.4)'); sunGrad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = sunGrad; ctx.fillRect(0,0,150,state.height);
            ctx.save(); ctx.translate(30, state.height/2); ctx.rotate(-Math.PI/2);
            ctx.fillStyle = '#FDBA74'; ctx.font = 'bold 24px sans-serif'; ctx.fillText('SUNLIGHT', -50, 0); ctx.restore();

            // Earth
            const cx = state.width / 2;
            const cy = (state.height - 120) * 0.5;
            const r = Math.min(state.width, state.height - 120) * ORBIT_SCALE;
            
            ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle = '#334155'; ctx.setLineDash([10,10]); ctx.stroke(); ctx.setLineDash([]);
            drawEarth(cx, cy, r*0.35);

            // Bank Background (Behind items)
            if(state.mode !== 'explore') {
                ctx.fillStyle = '#334155'; ctx.fillRect(0, state.height-110, state.width, 110);
                ctx.fillStyle = '#CBD5E1'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'left';
                ctx.fillText(state.mode === 'drag-moons' ? 'MOON BANK' : 'LABEL BANK', 20, state.height-90);
            }

            // --- Explore Mode ---
            if(state.mode === 'explore') {
                const ex = state.explorer;
                const mx = cx + r * Math.cos(ex.angle);
                const my = cy + r * Math.sin(ex.angle);
                
                // Line
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(mx, my); ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.stroke();
                
                // Moon
                drawContinuousMoon(ex.angle, mx, my, MOON_R * 1.5);
                
                // Label
                drawLabel(ex.label, mx, my - 55, false);
            } 
            // --- Game Modes ---
            else {
                // Zones
                state.zones.forEach(z => {
                    // Drop target highlight
                    if(state.dragId) {
                        const item = state.items.find(i => i.id === state.dragId);
                        const dist = Math.hypot(item.x - z.x, item.y - z.y);
                        const hitR = state.mode === 'drag-labels' ? 60 : MOON_R * 1.5;
                        if(dist < hitR) {
                            ctx.strokeStyle = '#60A5FA'; ctx.lineWidth = 3;
                            ctx.beginPath(); ctx.arc(z.x, z.y, MOON_R+5, 0, Math.PI*2); ctx.stroke();
                        }
                    }

                    if(state.mode === 'drag-moons') {
                        ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; ctx.setLineDash([5,5]);
                        ctx.beginPath(); ctx.arc(z.x, z.y, MOON_R+5, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
                        ctx.fillStyle = '#475569'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        ctx.fillText(z.id, z.x, z.y);
                    } else {
                        // Label match: Show correct moon
                        const m = MOON_DATA.find(d => d.correctZone === z.id);
                        if(m) drawStaticMoon(m.type, z.x, z.y, MOON_R, false);
                        // Box target
                        ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
                        ctx.strokeRect(z.x - 40, z.y + 32, 80, 26); ctx.setLineDash([]);
                    }
                });

                // Items
                // Sort dragging to top
                state.items.sort((a,b) => a.isDragging ? 1 : -1).forEach(item => {
                    if(state.mode === 'drag-moons' && !item.text) {
                        const inBank = !item.currentZone && !item.isDragging;
                        drawStaticMoon(item.type, item.x, item.y, MOON_R, inBank);
                        
                        // Show label if in bank or dragging, OR if docked in Phase Match (New Feature)
                        ctx.fillStyle = '#E2E8F0'; ctx.font = '11px sans-serif'; ctx.textAlign = 'center';
                        ctx.fillText(MOON_DATA.find(m=>m.id===item.id).label, item.x, item.y + MOON_R + 15);
                        
                        if(item.isLocked) drawCheckmark(item.x + 20, item.y - 20);
                    } 
                    else if(state.mode === 'drag-labels' && item.text) {
                        drawLabel(item.text, item.x, item.y, item.isLocked);
                        if(item.isLocked) drawCheckmark(item.x + 35, item.y - 15);
                    }
                });
            }

            requestAnimationFrame(loop);
        }

        function drawCheckmark(x, y) {
            ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fillStyle = '#22C55E'; ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x-5,y); ctx.lineTo(x-1,y+4); ctx.lineTo(x+4,y-3); ctx.stroke();
        }

        // --- Events ---
        window.addEventListener('resize', resize);
        function resize() {
            // Use container if visible, else fallback to window (fixes cut-off on mobile)
            if (canvasContainer && canvasContainer.clientWidth > 0) {
                state.width = canvasContainer.clientWidth;
                state.height = canvasContainer.clientHeight;
            } else {
                state.width = window.innerWidth;
                state.height = window.innerHeight;
            }
            
            canvas.width = state.width;
            canvas.height = state.height;
            recalcLayout();
        }

        canvas.addEventListener('pointerdown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if(state.mode === 'explore') return; // Slider only

            // Find clicked item
            const hitR = state.mode === 'drag-labels' ? 40 : MOON_R;
            const item = [...state.items].reverse().find(i => Math.hypot(i.x - x, i.y - y) < hitR);
            
            if(item && !item.isLocked) {
                state.dragId = item.id;
                state.dragOffset = { x: item.x - x, y: item.y - y };
                item.isDragging = true;
                canvas.setPointerCapture(e.pointerId);
            }
        });

        canvas.addEventListener('pointermove', e => {
            if(!state.dragId) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const item = state.items.find(i => i.id === state.dragId);
            if(item) {
                item.x = x + state.dragOffset.x;
                item.y = y + state.dragOffset.y;
            }
        });

        canvas.addEventListener('pointerup', e => {
            if(!state.dragId) return;
            const item = state.items.find(i => i.id === state.dragId);
            
            // Hit Test
            let hit = null;
            const hitR = state.mode === 'drag-labels' ? 60 : MOON_R * 1.5;
            state.zones.forEach(z => {
                if(Math.hypot(item.x - z.x, item.y - z.y) < hitR) hit = z;
            });

            if(hit) {
                // Kick out existing
                const existing = state.items.find(i => i.currentZone === hit.id && i.id !== item.id);
                if(existing) { existing.currentZone = null; }
                
                item.currentZone = hit.id;
                item.x = hit.x;
                item.y = state.mode === 'drag-labels' ? hit.y + 45 : hit.y;
            } else {
                item.currentZone = null;
            }
            
            item.isDragging = false;
            state.dragId = null;
            recalcLayout(); // Snap back to bank if needed
        });

        // Slider Event
        slider.addEventListener('input', (e) => {
            updateExplorerFromSlider(Number(e.target.value));
        });

        // Arrow Keys
        window.addEventListener('keydown', (e) => {
            if(state.mode !== 'explore' || loginScreen.style.display !== 'none') return;
            let val = Number(slider.value);
            if(e.key === 'ArrowRight') val += 2;
            if(e.key === 'ArrowLeft') val -= 2;
            if(val > 360) val -= 360;
            if(val < 0) val += 360;
            updateExplorerFromSlider(val);
        });

        // --- DOM Bindings ---
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const sName = document.getElementById('student-name').value;
            if(!sName.trim()) return;
            state.name = sName;
            state.teacher = document.getElementById('teacher-name').value;
            
            userDisplay.innerText = sName;
            loginScreen.classList.add('hidden');
            mainUi.classList.remove('hidden');
            resize();
            resetGame('explore'); // Start in Explore
        };

        window.setMode = (m) => resetGame(m);
        
        window.checkAnswers = async () => {
            let count = 0;
            state.items.forEach(i => {
                const m = MOON_DATA.find(d => d.id === i.id);
                if(i.currentZone === m.correctZone) {
                    count++;
                    i.isLocked = true;
                } else {
                    i.currentZone = null; // Kick back wrong ones
                    i.isLocked = false;
                }
            });
            recalcLayout();
            setFeedback(count === 8 ? 'Perfect! Score saved.' : `You got ${count}/8. Try again.`);
            
            // Save to Firebase
            if(db) {
                const field = state.mode === 'drag-moons' ? 'score_moons' : 'score_labels';
                try {
                    await addDoc(collection(db, 'artifacts', 'elementary_moon_lab', 'public', 'data', 'scores'), {
                        name: state.name, teacher: state.teacher, [field]: count, timestamp: serverTimestamp()
                    });
                } catch(e) { console.error("Save failed", e); }
            }
        };

        // --- Teacher View ---
        document.getElementById('btn-teacher-view').onclick = () => {
            state.isTeacher = true;
            loginScreen.classList.add('hidden');
            mainUi.classList.remove('hidden');
            userDisplay.innerText = "Teacher Dashboard";
            document.getElementById('teacher-controls').classList.remove('hidden');
            document.getElementById('tabs-student').classList.add('hidden');
            document.getElementById('btn-submit').classList.add('hidden');
            sliderContainer.classList.add('hidden');
            canvas.style.display = 'none';
            teacherTable.classList.remove('hidden');
            
            // Fetch Data
            if(db) {
                const q = query(collection(db, 'artifacts', 'elementary_moon_lab', 'public', 'data', 'scores'));
                onSnapshot(q, (snap) => {
                    const tbody = document.getElementById('score-table-body');
                    tbody.innerHTML = '';
                    const rows = [];
                    snap.forEach(doc => rows.push(doc.data()));
                    rows.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
                    
                    rows.forEach(r => {
                        const time = r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleTimeString() : '';
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-700/50";
                        tr.innerHTML = `<td class="p-4 font-bold text-white">${r.name}</td>
                                        <td class="p-4">${r.teacher || '-'}</td>
                                        <td class="p-4 font-bold ${r.score_moons===8?'text-green-400':'text-slate-400'}">${r.score_moons ?? '-'}</td>
                                        <td class="p-4 font-bold ${r.score_labels===8?'text-green-400':'text-slate-400'}">${r.score_labels ?? '-'}</td>
                                        <td class="p-4 text-xs text-slate-500">${time}</td>`;
                        tbody.appendChild(tr);
                    });
                });
            }
        };

        window.logout = () => location.reload();
        window.purgeData = async () => {
            if(!confirm("Are you sure? This deletes ALL student scores.")) return;
            if(db) {
                const q = query(collection(db, 'artifacts', 'elementary_moon_lab', 'public', 'data', 'scores'));
                const snap = await getDocs(q);
                snap.forEach(d => deleteDoc(d.ref));
            }
        };

        function setFeedback(msg) {
            feedbackEl.innerText = msg;
        }

        // Initial launch
        init();

    </script>
</body>
</html>
