<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Map Geography Game V3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.2), transparent 50%);
            pointer-events: none;
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        #gameContainer {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 
                0 30px 90px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            max-width: 1400px;
            position: relative;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        #header {
            position: relative;
            text-align: center;
            margin-bottom: 16px;
            display: flex; /* Use Flexbox for alignment */
            justify-content: space-between; /* Space out items */
            align-items: center; /* Vertically align items */
        }

        #scoreContainer {
            /* No longer needs absolute positioning */
            display: flex;
            gap: 10px;
            font-weight: 700;
            font-size: 1.1em;
            color: #475569;
        }

        .score-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f5f9;
            padding: 8px 16px;
            border-radius: 12px;
        }
        
        .score-box span {
             min-width: 25px;
             text-align: center;
        }

        #correctScore { color: #16a34a; }
        #incorrectScore { color: #dc2626; }

        h1 {
            display: inline-block;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.2em;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 0; /* Remove margin as Flexbox handles spacing */
        }

        #info {
            text-align: center;
            font-size: 1.2em;
            color: #64748b;
            margin-bottom: 20px;
            min-height: 40px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        #info.correct { color: #16a34a; }
        #info.incorrect { color: #dc2626; }
        #info.mastered { color: #6d28d9; } /* Style for mastery message */
        
        #mapContainer {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(0, 0, 0, 0.05) inset;
            position: relative;
        }

        .ocean-background { fill: #bae6fd; }
        .continent {
            stroke: #ffffff;
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        .continent:hover {
            filter: brightness(1.1) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.25));
            stroke-width: 1.5;
        }
        
        #loading {
            text-align: center;
            padding: 80px;
            font-size: 1.2em;
            color: #64748b;
        }

        svg { display: block; }
        
        #quizControls {
            margin-top: 16px;
            display: flex;
            justify-content: center; /* Center the practice list now */
            align-items: center;
        }

        #practiceListContainer {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 12px 16px;
            flex-grow: 1;
            max-width: 80%; /* Give it a max-width */
        }

        #practiceListContainer h3 {
            color: #475569;
            font-weight: 700;
            margin-bottom: 8px;
        }

        #practiceList {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #practiceList li {
            background-color: #e2e8f0;
            color: #475569;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        #quizButton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.2s ease;
            /* margin-bottom is no longer needed */
        }

        #quizButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="header">
            <div id="scoreContainer">
                 <div class="score-box">‚úÖ Correct: <span id="correctScore">0</span></div>
                 <div class="score-box">‚ùå Incorrect: <span id="incorrectScore">0</span></div>
            </div>
            <h1>üåç World Geography Game üåé</h1>
            <button id="quizButton">Start Quiz</button>
        </div>
        <div id="info">Click the button to start the quiz!</div>
        <div id="mapContainer">
            <div id="loading">Loading world map...</div>
        </div>
        <div id="quizControls">
            <div id="practiceListContainer">
                <h3>Continents to Practice:</h3>
                <ul id="practiceList">
                    <li>None yet!</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    
    <script>
        const width = 1350;
        const height = 650;
        
        // Quiz state
        let quizActive = false;
        let currentQuestionContinent = '';
        let correctScore = 0;
        let incorrectScore = 0;
        let practiceList = new Set();
        const ALL_CONTINENTS = ['Africa', 'Europe', 'Asia', 'North America', 'South America', 'Oceania'];
        let availableQuizContinents = [];
        let masteryCount = {}; // Added for mastery feature

        const continentColors = {
            'Africa': '#FFD700', 'Europe': '#E0115F', 'Asia': '#FF5733',
            'North America': '#00A86B', 'South America': '#9ACD32', 'Oceania': '#FF8C00', 'Antarctica': '#f0f8ff'
        };
        const continentEmojis = {
            'Africa': 'ü¶Å', 'Europe': 'üè∞', 'Asia': 'üèØ', 'North America': 'ü¶Ö',
            'South America': 'ü¶ú', 'Oceania': 'ü¶ò', 'Antarctica': 'üêß'
        };
        
        const infoDiv = d3.select('#info');
        const correctScoreSpan = d3.select('#correctScore');
        const incorrectScoreSpan = d3.select('#incorrectScore');
        const quizButton = d3.select('#quizButton');
        const practiceListUl = d3.select('#practiceList');
        
        const projection = d3.geoNaturalEarth1().scale(220).translate([width / 2, height / 2]);
        const path = d3.geoPath().projection(projection);
        
        const svg = d3.select('#mapContainer').html('').append('svg').attr('width', width).attr('height', height);
        svg.append('path').datum({ type: 'Sphere' }).attr('class', 'ocean-background').attr('d', path);
        
        function newQuestion() {
            if (availableQuizContinents.length === 0) {
                 infoDiv.html(`üéâ You've mastered all the continents! üéâ`).attr('class', 'mastered');
                 quizActive = false;
                 quizButton.text('Play Again?');
                 return;
            }
            let nextContinent = availableQuizContinents[Math.floor(Math.random() * availableQuizContinents.length)];
            currentQuestionContinent = nextContinent;
            infoDiv.html(`Find <strong>${currentQuestionContinent}</strong>!`).attr('class', null);
        }

        function updatePracticeList() {
            practiceListUl.html('');
            if (practiceList.size === 0) {
                practiceListUl.append('li').text('None yet!');
            } else {
                practiceList.forEach(continent => {
                    practiceListUl.append('li').text(continent);
                });
            }
        }

        function startQuiz() {
            quizActive = true;
            correctScore = 0;
            incorrectScore = 0;
            practiceList.clear();
            availableQuizContinents = [...ALL_CONTINENTS]; // Reset the list of questions
            ALL_CONTINENTS.forEach(c => masteryCount[c] = 0); // Reset mastery counts

            correctScoreSpan.text(correctScore);
            incorrectScoreSpan.text(incorrectScore);
            updatePracticeList();
            quizButton.text('Restart Quiz');
            newQuestion();
        }

        quizButton.on('click', startQuiz);

        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(countriesData => {
            d3.select('#loading').remove();
            const countries = topojson.feature(countriesData, countriesData.objects.countries);
            const franceFeatureIndex = countries.features.findIndex(f => f.id === '250');
            if (franceFeatureIndex !== -1) {
                const originalFranceFeature = countries.features[franceFeatureIndex];
                const europeanPolygons = [], guianaPolygons = [];
                originalFranceFeature.geometry.coordinates.forEach(polygon => {
                    (polygon[0][0][0] < -20 ? guianaPolygons : europeanPolygons).push(polygon);
                });
                originalFranceFeature.geometry.coordinates = europeanPolygons;
                if (guianaPolygons.length > 0) {
                    countries.features.push({type: 'Feature', id: '999', properties: {name: 'French Guiana'}, geometry: {type: 'MultiPolygon', coordinates: guianaPolygons}});
                }
            }
            const continentMapping = {
                'Africa': [12, 24, 72, 108, 120, 132, 140, 148, 174, 175, 178, 180, 204, 231, 232, 262, 266, 270, 288, 324, 384, 404, 426, 430, 434, 450, 454, 466, 478, 480, 504, 508, 516, 562, 566, 624, 638, 646, 654, 678, 686, 690, 694, 706, 710, 716, 728, 729, 732, 748, 768, 788, 800, 818, 834, 854, 894], 'Antarctica': [10],
                'Asia': [4, 31, 48, 50, 51, 64, 96, 104, 116, 144, 156, 158, 196, 268, 275, 296, 344, 356, 360, 364, 368, 376, 392, 398, 400, 408, 410, 414, 417, 418, 422, 446, 458, 462, 496, 512, 524, 586, 608, 626, 634, 643, 682, 702, 704, 760, 762, 764, 784, 792, 795, 860, 887],
                'Europe': [8, 20, 40, 51, 56, 70, 100, 191, 196, 203, 208, 233, 234, 246, 248, 250, 276, 292, 300, 336, 348, 352, 372, 380, 428, 438, 440, 442, 470, 492, 498, 499, 528, 578, 616, 620, 642, 674, 688, 703, 705, 724, 744, 752, 756, 804, 807, 826, 831, 832, 833],
                'North America': [28, 44, 52, 60, 84, 92, 124, 136, 188, 192, 212, 214, 222, 304, 308, 312, 320, 328, 332, 388, 474, 484, 500, 530, 531, 533, 534, 535, 660, 662, 663, 666, 670, 740, 780, 796, 840, 850],
                'Oceania': [16, 36, 90, 162, 184, 242, 258, 296, 316, 520, 548, 554, 570, 574, 580, 583, 584, 585, 598, 612, 772, 776, 798, 876, 882],
                'South America': [32, 68, 76, 152, 170, 218, 238, 239, 254, 328, 600, 604, 740, 858, 862, 999]
            };
            const countryToContinent = {};
            for (const [continent, ids] of Object.entries(continentMapping)) {
                ids.forEach(id => countryToContinent[id] = continent);
            }
            const continentData = {};
            countries.features.forEach(feature => {
                const continent = countryToContinent[parseInt(feature.id)] || 'Unknown';
                if (continent !== 'Unknown') {
                    if (!continentData[continent]) continentData[continent] = [];
                    continentData[continent].push(feature);
                }
            });
            
            for (const [continent, features] of Object.entries(continentData)) {
                 const g = svg.append('g').attr('data-continent', continent);
                 g.selectAll('path').data(features).enter().append('path')
                    .attr('class', 'continent').attr('d', path).attr('fill', continentColors[continent] || '#999')
                    .on('mouseenter', function (event, d) {
                        if (!quizActive) {
                           const countryName = d.properties.name;
                           const color = continentColors[continent] || '#64748b';
                           const emoji = continentEmojis[continent] || 'üåç';
                           infoDiv.html(`${emoji} Hovering over <strong style="color: ${color};">${countryName}</strong>`);
                        }
                    })
                    .on('mouseleave', function() {
                        if (!quizActive) infoDiv.html('Click the button to start the quiz!');
                    })
                    .on('click', function() {
                        if (quizActive) {
                            if (continent === currentQuestionContinent) {
                                correctScore++;
                                correctScoreSpan.text(correctScore);
                                masteryCount[currentQuestionContinent]++; // Increment mastery count
                                
                                // Check for mastery
                                if (masteryCount[currentQuestionContinent] >= 3) {
                                    infoDiv.html(`‚≠ê You've mastered <strong>${currentQuestionContinent}</strong>! I think you've got it!`).attr('class', 'mastered');
                                    availableQuizContinents = availableQuizContinents.filter(c => c !== currentQuestionContinent);
                                    setTimeout(newQuestion, 2000);
                                } else {
                                    infoDiv.html(`‚úÖ Correct! Well done.`).attr('class', 'correct');
                                    setTimeout(newQuestion, 1000);
                                }
                            } else {
                                incorrectScore++;
                                incorrectScoreSpan.text(incorrectScore);
                                practiceList.add(currentQuestionContinent);
                                updatePracticeList();
                                infoDiv.html(`‚ùå Incorrect. That was ${continent}. Try again!`).attr('class', 'incorrect');
                            }
                        }
                    });
            }
        }).catch(error => {
            d3.select('#loading').html('‚ùå Error loading map data. Please refresh.');
            console.error('Error loading map:', error);
        });
    </script>
</body>
</html>




