<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Word Checker</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for the word bank badges */
        .word-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            margin: 4px;
            border-radius: 9999px; /* pill shape */
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            white-space: nowrap;
        }

        /* Styling for the feedback on answer buttons */
        .correct-answer {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
        }

        .incorrect-answer {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            opacity: 0.7;
        }
        
        .disabled-option {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen p-4 md:p-8">

    <!-- Main content container -->
    <main class="w-full max-w-3xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white text-center mb-4 md:mb-6 text-shadow-lg">Spanish Word Checker</h1>

        <!-- Game Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8" id="game-container">
            
            <!-- Spanish Word Display -->
            <div class="text-center">
                <p class="text-lg text-gray-500 font-medium">What is the meaning of:</p>
                <h2 id="spanish-word" class="text-5xl md:text-6xl font-bold text-indigo-700 my-3 capitalize-first">
                    ...
                </h2>
                <!-- min-h-[1.5em] prevents layout shift when text appears -->
                <div id="feedback-message" class="mt-3 text-xl font-semibold min-h-[1.5em]"></div>
            </div>

            <!-- Options Grid -->
            <div id="options-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mt-6">
                <!-- Option buttons will be generated by JavaScript -->
            </div>

            <!-- Next Word Button has been removed for auto-advance -->
        </div>

        <!-- Word Banks -->
        <div class="flex flex-col md:flex-row gap-6 mt-6" id="banks-container">
            
            <!-- Known Words -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6 w-full">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-2xl font-bold text-green-700">Known Words</h3>
                    <span id="known-words-count" class="text-lg font-semibold text-gray-600 bg-gray-200 px-3 py-1 rounded-full">0 / 0</span>
                </div>
                <div id="known-words-list" class="flex flex-wrap gap-2 h-32 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                    <!-- Badges will be generated here -->
                </div>
                <button id="copy-known-btn" class="mt-4 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 active:scale-95 transition-all">
                    Copy List
                </button>
            </div>

            <!-- Practice Bank -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6 w-full">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-2xl font-bold text-red-700">Practice Bank</h3>
                    <span id="practice-words-count" class="text-lg font-semibold text-gray-600 bg-gray-200 px-3 py-1 rounded-full">0</span>
                </div>
                <div id="practice-words-list" class="flex flex-wrap gap-2 h-32 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                    <!-- Badges will be generated here -->
                </div>
                <button id="copy-practice-btn" class="mt-4 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 active:scale-95 transition-all">
                    Copy List
                </button>
            </div>
        </div>
    </main>

    <!-- Hidden text area for clipboard functionality -->
    <textarea id="copy-buffer" class="absolute" style="left: -9999px; top: 0;"></textarea>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        // These variables are provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-spanish-checker';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // setLogLevel('Debug'); // Uncomment for detailed logs

        let userId = null;
        let progressDocRef = null;

        // --- 1. DATA: Master Word List ---
        // List will be loaded from the external JSON file.
        let masterWordList = [];

        // --- 2. STATE VARIABLES ---
        let availableWords = [];
        let allEnglishWords = [];
        let knownWords = [];
        let practiceWords = [];
        let currentWord = null;
        let isAnswered = false;

        // --- 3. DOM ELEMENTS ---
        const spanishWordEl = document.getElementById('spanish-word');
        const optionsGridEl = document.getElementById('options-grid');
        const feedbackEl = document.getElementById('feedback-message');
        const knownListEl = document.getElementById('known-words-list');
        const practiceListEl = document.getElementById('practice-words-list');
        const knownCountEl = document.getElementById('known-words-count');
        const practiceCountEl = document.getElementById('practice-words-count');
        const copyKnownBtn = document.getElementById('copy-known-btn');
        const copyPracticeBtn = document.getElementById('copy-practice-btn');
        const copyBuffer = document.getElementById('copy-buffer');

        // --- 4. CORE FUNCTIONS ---

        /**
         * Shuffles an array in place (Fisher-Yates algorithm)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Loads the next word, generates options, and updates the UI
         */
        function loadNextWord() {
            // Reset state
            isAnswered = false;
            feedbackEl.textContent = '';
            // Reset feedback class, remove color and ensure min-height
            feedbackEl.className = 'mt-3 text-xl font-semibold min-h-[1.5em]';

            // Check if we need to reset the word list
            if (availableWords.length === 0) {
                if (masterWordList.length === 0) {
                    spanishWordEl.textContent = 'Error: No words loaded.';
                    return; // Stop if master list is empty
                }
                availableWords = [...masterWordList];
                // Optional: Show a message
                feedbackEl.textContent = "All words seen! Resetting list...";
            }

            // Shuffle available words and get the next one
            shuffleArray(availableWords);
            currentWord = availableWords.pop();

            // Generate 5 incorrect "decoy" answers
            const correctAnswer = currentWord.english;
            const decoys = new Set();
            while (decoys.size < 5) {
                const randomDecoy = allEnglishWords[Math.floor(Math.random() * allEnglishWords.length)];
                if (randomDecoy !== correctAnswer) {
                    decoys.add(randomDecoy);
                }
            }

            // Create and shuffle the 6 options
            const options = [correctAnswer, ...decoys];
            shuffleArray(options);

            // Render the options
            optionsGridEl.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full text-left p-4 rounded-lg shadow-md bg-gray-100 hover:bg-indigo-100 active:scale-95 transition-all duration-150 ease-in-out font-medium text-gray-800 text-lg';
                
                // Store the answer on the button itself
                button.dataset.answer = option;
                optionsGridEl.appendChild(button);
            });

            // Update the Spanish word display
            spanishWordEl.textContent = currentWord.spanish;
        }

        /**
         * Checks the user's selected answer
         */
        function checkAnswer(selectedOption) {
            if (isAnswered) return; // Prevent multiple clicks
            isAnswered = true;

            const isCorrect = selectedOption === currentWord.english;
            const buttons = optionsGridEl.querySelectorAll('button');

            buttons.forEach(button => {
                const answer = button.dataset.answer;
                if (answer === currentWord.english) {
                    // This is the correct answer
                    button.className = button.className.replace('bg-gray-100 hover:bg-indigo-100', '');
                    button.classList.add('correct-answer');
                } else if (answer === selectedOption) {
                    // This is the incorrect one the user clicked
                    button.className = button.className.replace('bg-gray-100 hover:bg-indigo-100', '');
                    button.classList.add('incorrect-answer');
                } else {
                    // This is a wrong, unclicked option
                    button.classList.add('disabled-option');
                }
                button.disabled = true; // Disable all buttons
            });

            if (isCorrect) {
                feedbackEl.textContent = 'Â¡Correcto!';
                feedbackEl.classList.add('text-green-600');
                
                // Add to Known Words
                if (!knownWords.some(w => w.spanish === currentWord.spanish)) {
                    knownWords.push(currentWord);
                }
                // Remove from Practice Bank if it was there
                practiceWords = practiceWords.filter(w => w.spanish !== currentWord.spanish);
            
            } else {
                feedbackEl.textContent = `No, es: ${currentWord.english}`;
                feedbackEl.classList.add('text-red-600');
                
                // Add to Practice Bank
                if (!practiceWords.some(w => w.spanish === currentWord.spanish)) {
                    practiceWords.push(currentWord);
                }
            }

            // Update banks UI
            updateBanksUI();

            // --- NEW: Save progress to Firestore ---
            saveProgress();

            // Automatically load the next word after a short delay
            setTimeout(loadNextWord, 1200);
        }

        /**
         * Updates the "Known Words" and "Practice Bank" lists
         */
        function updateBanksUI() {
            // Update Known Words
            knownListEl.innerHTML = '';
            knownWords.sort((a, b) => a.spanish.localeCompare(b.spanish)); // Sort alphabetically
            knownWords.forEach(word => {
                const badge = document.createElement('span');
                badge.className = 'word-badge bg-green-100 text-green-800';
                badge.textContent = `${word.spanish} / ${word.english}`;
                knownListEl.appendChild(badge);
            });
            // Update count (only if master list has loaded)
            if (masterWordList.length > 0) {
                knownCountEl.textContent = `${knownWords.length} / ${masterWordList.length}`;
            }

            // Update Practice Bank
            practiceListEl.innerHTML = '';
            practiceWords.sort((a, b) => a.spanish.localeCompare(b.spanish)); // Sort alphabetically
            practiceWords.forEach(word => {
                const badge = document.createElement('span');
                badge.className = 'word-badge bg-red-100 text-red-800';
                badge.textContent = `${word.spanish} / ${word.english}`;
                practiceListEl.appendChild(badge);
            });
            practiceCountEl.textContent = practiceWords.length; // Update count
        }

        /**
         * Copies the text from a word bank to the clipboard
         */
        function copyBank(bankType, button) {
            const list = (bankType === 'known') ? knownWords : practiceWords;
            if (list.length === 0) return;

            // Format text as "Spanish: English"
            const textToCopy = list
                .map(word => `${word.spanish}: ${word.english}`)
                .join('\n');
            
            // Use the hidden textarea for reliable copying
            copyBuffer.value = textToCopy;
            copyBuffer.select();
            copyBuffer.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                // Visual feedback
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.disabled = true;
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 1500);
            } catch (err) {
                console.error('Failed to copy: ', err);
                // You could show an error message to the user here
            }
        }

        // --- 5. EVENT LISTENERS ---
        
        // Handle clicks on the option buttons (uses event delegation)
        optionsGridEl.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                checkAnswer(e.target.dataset.answer);
            }
        });

        // Copy buttons
        copyKnownBtn.addEventListener('click', () => copyBank('known', copyKnownBtn));
        copyPracticeBtn.addEventListener('click', () => copyBank('practice', copyPracticeBtn));

        // --- 6. NEW FIRESTORE FUNCTIONS ---

        /**
         * Saves the current knownWords and practiceWords to Firestore.
         */
        async function saveProgress() {
            if (!progressDocRef) {
                console.warn("Firestore not ready, skipping save.");
                return; 
            }

            try {
                const progressData = {
                    knownWords: knownWords,
                    practiceWords: practiceWords
                };
                // Use setDoc to save the entire progress object
                await setDoc(progressDocRef, progressData); 
                console.log("Progress saved.");
            } catch (error) {
                console.error("Error saving progress: ", error);
            }
        }

        /**
         * Loads progress from Firestore.
         */
        async function loadProgress() {
            if (!progressDocRef) return;

            try {
                const docSnap = await getDoc(progressDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    knownWords = data.knownWords || [];
                    practiceWords = data.practiceWords || [];
                    console.log("Progress loaded:", data);
                } else {
                    console.log("No previous progress found.");
                    // Initialize with empty arrays if no doc exists
                    knownWords = [];
                    practiceWords = [];
                }
            } catch (error) {
                console.error("Error loading progress: ", error);
                knownWords = [];
                practiceWords = [];
            }
        }

        // --- 7. INITIALIZE GAME (Modified) ---
        
        /**
         * Authenticates, loads progress, fetches words, and starts the game.
         */
        async function initializeGame() {
            try {
                // --- NEW: Authenticate with Firebase ---
                console.log("Authenticating...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid;

                if (!userId) {
                    throw new Error("Authentication failed, user ID not found.");
                }
                console.log("Authenticated with user ID:", userId);

                // Set up the Firestore document reference (private to the user)
                progressDocRef = doc(db, 'artifacts', appId, 'users', userId, 'spanishChecker', 'progress');
                // --- END NEW ---

                // --- NEW: Load progress from Firestore ---
                console.log("Loading progress...");
                await loadProgress();
                // Update UI immediately with loaded data
                updateBanksUI(); 
                // --- END NEW ---

                // This is the raw URL for the file you linked, with cache-busting.
                const wordListUrl = 'https://raw.githubusercontent.com/Maltais239/interactives/main/spanish_words_1000.json?v=' + new Date().getTime();
            
                // Show loading state
                spanishWordEl.textContent = 'Loading...';
                
                const response = await fetch(wordListUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                masterWordList = await response.json();
                
                if (!masterWordList || masterWordList.length === 0) {
                    throw new Error('Word list is empty or invalid.');
                }
                console.log(`Loaded ${masterWordList.length} words from JSON.`);

                // Initialize state variables that depend on the list
                availableWords = [...masterWordList];
                allEnglishWords = masterWordList.map(w => w.english);

                // Start the game
                loadNextWord();
                
                // Set/Update counts now that master list is loaded
                updateBanksUI();


            } catch (error) {
                console.error('Failed to initialize game:', error);
                // Show error state to the user
                spanishWordEl.textContent = 'Failed to load words.';
                feedbackEl.textContent = 'Please check the file URL and try refreshing.';
                feedbackEl.classList.add('text-red-600');
                optionsGridEl.innerHTML = ''; // Clear options
            }
        }
        
        window.onload = initializeGame;

    </script>
</body>
</html>
