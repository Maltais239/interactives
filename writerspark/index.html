<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacGregor Maltais Magic Writer Spark 2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Indie+Flower&family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, hsla(253,16%,7%,0) 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0.1) 0, hsla(225,39%,30%,0) 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0.1) 0, hsla(339,49%,30%,0) 50%);
        }
        
        h1, h2, h3, h4, h5, h6, .font-heading {
            font-family: 'Outfit', sans-serif;
        }

        .handwritten {
            font-family: 'Indie Flower', cursive;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .drag-target-active {
            border-color: #6366f1 !important;
            background-color: #eef2ff !important;
            transform: scale(1.01);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, memo } = React;

        // Icons
        const Icon = ({ name, color = "currentColor", size = 24, className="" }) => {
            const icons = {
                sparkles: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 9h4"/></svg>,
                book: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
                arrowRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
                brain: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
                pencil: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
                plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
                chevronRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
                chevronDown: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>,
                refresh: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
                check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
                grip: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
                copy: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
                download: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
                camera: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
                save: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
                user: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                map: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                tag: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>
            };
            return icons[name] || null;
        };

        // --- Helper: Save as Image ---
        const saveAsImage = async (elementId, title) => {
            const element = document.getElementById(elementId);
            if(!element) return;
            try {
                const canvas = await window.html2canvas(element, { 
                    scale: 2, // Better resolution
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });
                
                const link = document.createElement('a');
                link.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("Image capture failed:", err);
                alert("Couldn't save image. Please try again.");
            }
        };

        // --- Data ---
        const prompts = [
            "Imagine one day you find a magical sled. Write a story about your adventure.",
            "There is an abandoned house on your street, many say it is haunted. You decide to go in and explore it.",
            "You are camping in the wilderness in a tent. You hear a strange noise and go to investigate.",
            "You are walking through your school and discover a door you have never seen before. You decide to go through it.",
            "There is a knock at your door. You open the door to find yourself face to face with an unexpected visitor.",
            "There are many things in life that can be frightening. Think of a time when you were really frightened.",
            "You are hiking in the mountains and something goes terribly wrong.",
            "You find an old map tucked inside a library book. It leads to somewhere in your town.",
            "You wake up one morning and realize you can talk to animals. What is the first conversation you have?",
            "You invent a robot to do your chores, but it starts doing them all wrong in a funny way.",
            "A spaceship lands in your backyard, but the alien just wants to borrow a cup of sugar.",
            "You find a pair of glasses that let you see five minutes into the future.",
            "The statues in the park come to life at night, but they are actually very shy.",
            "You eat a fortune cookie that says 'Look behind you.' What happens next?",
            "Your dog starts speaking to you, but only in riddles.",
            "You are a detective solving the mystery of the missing school bell.",
            "You get trapped inside your favorite video game. How do you win your way out?",
            "One day, gravity stops working for exactly one hour.",
            "You discover a secret room behind the school cafeteria that leads to a magical forest.",
            "You buy a plant that grows candy instead of leaves.",
            "You switch bodies with your teacher for a day.",
            "You find a key that can open any door in the world. Where do you go first?",
            "A dragon lands on your roof because it has a toothache and needs help.",
            "You invent a new color that no one has ever seen before.",
            "It starts raining something other than water (marshmallows? coins? frogs?).",
            "You are the captain of a pirate ship, but your crew is made of cats.",
            "You wake up with a superpower, but it's a really silly one.",
            "You find a message in a bottle on the beach, but it's dated from the year 3000.",
            "Your reflection in the mirror starts moving on its own.",
            "You are a chef cooking a meal for a giant."
        ];

        const storyBlocks = [
            { id: 1, title: "Entertaining Beginning", hint: "Who is in your story? Where? When? Start strong! (2-3 sentences)" },
            { id: 2, title: "Introduce the Problem", hint: "What goes missing? What goes wrong? The 'Da da daaaa' moment. (2-3 sentences)" },
            { id: 3, title: "Magic of 3 (1 of 3)", hint: "First try to solve the problem. Who helps? Small feelings." },
            { id: 4, title: "Magic of 3 (2 of 3)", hint: "Second try to solve the problem. Who helps? Medium feelings." },
            { id: 5, title: "Magic of 3 (3 of 3)", hint: "Third try. How do you feel now? BIG feelings!" },
            { id: 6, title: "Main Event", hint: "S-L-O-W M-O-T-I-O-N. The climax! Tell it in detail." },
            { id: 7, title: "Ending", hint: "Wrap it up and celebrate. What happens next?" },
            { id: 8, title: "Extended Ending", hint: "Your character reflects on the experience. What did they learn?" }
        ];

        // --- Components ---

        const MindWeb = ({ ideas, setIdeas, onOrganize }) => {
            const [newIdea, setNewIdea] = useState("");
            const containerRef = useRef(null);
            const [draggingId, setDraggingId] = useState(null);
            const dragOffset = useRef({ x: 0, y: 0 });

            const addIdea = () => {
                if (newIdea.trim()) {
                    const angle = Math.random() * Math.PI * 2;
                    const minRadius = 30; 
                    const maxRadius = 45; 
                    const radius = minRadius + Math.random() * (maxRadius - minRadius);
                    
                    const x = 50 + radius * Math.cos(angle);
                    const y = 50 + radius * Math.sin(angle);

                    setIdeas([...ideas, { 
                        id: Date.now(), 
                        text: newIdea, 
                        x: x, 
                        y: y,
                        rotate: Math.random() * 6 - 3,
                        color: ['bg-yellow-100', 'bg-blue-100', 'bg-green-100', 'bg-pink-100'][Math.floor(Math.random() * 4)]
                    }]);
                    setNewIdea("");
                }
            };

            const removeIdea = (id) => {
                setIdeas(ideas.filter(idea => idea.id !== id));
            };

            // Dragging Logic
            const handleMouseDown = (e, id) => {
                e.stopPropagation();
                e.preventDefault(); 
                
                const item = ideas.find(i => i.id === id);
                if(!item || !containerRef.current) return;

                const containerRect = containerRef.current.getBoundingClientRect();
                
                const mouseXPercent = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                const mouseYPercent = ((e.clientY - containerRect.top) / containerRect.height) * 100;

                setDraggingId(id);
                dragOffset.current = {
                    x: mouseXPercent - item.x,
                    y: mouseYPercent - item.y
                };
            };

            const handleMouseMove = (e) => {
                if (!draggingId || !containerRef.current) return;
                e.preventDefault();

                const containerRect = containerRef.current.getBoundingClientRect();
                
                let newX = ((e.clientX - containerRect.left) / containerRect.width) * 100 - dragOffset.current.x;
                let newY = ((e.clientY - containerRect.top) / containerRect.height) * 100 - dragOffset.current.y;

                newX = Math.max(2, Math.min(90, newX)); 
                newY = Math.max(2, Math.min(90, newY));

                setIdeas(ideas.map(idea => 
                    idea.id === draggingId ? { ...idea, x: newX, y: newY } : idea
                ));
            };

            const handleMouseUp = () => {
                setDraggingId(null);
            };

            const handleSnapshot = () => {
                saveAsImage("mind-web-capture", "My_Mind_Web");
            };

            return (
                <div className="w-full h-full flex flex-col relative">
                    <div className="flex flex-col sm:flex-row gap-3 mb-6">
                        <input 
                            type="text" 
                            className="flex-1 px-5 py-3 border-2 border-slate-200 rounded-full focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all shadow-sm text-base"
                            placeholder="Add an idea to your web..."
                            value={newIdea}
                            onChange={(e) => setNewIdea(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && addIdea()}
                        />
                        <button onClick={addIdea} className="bg-indigo-600 text-white p-3 px-5 rounded-full hover:bg-indigo-700 transition shadow-md flex items-center justify-center gap-2 font-bold whitespace-nowrap">
                            <Icon name="plus" size={20} /> <span className="sm:hidden md:inline">Add</span>
                        </button>
                    </div>

                    <div id="mind-web-capture" className="relative p-2 rounded-3xl bg-white flex-1 min-h-0">
                        <div 
                            ref={containerRef}
                            className="relative w-full h-[50vh] min-h-[400px] bg-slate-50 border border-slate-200 rounded-2xl overflow-hidden mb-4 select-none touch-none"
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseUp}
                        >
                            <div className="absolute inset-0 opacity-10 pointer-events-none" style={{
                                backgroundImage: 'radial-gradient(#4f46e5 1px, transparent 1px)',
                                backgroundSize: '24px 24px'
                            }}></div>

                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none">
                                <div className="bg-white border-4 border-indigo-100 p-6 md:p-8 rounded-full shadow-2xl flex items-center justify-center w-32 h-32 md:w-48 md:h-48 animate-float">
                                    <div className="text-center">
                                        <span className="block text-2xl md:text-4xl mb-2">ðŸ§ </span>
                                        <span className="font-heading font-bold text-indigo-900 text-base md:text-xl">Main Idea</span>
                                    </div>
                                </div>
                            </div>

                            {ideas.map((idea, index) => (
                                <div 
                                    key={idea.id}
                                    onMouseDown={(e) => handleMouseDown(e, idea.id)}
                                    className={`absolute ${idea.color} p-3 md:p-4 rounded-lg shadow-md border border-black/5 max-w-[140px] md:max-w-[180px] cursor-move transition-transform ${draggingId === idea.id ? 'z-50 scale-105 shadow-xl' : 'hover:scale-110 hover:z-20'}`}
                                    style={{ 
                                        top: `${idea.y}%`, 
                                        left: `${idea.x}%`,
                                        transform: `rotate(${idea.rotate}deg)`
                                    }}
                                >
                                    <div className="handwritten text-base md:text-xl leading-tight text-slate-800 pointer-events-none">{idea.text}</div>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); removeIdea(idea.id); }}
                                        className="absolute -top-2 -right-2 bg-white text-rose-500 rounded-full p-1 shadow-sm hover:bg-rose-50 border border-rose-100 cursor-pointer"
                                    >
                                        <Icon name="plus" size={12} className="rotate-45" />
                                    </button>
                                </div>
                            ))}
                            
                            {ideas.length === 0 && (
                                <div className="absolute bottom-4 left-0 right-0 text-center text-slate-400 text-xs md:text-sm pointer-events-none px-4">
                                    Start adding ideas to populate your web!
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Action Bar */}
                    <div className="flex flex-col sm:flex-row justify-between items-center mt-2 gap-3">
                        <button 
                            onClick={handleSnapshot}
                            className="w-full sm:w-auto bg-white text-slate-600 font-bold py-3 px-6 rounded-2xl shadow-sm border border-slate-200 hover:bg-slate-50 hover:text-indigo-600 transition-all flex items-center justify-center gap-2"
                            title="Save as Image"
                        >
                            <Icon name="camera" size={20} /> <span>Save Image</span>
                        </button>

                        {ideas.length > 0 && (
                            <div className="w-full sm:w-auto animate-bounce-subtle">
                                <button 
                                    onClick={onOrganize}
                                    className="w-full sm:w-auto bg-amber-400 text-amber-950 font-bold py-3 px-8 rounded-2xl shadow-lg hover:bg-amber-300 hover:shadow-amber-200/50 transition-all flex items-center justify-center gap-2 text-lg transform hover:-translate-y-1"
                                >
                                    <Icon name="check" size={24} /> Save & Organize
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Fluid Note Component for Characters/Settings ---
        const FluidCard = ({ item, onRemove, onUpdateDetails }) => {
            const [newDetail, setNewDetail] = useState("");
            
            // Generate random styles for new details
            const getRandomStyle = () => {
                const rotate = Math.random() * 6 - 3;
                const colors = ['bg-yellow-100', 'bg-blue-100', 'bg-green-100', 'bg-pink-100', 'bg-orange-100', 'bg-purple-100'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                return { rotate, color };
            };

            const addDetail = () => {
                if (!newDetail.trim()) return;
                const style = getRandomStyle();
                const detail = {
                    id: Date.now(),
                    text: newDetail,
                    ...style
                };
                // Ensure item.details exists before spreading
                const currentDetails = item.details || [];
                onUpdateDetails(item.id, [...currentDetails, detail]);
                setNewDetail("");
            };

            const removeDetail = (detailId) => {
                const currentDetails = item.details || [];
                onUpdateDetails(item.id, currentDetails.filter(d => d.id !== detailId));
            };

            return (
                <div className="bg-white border-2 border-slate-100 rounded-3xl p-4 md:p-6 shadow-sm hover:shadow-md transition relative group">
                    <button 
                        onClick={() => onRemove(item.id)}
                        className="absolute top-4 right-4 text-slate-300 hover:text-rose-500 transition p-1"
                    >
                        <Icon name="trash" size={20} />
                    </button>
                    
                    <div className="flex items-center gap-3 mb-6 pr-8">
                        <div className={`p-3 rounded-2xl ${item.type === 'character' ? 'bg-orange-100 text-orange-600' : 'bg-teal-100 text-teal-600'}`}>
                            <Icon name={item.type === 'character' ? "user" : "map"} size={24} />
                        </div>
                        <div className="overflow-hidden">
                            <h4 className="font-heading font-bold text-xl md:text-2xl text-slate-800 leading-none truncate">{item.name}</h4>
                            <span className={`text-xs font-bold uppercase tracking-wide ${item.type === 'character' ? 'text-orange-500' : 'text-teal-500'}`}>
                                {item.role || "Setting"}
                            </span>
                        </div>
                    </div>

                    <div className="mb-4">
                        <input 
                            className="w-full bg-slate-50 border-b-2 border-slate-200 p-3 rounded-t-lg focus:border-indigo-500 focus:bg-white outline-none transition-colors text-base"
                            placeholder={item.type === 'character' ? "Pop a trait or detail here..." : "Pop a sensory detail here..."}
                            value={newDetail}
                            onChange={(e) => setNewDetail(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && addDetail()}
                        />
                    </div>

                    <div className="min-h-[150px] bg-slate-50/50 rounded-xl p-4 border border-slate-100 relative overflow-hidden">
                        <div className="absolute inset-0 opacity-5" style={{ backgroundImage: 'radial-gradient(#64748b 1px, transparent 1px)', backgroundSize: '16px 16px' }}></div>
                        
                        <div className="relative flex flex-wrap gap-3 content-start">
                            {(item.details || []).length === 0 && (
                                <div className="w-full text-center text-slate-400 text-sm py-8 italic pointer-events-none">
                                    Type above and press Enter to add ideas!
                                </div>
                            )}
                            {(item.details || []).map(detail => (
                                <div 
                                    key={detail.id}
                                    className={`${detail.color} px-4 py-2 rounded-lg shadow-sm border border-black/5 transform transition hover:scale-105 hover:z-10 group/note relative cursor-default`}
                                    style={{ transform: `rotate(${detail.rotate}deg)` }}
                                >
                                    <span className="handwritten text-lg text-slate-800">{detail.text}</span>
                                    <button 
                                        onClick={() => removeDetail(detail.id)}
                                        className="absolute -top-2 -right-2 bg-white text-rose-500 rounded-full p-0.5 shadow-sm opacity-0 group-hover/note:opacity-100 transition-opacity border border-rose-100"
                                    >
                                        <Icon name="plus" size={10} className="rotate-45" />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Character Builder (Refactored) ---
        const CharacterBuilder = ({ characters, setCharacters }) => {
            const [newName, setNewName] = useState("");
            const [newRole, setNewRole] = useState("Hero");

            const addCharacter = () => {
                if (!newName.trim()) return;
                const newChar = {
                    id: Date.now(),
                    type: 'character',
                    name: newName,
                    role: newRole,
                    details: [] // Array for fluid notes
                };
                setCharacters([...characters, newChar]);
                setNewName("");
                setNewRole("Hero");
            };

            const removeCharacter = (id) => {
                setCharacters(characters.filter(c => c.id !== id));
            };

            const updateCharacterDetails = (id, newDetails) => {
                setCharacters(characters.map(c => c.id === id ? { ...c, details: newDetails } : c));
            };

             const handleSnapshot = () => {
                saveAsImage("character-capture", "My_Characters");
            };

            return (
                <div className="space-y-8 max-w-4xl mx-auto">
                     <div className="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6">
                        <div className="text-left">
                            <h3 className="text-2xl font-heading font-bold text-slate-800">Character Cast</h3>
                            <p className="text-slate-500 text-sm">Create characters and pop ideas onto them.</p>
                        </div>
                         <button 
                            onClick={handleSnapshot}
                            className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 font-semibold shadow-sm transition-all"
                            title="Save as Image"
                        >
                            <Icon name="camera" size={18} /> <span className="hidden sm:inline">Image</span>
                        </button>
                    </div>

                    {/* Add Form */}
                    <div className="bg-orange-50/50 p-4 rounded-2xl border border-orange-100 shadow-sm flex flex-col md:flex-row gap-3 items-end">
                        <div className="flex-1 w-full">
                            <label className="block text-xs font-bold uppercase text-orange-500 mb-1">Name</label>
                            <input 
                                className="w-full p-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-100 outline-none" 
                                placeholder="Character Name"
                                value={newName}
                                onChange={e => setNewName(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && addCharacter()}
                            />
                        </div>
                        <div className="w-full md:w-48">
                            <label className="block text-xs font-bold uppercase text-orange-500 mb-1">Role</label>
                            <select 
                                className="w-full p-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-100 outline-none bg-white"
                                value={newRole}
                                onChange={e => setNewRole(e.target.value)}
                            >
                                <option>Hero / Protagonist</option>
                                <option>Villain / Antagonist</option>
                                <option>Sidekick</option>
                                <option>Mentor</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <button 
                            onClick={addCharacter}
                            className="bg-orange-500 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-orange-600 transition w-full md:w-auto shadow-md shadow-orange-500/20"
                        >
                            Create
                        </button>
                    </div>

                    {/* Character List */}
                    <div id="character-capture" className="grid grid-cols-1 md:grid-cols-2 gap-6 p-2">
                        {characters.length === 0 && <p className="text-slate-400 text-center col-span-full py-8">No characters yet. Create one above!</p>}
                        {characters.map(char => (
                            <FluidCard 
                                key={char.id} 
                                item={char} 
                                onRemove={removeCharacter} 
                                onUpdateDetails={updateCharacterDetails} 
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // --- Setting Builder (Refactored) ---
        const SettingBuilder = ({ settings, setSettings }) => {
            const [newName, setNewName] = useState("");

            const addSetting = () => {
                if (!newName.trim()) return;
                const newSetting = {
                    id: Date.now(),
                    type: 'setting',
                    name: newName,
                    details: [] // Array for fluid notes
                };
                setSettings([...settings, newSetting]);
                setNewName("");
            };

            const removeSetting = (id) => {
                setSettings(settings.filter(s => s.id !== id));
            };

            const updateSettingDetails = (id, newDetails) => {
                setSettings(settings.map(s => s.id === id ? { ...s, details: newDetails } : s));
            };

            const handleSnapshot = () => {
                saveAsImage("setting-capture", "My_Settings");
            };

            return (
                <div className="space-y-8 max-w-4xl mx-auto">
                    <div className="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6">
                        <div className="text-left">
                            <h3 className="text-2xl font-heading font-bold text-slate-800">World Building</h3>
                            <p className="text-slate-500 text-sm">Create settings and pop sensory details onto them.</p>
                        </div>
                        <button 
                            onClick={handleSnapshot}
                            className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 font-semibold shadow-sm transition-all"
                            title="Save as Image"
                        >
                            <Icon name="camera" size={18} /> <span className="hidden sm:inline">Image</span>
                        </button>
                    </div>

                    {/* Add Form */}
                    <div className="bg-teal-50/50 p-4 rounded-2xl border border-teal-100 shadow-sm flex flex-col md:flex-row gap-3 items-end">
                        <div className="flex-1 w-full">
                            <label className="block text-xs font-bold uppercase text-teal-600 mb-1">Setting Name</label>
                            <input 
                                className="w-full p-2.5 rounded-xl border border-slate-200 focus:border-teal-500 focus:ring-2 focus:ring-teal-100 outline-none" 
                                placeholder="e.g., The Haunted Forest"
                                value={newName}
                                onChange={e => setNewName(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && addSetting()}
                            />
                        </div>
                        <button 
                            onClick={addSetting}
                            className="bg-teal-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-teal-700 transition w-full md:w-auto shadow-md shadow-teal-600/20"
                        >
                            Create
                        </button>
                    </div>

                    {/* Settings List */}
                    <div id="setting-capture" className="grid grid-cols-1 md:grid-cols-2 gap-6 p-2">
                         {settings.length === 0 && <p className="text-slate-400 text-center col-span-full py-8">No settings created yet.</p>}
                         {settings.map(setting => (
                            <FluidCard 
                                key={setting.id} 
                                item={setting} 
                                onRemove={removeSetting} 
                                onUpdateDetails={updateSettingDetails} 
                            />
                         ))}
                    </div>
                </div>
            );
        };

        // Optimized Block Component with Accordion Logic
        const StoryBlock = memo(({ block, index, onUpdate, onDragOver, onDragLeave, onDrop, isDragOver, total }) => {
            const [isExpanded, setIsExpanded] = useState(false);

            // Auto-expand if something is dragged over this specific block
            useEffect(() => {
                if (isDragOver) setIsExpanded(true);
            }, [isDragOver]);

            // Auto-expand if it has content initially or whenever content changes significantly? 
            // For now, let's stick to user controlled or drag controlled to save real estate.

            return (
                <div className="group relative pl-0 md:pl-8">
                    {index !== total - 1 && (
                        <div className="hidden md:block absolute left-[15px] top-10 bottom-[-40px] w-0.5 bg-slate-200 group-hover:bg-indigo-200 transition-colors"></div>
                    )}
                    
                    <div className="hidden md:flex absolute left-0 top-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold items-center justify-center border-2 border-white shadow-sm z-10 group-hover:scale-110 transition-transform">
                        {index + 1}
                    </div>

                    <div 
                        className={`bg-white rounded-xl shadow-sm border overflow-hidden hover:shadow-md transition-all mb-4 ${isDragOver ? 'drag-target-active border-indigo-400 ring-2 ring-indigo-100' : 'border-slate-100'}`}
                        onDragOver={(e) => onDragOver(e, block.id)}
                        onDragLeave={onDragLeave}
                        onDrop={(e) => onDrop(e, block.id)}
                    >
                        <div 
                            onClick={() => setIsExpanded(!isExpanded)}
                            className="bg-slate-50/50 p-3 md:p-4 border-b border-slate-100 flex flex-row justify-between items-center gap-2 cursor-pointer select-none hover:bg-slate-100 transition-colors"
                        >
                            <div className="flex items-center gap-2 flex-1">
                                <span className="md:hidden w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 font-bold flex items-center justify-center text-xs border border-indigo-200">{index + 1}</span>
                                <div>
                                    <h4 className="font-heading font-bold text-slate-800 text-base md:text-lg">{block.title}</h4>
                                    <p className="text-xs md:text-sm text-slate-500">{block.hint}</p>
                                </div>
                            </div>
                            <div className={`text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                                <Icon name="chevronDown" size={20} />
                            </div>
                        </div>
                        
                        {isExpanded && (
                            <div className="p-1 animate-fadeIn">
                                <textarea 
                                    className="w-full min-h-[120px] p-4 bg-white block w-full border-0 focus:ring-0 resize-y handwritten text-lg md:text-xl text-slate-700 placeholder-slate-300"
                                    placeholder="Start writing or drop an idea here..."
                                    value={block.content || ''}
                                    onChange={(e) => onUpdate(block.id, e.target.value)}
                                    autoFocus
                                />
                            </div>
                        )}
                    </div>
                </div>
            );
        });

        // StoryBuilder component start
        const StoryBuilder = ({ blocks, setBlocks, ideas, characters, settings }) => {
            const [draggedIdea, setDraggedIdea] = useState(null);
            const [dragOverBlock, setDragOverBlock] = useState(null);
            const [notification, setNotification] = useState(null);

            const handleUpdateBlock = useCallback((id, text) => {
                setBlocks(prevBlocks => prevBlocks.map(b => b.id === id ? { ...b, content: text } : b));
            }, [setBlocks]);

            const handleDragStart = (e, text) => {
                e.dataTransfer.setData('text/plain', text);
                setDraggedIdea(text);
            };

            const handleDragOver = useCallback((e, blockId) => {
                e.preventDefault();
                setDragOverBlock(blockId);
            }, []);

            const handleDragLeave = useCallback((e) => {
                setDragOverBlock(null);
            }, []);

            const handleDrop = useCallback((e, blockId) => {
                e.preventDefault();
                const text = e.dataTransfer.getData('text/plain');
                setBlocks(prevBlocks => {
                    const block = prevBlocks.find(b => b.id === blockId);
                    if (!block) return prevBlocks;
                    const newContent = block.content ? `${block.content} ${text}` : text;
                    return prevBlocks.map(b => b.id === blockId ? { ...b, content: newContent } : b);
                });
                setDragOverBlock(null);
                setDraggedIdea(null);
            }, [setBlocks]);

            const getFullStory = () => {
                return blocks
                    .filter(b => b.content.trim() !== '')
                    .map(b => `${b.title.toUpperCase()}:\n${b.content}`)
                    .join('\n\n');
            };

            const handleCopy = () => {
                const text = getFullStory();
                if (!text) {
                    showNotification("Write something first!", "error");
                    return;
                }
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification("Story copied to clipboard!", "success");
                } catch (err) {
                    showNotification("Failed to copy.", "error");
                }
                document.body.removeChild(textArea);
            };

            const handleExport = () => {
                const text = getFullStory();
                if (!text) {
                    showNotification("Write something first!", "error");
                    return;
                }
                const element = document.createElement("a");
                const file = new Blob([text], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = "my_story.txt";
                document.body.appendChild(element); 
                element.click();
                document.body.removeChild(element);
                showNotification("Story downloaded as text!", "success");
            };

            const handleSnapshot = () => {
                saveAsImage("story-builder-capture", "My_Story_Organizer");
            };

            const showNotification = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // Sidebar Card Components
            const CharacterMiniCard = ({ char }) => {
                const handleCopyData = (e) => {
                    e.stopPropagation(); 
                    const text = `Character Name: ${char.name}\nRole: ${char.role}\nTraits: ${char.details.map(d => d.text).join(', ')}`;
                    
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showNotification(`Copied ${char.name} for AI generation!`, "success");
                    } catch (err) {
                        showNotification("Failed to copy.", "error");
                    }
                    document.body.removeChild(textArea);
                };

                return (
                    <div 
                        draggable="true"
                        onDragStart={(e) => handleDragStart(e, char.name)}
                        className="bg-white border border-orange-100 rounded-xl p-3 shadow-sm hover:shadow-md hover:border-orange-300 cursor-grab active:cursor-grabbing group transition-all relative"
                    >
                        <div className="flex items-center gap-2 mb-2">
                            <div className="bg-orange-100 text-orange-600 p-1.5 rounded-lg">
                                <Icon name="user" size={14} />
                            </div>
                            <div className="min-w-0 flex-1">
                                <h5 className="font-heading font-bold text-slate-800 text-sm truncate leading-tight">{char.name}</h5>
                                <span className="text-[10px] uppercase font-bold text-orange-400 tracking-wide">{char.role}</span>
                            </div>
                            {/* Copy Button */}
                            <button 
                                onClick={handleCopyData}
                                className="text-slate-300 hover:text-indigo-600 p-1 hover:bg-indigo-50 rounded transition-colors"
                                title="Copy for AI Image Gen"
                            >
                                <Icon name="copy" size={14} />
                            </button>
                            <Icon name="grip" size={14} className="text-slate-300 group-hover:text-orange-300" />
                        </div>
                        {(char.details || []).length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-1">
                                {char.details.map(d => (
                                    <span 
                                        key={d.id} 
                                        draggable="true"
                                        onDragStart={(e) => {
                                            e.stopPropagation();
                                            handleDragStart(e, d.text);
                                        }}
                                        className="text-[10px] bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded-md border border-orange-100/50 break-words max-w-full cursor-grab active:cursor-grabbing hover:bg-orange-100 hover:border-orange-200 transition-colors"
                                    >
                                        {d.text}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const SettingMiniCard = ({ set }) => {
                 const handleCopyData = (e) => {
                    e.stopPropagation(); 
                    const text = `Setting Name: ${set.name}\nDetails: ${set.details.map(d => d.text).join(', ')}`;
                    
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showNotification(`Copied ${set.name} for AI generation!`, "success");
                    } catch (err) {
                        showNotification("Failed to copy.", "error");
                    }
                    document.body.removeChild(textArea);
                };

                return (
                    <div 
                        draggable="true"
                        onDragStart={(e) => handleDragStart(e, set.name)}
                        className="bg-white border border-teal-100 rounded-xl p-3 shadow-sm hover:shadow-md hover:border-teal-300 cursor-grab active:cursor-grabbing group transition-all relative"
                    >
                        <div className="flex items-center gap-2 mb-2">
                            <div className="bg-teal-100 text-teal-600 p-1.5 rounded-lg">
                                <Icon name="map" size={14} />
                            </div>
                            <div className="min-w-0 flex-1">
                                <h5 className="font-heading font-bold text-slate-800 text-sm truncate leading-tight">{set.name}</h5>
                            </div>
                             {/* Copy Button */}
                            <button 
                                onClick={handleCopyData}
                                className="text-slate-300 hover:text-indigo-600 p-1 hover:bg-indigo-50 rounded transition-colors"
                                title="Copy for AI Image Gen"
                            >
                                <Icon name="copy" size={14} />
                            </button>
                            <Icon name="grip" size={14} className="text-slate-300 group-hover:text-teal-300" />
                        </div>
                        {(set.details || []).length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-1">
                                {set.details.map(d => (
                                    <span 
                                        key={d.id} 
                                        draggable="true"
                                        onDragStart={(e) => {
                                            e.stopPropagation();
                                            handleDragStart(e, d.text);
                                        }}
                                        className="text-[10px] bg-teal-50 text-teal-700 px-1.5 py-0.5 rounded-md border border-teal-100/50 break-words max-w-full cursor-grab active:cursor-grabbing hover:bg-teal-100 hover:border-teal-200 transition-colors"
                                    >
                                        {d.text}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="max-w-6xl mx-auto relative">
                    {notification && (
                        <div className={`fixed top-24 right-8 z-50 px-6 py-3 rounded-xl shadow-2xl font-bold animate-float ${notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>
                            {notification.msg}
                        </div>
                    )}
                    
                    {/* Toolbar */}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-slate-50 p-4 rounded-2xl border border-slate-200 gap-4 mb-6">
                         <div className="text-left">
                            <h3 className="text-xl md:text-2xl font-heading font-bold text-slate-800">Story Organizer</h3>
                            <p className="text-slate-500 text-sm">Drag your ideas into the blocks!</p>
                        </div>
                        <div className="flex flex-wrap gap-2 w-full sm:w-auto">
                            <button 
                                onClick={handleSnapshot}
                                className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 font-semibold shadow-sm transition-all"
                                title="Save as Image"
                            >
                                <Icon name="camera" size={18} /> <span className="inline">Image</span>
                            </button>
                            <button 
                                onClick={handleCopy}
                                className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 font-semibold shadow-sm transition-all"
                                title="Copy to Clipboard"
                            >
                                <Icon name="copy" size={18} /> <span className="inline">Copy</span>
                            </button>
                            <button 
                                onClick={handleExport}
                                className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-sm transition-all"
                                title="Download Text File"
                            >
                                <Icon name="download" size={18} /> <span className="inline">txt</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="story-builder-capture" className="flex flex-col lg:flex-row gap-8 items-start">
                        
                        {/* SIDEBAR: Story Toolkit */}
                        <div className="w-full lg:w-80 flex-shrink-0 lg:sticky lg:top-8 space-y-6 order-2 lg:order-2 bg-slate-50/50 p-4 rounded-2xl border border-slate-200">
                             <div className="flex items-center gap-2 pb-2 border-b border-slate-200">
                                <span className="text-xl">ðŸ§°</span>
                                <h4 className="font-heading font-bold text-slate-700">Story Toolkit</h4>
                            </div>

                            {/* Ideas Section */}
                            <div>
                                <h5 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3 flex items-center justify-between">
                                    Mind Web Ideas <span className="bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-md">{ideas.length}</span>
                                </h5>
                                {ideas.length > 0 ? (
                                    <div className="flex flex-wrap gap-2">
                                        {ideas.map(idea => (
                                            <div 
                                                key={idea.id} 
                                                draggable="true"
                                                onDragStart={(e) => handleDragStart(e, idea.text)}
                                                className="bg-white px-3 py-1.5 rounded-lg shadow-sm text-slate-700 border border-slate-200 cursor-grab active:cursor-grabbing hover:border-indigo-300 hover:shadow-md transition-all flex items-center gap-1 group text-sm"
                                            >
                                                <span className="handwritten">{idea.text}</span>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-xs text-slate-400 italic">No ideas yet. Go to Mind Web!</p>
                                )}
                            </div>

                            {/* Characters Section */}
                            <div>
                                <h5 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3 flex items-center justify-between">
                                    Cast <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded-md">{characters.length}</span>
                                </h5>
                                {characters.length > 0 ? (
                                    <div className="space-y-2 max-h-[300px] overflow-y-auto scrollbar-thin pr-1">
                                        {characters.map(char => <CharacterMiniCard key={char.id} char={char} />)}
                                    </div>
                                ) : (
                                    <p className="text-xs text-slate-400 italic">No characters yet. Go to Characters!</p>
                                )}
                            </div>

                             {/* Settings Section */}
                            <div>
                                <h5 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3 flex items-center justify-between">
                                    World <span className="bg-teal-100 text-teal-600 px-1.5 py-0.5 rounded-md">{settings.length}</span>
                                </h5>
                                {settings.length > 0 ? (
                                    <div className="space-y-2 max-h-[300px] overflow-y-auto scrollbar-thin pr-1">
                                        {settings.map(set => <SettingMiniCard key={set.id} set={set} />)}
                                    </div>
                                ) : (
                                    <p className="text-xs text-slate-400 italic">No settings yet. Go to Settings!</p>
                                )}
                            </div>
                        </div>

                        {/* MAIN CONTENT: Blocks */}
                        <div className="flex-1 w-full order-1 lg:order-1">
                            {blocks.map((block, index) => (
                                <StoryBlock 
                                    key={block.id}
                                    block={block}
                                    index={index}
                                    total={blocks.length}
                                    onUpdate={handleUpdateBlock}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                    isDragOver={dragOverBlock === block.id}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home'); 
            const [selectedPrompt, setSelectedPrompt] = useState(null);
            
            const [isCustomPrompt, setIsCustomPrompt] = useState(false);
            const [customPromptText, setCustomPromptText] = useState("");

            const [activeTab, setActiveTab] = useState('web');
            const [ideas, setIdeas] = useState([]);
            const [blocks, setBlocks] = useState(storyBlocks.map(b => ({ ...b, content: '' })));
            
            // New States for Characters and Settings
            const [characters, setCharacters] = useState([]);
            const [settings, setSettings] = useState([]);

            // To track unsaved changes
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

            const [promptIndex, setPromptIndex] = useState(0);

            // Effect to track changes for warning
            useEffect(() => {
                if (ideas.length > 0 || blocks.some(b => b.content.trim() !== '') || characters.length > 0 || settings.length > 0) {
                    setHasUnsavedChanges(true);
                }
            }, [ideas, blocks, characters, settings]);

            // Unload warning listener
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    if (hasUnsavedChanges) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [hasUnsavedChanges]);

            const handlePromptSelect = (prompt) => {
                setSelectedPrompt(prompt);
                setView('workspace');
            };

            const nextPrompt = () => {
                setPromptIndex((prev) => (prev + 1) % prompts.length);
            };

            const prevPrompt = () => {
                setPromptIndex((prev) => (prev - 1 + prompts.length) % prompts.length);
            };
            
            const randomPrompt = () => {
                const rnd = Math.floor(Math.random() * prompts.length);
                setPromptIndex(rnd);
                setIsCustomPrompt(false);
            };

            const goToOrganizer = () => {
                setActiveTab('blocks');
            };

            // --- Project Save/Load Logic ---
            const saveProject = () => {
                const projectData = {
                    version: "1.2",
                    date: new Date().toISOString(),
                    prompt: selectedPrompt,
                    ideas: ideas,
                    blocks: blocks,
                    characters: characters,
                    settings: settings
                };
                
                const blob = new Blob([JSON.stringify(projectData, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `story_project_${new Date().toISOString().split('T')[0]}.spark`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setHasUnsavedChanges(false); // Reset warning
            };

            const loadProject = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.prompt) setSelectedPrompt(data.prompt);
                        if (data.ideas) setIdeas(data.ideas);
                        if (data.blocks) setBlocks(data.blocks);
                        // Handle migration for old character/setting structures if needed (simplified here)
                        if (data.characters) setCharacters(data.characters);
                        if (data.settings) setSettings(data.settings);
                        setView('workspace');
                        setHasUnsavedChanges(false);
                        alert("Project loaded successfully!");
                    } catch (err) {
                        alert("Error loading file. Make sure it's a valid .spark file.");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="min-h-screen text-slate-800 selection:bg-indigo-100 selection:text-indigo-900">
                    <header className="glass-panel sticky top-0 z-50 px-6 py-4 border-b border-white/40">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('home')}>
                                <div className="bg-gradient-to-br from-indigo-600 to-violet-600 p-2.5 rounded-xl text-white shadow-lg group-hover:shadow-indigo-500/30 transition-all duration-300 group-hover:scale-105">
                                    <Icon name="sparkles" size={20} />
                                </div>
                                <h1 className="text-2xl font-heading font-extrabold text-slate-800 tracking-tight">MacGregor Maltais Magic Writer Spark 2.1</h1>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                {/* Global Save/Load Buttons */}
                                <label className="cursor-pointer bg-white text-indigo-600 px-4 py-2 rounded-lg font-bold border border-indigo-100 hover:bg-indigo-50 transition flex items-center gap-2 shadow-sm text-sm">
                                    <Icon name="upload" size={16} /> Load Project
                                    <input type="file" accept=".spark,.json" className="hidden" onChange={loadProject} />
                                </label>

                                {view === 'workspace' && (
                                    <>
                                        <button 
                                            onClick={saveProject}
                                            className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center gap-2 shadow-md text-sm"
                                        >
                                            <Icon name="save" size={16} /> Save Project
                                        </button>
                                        <button 
                                            onClick={() => setView('prompts')}
                                            className="text-sm font-semibold text-slate-500 hover:text-indigo-600 flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-lg transition-colors"
                                        >
                                            <Icon name="refresh" size={16} /> New Prompt
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-8">
                        {view === 'home' && (
                            <div className="py-12 md:py-20">
                                <div className="text-center space-y-8 max-w-4xl mx-auto">
                                    <div className="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 rounded-full font-semibold text-sm mb-4 border border-indigo-100">
                                        âœ¨ Unleash your creativity
                                    </div>
                                    <h2 className="text-6xl md:text-7xl font-heading font-extrabold text-slate-900 leading-tight">
                                        Ignite Your <br/>
                                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600">Storytelling Spark</span>
                                    </h2>
                                    <p className="text-xl md:text-2xl text-slate-600 max-w-2xl mx-auto leading-relaxed">
                                        Don't let the blank page scare you. Spin the wheel, map your mind, and build your story block by block.
                                    </p>
                                    
                                    <div className="pt-8 flex justify-center gap-4">
                                        <button 
                                            onClick={() => setView('prompts')}
                                            className="group bg-slate-900 text-white text-xl font-bold py-5 px-10 rounded-full shadow-2xl hover:bg-slate-800 hover:shadow-slate-900/30 hover:-translate-y-1 transition-all duration-300 inline-flex items-center gap-3"
                                        >
                                            Start Writing <Icon name="arrowRight" className="group-hover:translate-x-1 transition-transform" />
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-20 text-left">
                                        <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                            <div className="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-2xl mb-6">ðŸ¤”</div>
                                            <h3 className="font-heading font-bold text-xl mb-3">Prompt Bank</h3>
                                            <p className="text-slate-500">Stuck? Choose from our curated list of creative story starters.</p>
                                        </div>
                                        <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                            <div className="w-12 h-12 bg-pink-100 rounded-2xl flex items-center justify-center text-2xl mb-6">ðŸ§ </div>
                                            <h3 className="font-heading font-bold text-xl mb-3">Mind Web</h3>
                                            <p className="text-slate-500">Brainstorm ideas visually and connect the dots for your story.</p>
                                        </div>
                                        <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                            <div className="w-12 h-12 bg-amber-100 rounded-2xl flex items-center justify-center text-2xl mb-6">ðŸ“</div>
                                            <h3 className="font-heading font-bold text-xl mb-3">Story Organizer</h3>
                                            <p className="text-slate-500">Structure your narrative with our guided block-by-block method.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'prompts' && (
                            <div className="max-w-5xl mx-auto py-4 md:py-8">
                                <div className="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-10 gap-4">
                                    <h2 className="text-3xl md:text-4xl font-heading font-bold text-slate-800 text-center md:text-left">Choose Your Adventure</h2>
                                    <div className="flex flex-wrap justify-center gap-3 w-full md:w-auto">
                                        <button 
                                            onClick={() => setIsCustomPrompt(!isCustomPrompt)}
                                            className={`px-4 py-3 md:px-6 rounded-xl font-bold transition-all border-2 border-indigo-100 text-sm md:text-base flex-1 md:flex-none ${isCustomPrompt ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-indigo-600 hover:bg-indigo-50'}`}
                                        >
                                            {isCustomPrompt ? "Back to List" : "Write My Own"}
                                        </button>
                                        {!isCustomPrompt && (
                                            <button onClick={randomPrompt} className="bg-yellow-400 text-yellow-950 px-4 py-3 md:px-6 rounded-xl font-bold hover:bg-yellow-300 shadow-lg shadow-yellow-400/20 transition-colors flex items-center justify-center gap-2 text-sm md:text-base flex-1 md:flex-none">
                                                <Icon name="sparkles" size={18} /> Surprise Me!
                                            </button>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white rounded-[2rem] shadow-2xl overflow-hidden min-h-[60vh] flex flex-col md:flex-row border border-slate-100">
                                    {!isCustomPrompt && (
                                        <div className="hidden md:block w-1/3 bg-slate-50 border-r border-slate-200 overflow-y-auto max-h-[60vh] scrollbar-thin">
                                            {prompts.map((p, i) => (
                                                <div 
                                                    key={i} 
                                                    onClick={() => setPromptIndex(i)}
                                                    className={`p-6 cursor-pointer border-b border-slate-200/50 hover:bg-white transition-all ${i === promptIndex ? 'bg-white border-l-4 border-l-indigo-600 shadow-sm' : 'border-l-4 border-l-transparent text-slate-500'}`}
                                                >
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className={`text-xs font-bold uppercase tracking-wider ${i === promptIndex ? 'text-indigo-600' : 'text-slate-400'}`}>Prompt {i + 1}</span>
                                                        {i === promptIndex && <Icon name="chevronRight" size={14} className="text-indigo-600" />}
                                                    </div>
                                                    <p className={`text-sm line-clamp-2 ${i === promptIndex ? 'text-slate-800 font-medium' : ''}`}>{p}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    <div className="flex-1 p-6 md:p-12 flex flex-col justify-center items-center relative">
                                        <div className="absolute inset-0 bg-[radial-gradient(#e2e8f0_1px,transparent_1px)] [background-size:20px_20px] opacity-50"></div>
                                        
                                        <div className="relative bg-white p-6 md:p-16 rounded-2xl shadow-xl shadow-slate-200 border border-slate-100 max-w-xl w-full text-center mb-6 md:mb-0">
                                            {isCustomPrompt ? (
                                                <div className="space-y-6">
                                                     <div className="bg-indigo-50 text-indigo-800 font-bold px-4 py-2 rounded-full inline-block text-sm">
                                                        âœï¸ Your Creative Idea
                                                    </div>
                                                    <h3 className="text-2xl font-heading font-bold text-slate-800">What's on your mind?</h3>
                                                    <textarea 
                                                        className="w-full p-4 border-2 border-slate-200 rounded-xl text-lg md:text-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all min-h-[150px] font-medium text-slate-700"
                                                        placeholder="Type your story idea here..."
                                                        value={customPromptText}
                                                        onChange={(e) => setCustomPromptText(e.target.value)}
                                                        autoFocus
                                                    />
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white text-xs md:text-sm font-bold px-4 py-1.5 rounded-full shadow-lg whitespace-nowrap">
                                                        Prompt #{promptIndex + 1}
                                                    </div>
                                                    <p className="text-2xl md:text-4xl font-heading font-bold text-slate-800 leading-snug">
                                                        "{prompts[promptIndex]}"
                                                    </p>
                                                </>
                                            )}
                                        </div>

                                        <div className="flex gap-4 mt-6 md:mt-12 relative z-10 w-full md:w-auto justify-center">
                                            {!isCustomPrompt && (
                                                <button onClick={prevPrompt} className="p-4 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-slate-800 hover:border-slate-300 transition-colors shadow-sm">
                                                    <Icon name="arrowRight" className="rotate-180" />
                                                </button>
                                            )}
                                            
                                            <button 
                                                onClick={() => {
                                                    if (isCustomPrompt && !customPromptText.trim()) {
                                                        alert("Please write an idea first!");
                                                        return;
                                                    }
                                                    handlePromptSelect(isCustomPrompt ? customPromptText : prompts[promptIndex]);
                                                }}
                                                className="bg-slate-900 text-white font-bold py-4 px-8 md:px-10 rounded-full shadow-xl hover:bg-slate-800 hover:scale-105 transition-all duration-300 flex items-center gap-2 whitespace-nowrap text-lg"
                                            >
                                                Start Writing <Icon name="pencil" size={18} />
                                            </button>

                                            {!isCustomPrompt && (
                                                <button onClick={nextPrompt} className="p-4 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-slate-800 hover:border-slate-300 transition-colors shadow-sm">
                                                    <Icon name="arrowRight" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'workspace' && (
                            <div className="pb-20">
                                <div className="bg-slate-900 text-white p-6 md:p-10 rounded-3xl shadow-xl mb-6 md:mb-10 relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 opacity-5 transform translate-x-20 -translate-y-10 group-hover:scale-110 transition-transform duration-700">
                                        <Icon name="book" size={300} />
                                    </div>
                                    <div className="relative z-10">
                                        <h3 className="text-indigo-300 font-bold uppercase tracking-wider text-xs mb-3 flex items-center gap-2">
                                            <span className="w-8 h-[1px] bg-indigo-300"></span> Current Prompt
                                        </h3>
                                        <p className="text-xl md:text-3xl font-heading font-bold leading-relaxed">"{selectedPrompt}"</p>
                                    </div>
                                </div>

                                <div className="flex flex-col gap-6">
                                    {/* Horizontal Tabs */}
                                    <div className="w-full">
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-2 grid grid-cols-2 md:grid-cols-4 gap-2">
                                            <button 
                                                onClick={() => setActiveTab('web')}
                                                className={`flex items-center justify-center gap-2 px-3 py-3 rounded-xl font-bold transition-all ${activeTab === 'web' ? 'bg-pink-50 text-pink-700' : 'text-slate-500 hover:bg-slate-50'}`}
                                            >
                                                <div className={`p-1.5 rounded-lg ${activeTab === 'web' ? 'bg-pink-200 text-pink-700' : 'bg-slate-100 text-slate-400'}`}>
                                                    <Icon name="brain" size={16} /> 
                                                </div>
                                                <span className="text-sm md:text-base">Mind Web</span>
                                            </button>
                                            <button 
                                                onClick={() => setActiveTab('characters')}
                                                className={`flex items-center justify-center gap-2 px-3 py-3 rounded-xl font-bold transition-all ${activeTab === 'characters' ? 'bg-orange-50 text-orange-700' : 'text-slate-500 hover:bg-slate-50'}`}
                                            >
                                                <div className={`p-1.5 rounded-lg ${activeTab === 'characters' ? 'bg-orange-200 text-orange-700' : 'bg-slate-100 text-slate-400'}`}>
                                                    <Icon name="user" size={16} /> 
                                                </div>
                                                <span className="text-sm md:text-base">Characters</span>
                                            </button>
                                            <button 
                                                onClick={() => setActiveTab('settings')}
                                                className={`flex items-center justify-center gap-2 px-3 py-3 rounded-xl font-bold transition-all ${activeTab === 'settings' ? 'bg-teal-50 text-teal-700' : 'text-slate-500 hover:bg-slate-50'}`}
                                            >
                                                <div className={`p-1.5 rounded-lg ${activeTab === 'settings' ? 'bg-teal-200 text-teal-700' : 'bg-slate-100 text-slate-400'}`}>
                                                    <Icon name="map" size={16} /> 
                                                </div>
                                                <span className="text-sm md:text-base">Settings</span>
                                            </button>
                                            <button 
                                                onClick={() => setActiveTab('blocks')}
                                                className={`flex items-center justify-center gap-2 px-3 py-3 rounded-xl font-bold transition-all ${activeTab === 'blocks' ? 'bg-amber-50 text-amber-700' : 'text-slate-500 hover:bg-slate-50'}`}
                                            >
                                                <div className={`p-1.5 rounded-lg ${activeTab === 'blocks' ? 'bg-amber-200 text-amber-700' : 'bg-slate-100 text-slate-400'}`}>
                                                    <Icon name="book" size={16} /> 
                                                </div>
                                                <span className="text-sm md:text-base">Story Org.</span>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Main Workspace */}
                                    <div className="w-full">
                                        <div className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-4 md:p-8 min-h-[50vh] border border-slate-100">
                                            {activeTab === 'web' && <MindWeb ideas={ideas} setIdeas={setIdeas} onOrganize={goToOrganizer} />}
                                            {activeTab === 'characters' && <CharacterBuilder characters={characters} setCharacters={setCharacters} />}
                                            {activeTab === 'settings' && <SettingBuilder settings={settings} setSettings={setSettings} />}
                                            {activeTab === 'blocks' && <StoryBuilder blocks={blocks} setBlocks={setBlocks} ideas={ideas} characters={characters} settings={settings} />}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="text-center text-slate-400 py-10 text-sm border-t border-slate-200/50 mt-10">
                        <p>Â© 2024 Writer Spark. Created for storytellers everywhere.</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
