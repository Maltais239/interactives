<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>world geography hub final</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
            overflow: hidden;
        }
        /* CSS rules to fix rendering artifacts */
        .leaflet-container {
            background: #aadaff;
            outline: 1px solid transparent; /* Prevents tile tearing */
        }
        
        .map-background-tiles {
            /* Helps prevent seams between map tiles on some browsers */
            image-rendering: -webkit-optimize-contrast; /* Chrome/Safari */
            image-rendering: crisp-edges; /* Firefox/Opera */
        }

        #map {
            flex: 1;
            height: 100%;
            border-right: 1px solid #ddd;
        }
        #info-panel {
            width: 380px;
            max-width: 40%;
            padding: 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-left: 5px solid #0d9488;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #info-panel h2 {
            margin-top: 0;
            color: #134e4a;
            font-size: 1.75rem;
            font-weight: 700;
            border-bottom: 2px solid #99f6e4;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .loading-text {
            text-align: center;
            font-weight: 500;
            color: #0f766e;
            padding: 2rem;
        }

        /* Mode & Region Switcher */
        .mode-switcher, .region-switcher {
            display: flex;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            background-color: #ccfbf1;
            padding: 0.25rem;
            flex-wrap: wrap;
        }
        .mode-btn, .region-btn {
            flex: 1 1 auto;
            padding: 0.75rem 0.5rem;
            border: none;
            background-color: transparent;
            color: #14b8a6;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s;
            text-align: center;
        }
        .mode-btn.active, .region-btn.active {
            background-color: #14b8a6;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .region-switcher {
             background-color: #e0f2f1;
             margin-top: -0.5rem;
        }
        .region-btn { color: #00796b; font-size: 0.9rem; }
        .region-btn.active { background-color: #00796b;}


        /* Panels */
        .mode-panel { display: none; }
        .mode-panel.active { display: block; }
        #info-content, #result-box {
             border-top: 1px solid #ddd; padding-top: 1.5rem;
        }
        #info-content h3, #result-box h3 {
            margin-top: 0; margin-bottom: 1rem; color: #0d9488; font-size: 1.5rem; font-weight: 600;
        }
        #info-content p, #result-box p {
            font-size: 1rem; line-height: 1.6; margin: 0.5rem 0 1rem 0; color: #0f766e;
        }
        #info-content p strong, #result-box p strong { color: #134e4a; }

        /* Quiz Mode Styling */
        #question-box {
            background-color: #f0fdfa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #99f6e4;
            min-height: 100px;
            font-size: 1.1rem;
            color: #115e59;
            line-height: 1.6;
            font-weight: 500;
        }
        
        #result-box p.feedback-correct { color: #166534; font-weight: bold; }
        #result-box p.feedback-incorrect { color: #991b1b; font-weight: bold; }

        /* Button Controls */
        #button-controls { margin-top: auto; display: flex; gap: 0.5rem; padding-top: 1rem; }
        .game-btn {
            flex: 1; padding: 0.75rem; color: white; border: none; border-radius: 8px; font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: background-color 0.2s, opacity 0.2s;
        }
        #next-question-btn { display: none; background-color: #0d9488; }
        #next-question-btn:hover { background-color: #0f766e; }
        #play-again-btn { display: none; background-color: #16a34a; }
        #play-again-btn:hover { background-color: #15803d; }
        #hint-btn { display: none; background-color: #f59e0b; }
        #hint-btn:hover { background-color: #d97706; }
        #hint-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* Practice Mode Styling */
        #practice-list { margin-top: 1rem; }
        .practice-item {
            padding: 0.75rem 1rem;
            background-color: #f0fdfa;
            border: 1px solid #ccfbf1;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            font-weight: 500;
            color: #115e59;
        }
        .practice-item:hover {
            background-color: #ccfbf1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-panel">
        <h2>world geography hub final</h2>

        <div class="mode-switcher">
            <button id="explore-mode-btn" class="mode-btn active">Explore</button>
            <button id="quiz-mode-btn" class="mode-btn">Quiz</button>
            <button id="practice-mode-btn" class="mode-btn">Practice</button>
        </div>

        <div class="region-switcher">
            <button class="region-btn active" data-region="World Tour">World Tour</button>
            <button class="region-btn" data-region="Americas">Americas</button>
            <button class="region-btn" data-region="Europe">Europe</button>
            <button class="region-btn" data-region="Africa">Africa</button>
            <button class="region-btn" data-region="Asia">Asia</button>
            <button class="region-btn" data-region="Oceania">Oceania</button>
        </div>

        <div id="explore-panel" class="mode-panel active">
            <div id="info-content">
                 <p class="loading-text">Loading map data...</p>
            </div>
        </div>

        <div id="quiz-panel" class="mode-panel">
            <div id="question-box"></div>
            <div id="result-box"></div>
            <div id="button-controls">
                <button id="hint-btn" class="game-btn">Get a Hint ðŸ’¡</button>
                <button id="next-question-btn" class="game-btn">Next Question &rarr;</button>
                <button id="play-again-btn" class="game-btn">Play Again? â†»</button>
            </div>
        </div>

        <div id="practice-panel" class="mode-panel">
            <h3>Practice Bank</h3>
            <p>Here are the countries you've missed. Click one to find it on the map!</p>
            <div id="practice-list">Your practice bank is empty.</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- DOM Elements ---
        const map = L.map('map', {
            renderer: L.canvas(), // Use Canvas renderer to prevent SVG rendering glitches
            worldCopyJump: true, // Fixes rendering of large polygons like Russia across the date line
            maxBounds: [[-85, -180], [85, 180]], // Prevents scrolling into empty blue space
            maxBoundsViscosity: 1.0 // Makes the bounds firm
        }).setView([30, 10], 2);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 10,
            minZoom: 2,
            noWrap: true,
            className: 'map-background-tiles'
        }).addTo(map);

        const exploreModeBtn = document.getElementById('explore-mode-btn');
        const quizModeBtn = document.getElementById('quiz-mode-btn');
        const practiceModeBtn = document.getElementById('practice-mode-btn');
        const explorePanel = document.getElementById('explore-panel');
        const quizPanel = document.getElementById('quiz-panel');
        const practicePanel = document.getElementById('practice-panel');
        const practiceList = document.getElementById('practice-list');
        const infoContent = document.getElementById('info-content');
        const questionBox = document.getElementById('question-box');
        const resultBox = document.getElementById('result-box');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const hintBtn = document.getElementById('hint-btn');
        const regionBtns = document.querySelectorAll('.region-btn');

        // --- App State ---
        let geojson;
        let countriesData = {};
        let quizState = {};
        let currentMode = 'explore';
        let currentRegion = 'World Tour';
        let isQuizActive = true;
        let currentQuestion = {};
        let currentHintIndex = 0;
        let incorrectGuesses = 0;
        let practiceBank = [];
        let justMissedCountry = null;

        const regionBounds = {
            'Americas': [[50, -120], [-55, -50]], 'Europe': [[70, -10], [35, 40]],
            'Africa': [[35, -20], [-35, 50]], 'Asia': [[70, 40], [0, 140]],
            'Oceania': [[-10, 110], [-50, 180]], 'World Tour': [[30, 10], 2]
        };
        
        // --- Main Logic ---
        function initializeApp(worldGeoData) {
            try {
                const factsMap = new Map();
                countryFacts.forEach(fact => factsMap.set(fact.name.common, fact));
                
                // Load the HIGH-RES map first to prioritize its shapes for small islands and complex names
                worldGeoData[1].features.forEach(feature => {
                    const countryName = feature.properties.ADMIN;
                    const fact = factsMap.get(countryName);
                    if (fact) {
                        countriesData[countryName] = { ...fact, geometry: feature.geometry, name: countryName };
                    }
                });

                // Load the primary, stable dataset, but only add countries that we don't already have
                worldGeoData[0].features.forEach(feature => {
                    const countryName = feature.properties.name;
                    const fact = factsMap.get(countryName);
                    if (fact && !countriesData[countryName]) { // Add if not already present
                        countriesData[countryName] = { ...fact, geometry: feature.geometry, name: countryName };
                    }
                });

                initializeLogic();
            } catch (error) {
                console.error("Data processing error:", error);
                infoContent.innerHTML = `<p class="loading-text">Could not process map data.</p>`;
            }
        }
        
        function initializeLogic() {
            infoContent.innerHTML = '<p>Click on a country to learn more about it!</p>';
            
            Object.keys(regionBounds).forEach(region => {
                const regionCountries = Object.values(countriesData).filter(c => c.region === region);
                // World Tour includes all countries
                const allQuestionsForRegion = (region === 'World Tour' ? Object.values(countriesData) : regionCountries).map(country => ({
                    answer: country.name,
                    hints: [
                        `This country is in ${country.subregion || country.region}.`,
                        `Its neighbors are: ${country.borders?.map(b => getCountryNameByCca3(b)).filter(n=>n).join(', ') || 'None'}.`,
                        `The capital city is ${country.capital?.[0] || 'N/A'}.`
                    ]
                }));

                quizState[region] = {
                    allQuestions: allQuestionsForRegion,
                    availableQuestions: [...allQuestionsForRegion], // Initialize with all questions
                    correctlyGuessed: []
                };
            });

            const allFeatures = Object.values(countriesData).map(c => ({
                type: "Feature", properties: { name: c.name }, geometry: c.geometry
            }));
            geojson = L.geoJson({ type: "FeatureCollection", features: allFeatures }, { style, onEachFeature }).addTo(map);
            
            setMode('explore');
        }

        // --- Event Listeners ---
        exploreModeBtn.addEventListener('click', () => setMode('explore'));
        quizModeBtn.addEventListener('click', () => setMode('quiz'));
        practiceModeBtn.addEventListener('click', () => setMode('practice'));
        nextQuestionBtn.addEventListener('click', () => loadNewQuestion());
        playAgainBtn.addEventListener('click', resetQuiz);
        hintBtn.addEventListener('click', showHint);
        
        regionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentRegion = btn.dataset.region;
                regionBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const bounds = regionBounds[currentRegion];
                currentRegion === 'World Tour' ? map.setView(bounds[0], bounds[1]) : map.flyToBounds(bounds);
                setTimeout(() => map.invalidateSize(), 400);
                
                if (currentMode === 'quiz') {
                     const state = quizState[currentRegion];
                    if (state.availableQuestions.length === 0 && state.correctlyGuessed.length > 0) {
                        // If we are returning to a completed region, show completion message
                         questionBox.innerHTML = `You've identified all the countries in ${currentRegion}!`;
                        resultBox.innerHTML = `<h2>Congratulations! ðŸ¥³</h2>`;
                        playAgainBtn.style.display = 'block';
                        nextQuestionBtn.style.display = 'none';
                        hintBtn.style.display = 'none';
                        isQuizActive = false;
                    } else {
                        // Otherwise, load a new question
                        loadNewQuestion();
                    }
                }

                if(geojson) geojson.resetStyle();
            });
        });

        // --- Mode Switching ---
        function setMode(mode) {
            currentMode = mode;
            exploreModeBtn.classList.toggle('active', mode === 'explore');
            quizModeBtn.classList.toggle('active', mode === 'quiz');
            practiceModeBtn.classList.toggle('active', mode === 'practice');
            explorePanel.classList.toggle('active', mode === 'explore');
            quizPanel.classList.toggle('active', mode === 'quiz');
            practicePanel.classList.toggle('active', mode === 'practice');
            
            // This logic ensures progress is NOT reset when switching between modes.
            // A full reset only happens with the "Play Again" button.
            if (mode === 'quiz') {
                const hasQuizStarted = Object.values(quizState).some(s => s.correctlyGuessed.length > 0 || s.availableQuestions.length < s.allQuestions.length);
                if (!hasQuizStarted) {
                    resetQuiz(); // Only reset fully on the very first time entering quiz mode
                } else {
                    loadNewQuestion(); // Otherwise just load a question to reflect current state
                }
            }
            if (mode === 'practice') {
                updatePracticePanel();
            }
            if(geojson) geojson.resetStyle();
        }

        // --- Quiz Logic ---
        function resetQuiz() {
            Object.values(quizState).forEach(s => {
                s.correctlyGuessed = [];
                s.availableQuestions = [...s.allQuestions];
            });
            practiceBank = []; // Also clear the practice bank on a full reset
            if(geojson) geojson.resetStyle();
            loadNewQuestion();
        }
        
        function loadNewQuestion() {
            const state = quizState[currentRegion];
            if (!state || state.availableQuestions.length === 0) {
                questionBox.innerHTML = `You've identified all the countries in ${currentRegion}!`;
                resultBox.innerHTML = `<h2>Congratulations! ðŸ¥³</h2>`;
                playAgainBtn.style.display = 'block';
                nextQuestionBtn.style.display = 'none';
                hintBtn.style.display = 'none';
                isQuizActive = false;
                return;
            }

            isQuizActive = true;
            justMissedCountry = null; // Clear previously missed country highlight
            incorrectGuesses = 0; // Reset guess count for the new question
            currentHintIndex = 0; // Reset hint index for the new question
            const questionIndex = Math.floor(Math.random() * state.availableQuestions.length);
            currentQuestion = state.availableQuestions.splice(questionIndex, 1)[0];
            
            questionBox.innerHTML = `Find <strong>${currentQuestion.answer}</strong> on the map.`;
            resultBox.innerHTML = `<p>Click the correct country on the map!</p>`;
            
            playAgainBtn.style.display = 'none';
            nextQuestionBtn.style.display = 'none';
            hintBtn.style.display = 'block';
            hintBtn.disabled = false;
            if (geojson) geojson.resetStyle();
        }

        function checkAnswer(countryName) {
            if (!isQuizActive) return;

            if (countryName === currentQuestion.answer) {
                isQuizActive = false; // Temporarily disable clicks
                hintBtn.style.display = 'none';

                // Sync progress across all regions
                Object.values(quizState).forEach(s => {
                    // Add to correctlyGuessed if not already there
                    if (s.allQuestions.some(q => q.answer === countryName) && !s.correctlyGuessed.includes(countryName)) {
                        s.correctlyGuessed.push(countryName);
                    }
                    // Remove from availableQuestions lists to prevent it from being asked again
                    const indexToRemove = s.availableQuestions.findIndex(q => q.answer === countryName);
                    if (indexToRemove > -1) {
                        s.availableQuestions.splice(indexToRemove, 1);
                    }
                });

                if (geojson) geojson.resetStyle();
                
                resultBox.innerHTML = `<p class="feedback-correct">Correct! It's ${countryName}.</p>`;
                
                // Automatically load the next question after a short
