<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Canada SVG Puzzle â€“ OFFLINE</title>
  <style>
    :root { --bg:#0b1020; --ink:#e8ecf6; }
    html, body { height:100%; margin:0; }
    body { background:var(--bg); color:var(--ink); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #stage { position:fixed; inset:0; background:#09112a; }
    #boardWrap { position:absolute; inset:0; display:grid; place-items:center; }
    svg#board { width:100%; height:100%; max-width:1800px; aspect-ratio:1000/600; background:#eef5fb; touch-action:none; }
    #targets path { fill:#e7eef8; stroke:#bcd3f5; stroke-width:1; }
    #targets g.done path { fill:#eaf7ee; stroke:#a7e3ba; }
    #pieces g.piece { cursor:grab; filter:drop-shadow(0 2px 6px rgba(0,0,0,.3)); }
    #pieces g.piece.dragging { cursor:grabbing; opacity:.9; }
    #pieces g.piece.placed { cursor:default; filter:none; }
    .controls { position:absolute; top:12px; left:12px; display:flex; gap:8px; z-index:10; }
    .btn { background:#172149; color:#cde; border:1px solid #30427a; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; }
    .btn:hover { filter:brightness(1.08); }
  </style>
</head>
<body>
  <div id="stage">
    <div id="boardWrap">
      <svg id="board" viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <clipPath id="boardClip"><rect x="0" y="0" width="1000" height="600" /></clipPath>
        </defs>
        <g clip-path="url(#boardClip)">
          <g id="targets"></g>
          <g id="pieces"></g>
        </g>
      </svg>
    </div>
  </div>
  <div class="controls"><button class="btn" id="shuffle">Shuffle</button><button class="btn" id="reset">Reset</button></div>
  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
  <script>
    const log=(...a)=>console.log('[puzzle]',...a);
    const gTargets=document.getElementById('targets');
    const gPieces=document.getElementById('pieces');
    const BOARD_WIDTH=1000,BOARD_HEIGHT=600;let projection,path,features=[],targetsByName={};

    const EMBEDDED_JSON_TEXT = ``;

    function normName(p){return p.name||p.province||p.NAME||p.admin||p.abbrev||'Unknown'}
    function colorFor(n){let h=0;for(const c of n)h=(h*31+c.charCodeAt(0))>>>0;return `hsl(${h%360} 80% 60%)`}
    function fitProjection(fc){projection=d3.geoMercator().fitSize([BOARD_WIDTH,BOARD_HEIGHT],fc);path=d3.geoPath(projection)}

    function geoToPaths(fc){fitProjection(fc);gTargets.innerHTML='';targetsByName={};const tg=d3.select(gTargets).selectAll('g').data(fc.features).enter().append('g').attr('data-name',d=>normName(d.properties));tg.append('path').attr('d',d=>path(d)).attr('fill','#e7eef8').attr('stroke','#bcd3f5').attr('stroke-width',1).attr('fill-rule','evenodd').attr('vector-effect','non-scaling-stroke');tg.each(function(d){const n=normName(d.properties);const c=path.centroid(d);targetsByName[n]={x:c[0],y:c[1],path:path(d),node:this}});spawnPieces(fc)}

    function spawnPieces(fc){d3.select(gPieces).selectAll('*').remove();const sh=d3.shuffle([...fc.features]);const cols=5,padX=40,padY=BOARD_HEIGHT-180,cell=110;let i=0;const pcs=d3.select(gPieces).selectAll('g.piece').data(sh,d=>normName(d.properties)).enter().append('g').attr('class','piece').attr('data-name',d=>normName(d.properties)).call(d3.drag().on('start',dragStarted).on('drag',dragged).on('end',dragEnded));pcs.each(function(d){const g=d3.select(this);const c=path.centroid(d);g.attr('data-cx',c[0]).attr('data-cy',c[1]);g.append('path').attr('d',path(d)).attr('fill',colorFor(normName(d.properties))).attr('stroke','#1f2937').attr('stroke-width',1).attr('fill-rule','evenodd').attr('vector-effect','non-scaling-stroke')});pcs.attr('transform',function(){const cx=+this.getAttribute('data-cx');const cy=+this.getAttribute('data-cy');const x=padX+(i%cols)*cell+(Math.random()*40-20);const y=padY+Math.floor(i/cols)*80+(Math.random()*30-15);i++;return `translate(${x-cx},${y-cy})`})}

    function getTranslate(el){const m=/translate\(([-0-9.]+),\s*([-0-9.]+)\)/.exec(el.getAttribute('transform')||'translate(0,0)');return{x:+m[1],y:+m[2]}}
    function dragStarted(e){if(this.classList.contains('placed'))return;this.classList.add('dragging');this._t0=getTranslate(this)}
    function dragged(e){if(this.classList.contains('placed'))return;const x=this._t0.x+e.dx;const y=this._t0.y+e.dy;this.setAttribute('transform',`translate(${x},${y})`);this._t0={x,y}}
    function dragEnded(e){this.classList.remove('dragging');if(this.classList.contains('placed'))return;const name=this.getAttribute('data-name');const tgt=targetsByName[name];if(!tgt)return;const t=getTranslate(this);const cx=+this.getAttribute('data-cx');const cy=+this.getAttribute('data-cy');const cur={x:t.x+cx,y:t.y+cy};const dist=Math.hypot(cur.x-tgt.x,cur.y-tgt.y);const R=28;if(dist<R){const nx=t.x+(tgt.x-cur.x);const ny=t.y+(tgt.y-cur.y);this.setAttribute('transform',`translate(${nx},${ny})`);this.classList.add('placed');this.style.filter='none';d3.select(tgt.node).classed('done',true);checkWin()}}

    function checkWin(){const all=[...gPieces.querySelectorAll('g.piece')];if(all.length&&all.every(n=>n.classList.contains('placed'))){alert('Great job! All provinces and territories placed.')}}

    document.getElementById('shuffle').onclick=()=>spawnPieces({type:'FeatureCollection',features});
    document.getElementById('reset').onclick=()=>geoToPaths({type:'FeatureCollection',features});

    function coerceToFeatureCollection(d){if(d.type==='FeatureCollection')return d;if(d.type==='Feature')return{type:'FeatureCollection',features:[d]};if(Array.isArray(d))return{type:'FeatureCollection',features:d};throw new Error('Unsupported GeoJSON structure')}
    function pickCanadaFeatures(fc){const keep=fc.features.filter(f=>f.geometry&&/Polygon/i.test(f.geometry.type));const expected=new Set(['British Columbia','Alberta','Saskatchewan','Manitoba','Ontario','Quebec','New Brunswick','Nova Scotia','Prince Edward Island','Newfoundland and Labrador','Yukon','Northwest Territories','Nunavut']);const withNames=keep.filter(f=> expected.has((f.properties||{}).name)|| expected.has((f.properties||{}).province)|| expected.has((f.properties||{}).NAME));const chosen=withNames.length===13?withNames:keep;return{type:'FeatureCollection',features:chosen}}
    function initWithGeoJSON(raw){const fc=pickCanadaFeatures(coerceToFeatureCollection(raw));features=fc.features;geoToPaths(fc)}

    (function start(){fetch('https://cdn.jsdelivr.net/gh/codeforgermany/click_that_hood@master/public/data/canada.geojson').then(r=>r.json()).then(d=>initWithGeoJSON(d));})();
  </script>
</body>
</html>

