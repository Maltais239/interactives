<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activité d'Annotation Étudiante - Écosystèmes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
        }
        h1, h2 {
            text-align: center;
            font-weight: 700;
        }
        h1 { color: #1e40af; margin-bottom: 10px; font-size: 1.8rem; }
        h2 { color: #1d4ed8; margin-bottom: 15px; font-size: 1.1rem; font-weight: 500; }
        
        .main-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 768px) { 
            .main-content-wrapper {
                flex-direction: row;
            }
        }

        .left-column {
            flex: 1.8;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .source-text-column {
            min-width: 300px; 
        }
        .source-text-column h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151; 
            margin-bottom: 10px;
        }
        .source-text-content { 
            line-height: 1.8; 
            font-size: 0.95rem;
            color: #374151; 
            border: 1px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            background-color: #f9fafb;
            word-break: break-word; 
        }
         .source-text-content p { 
            margin-bottom: 0.5em; 
        }
        .source-text-content p:last-child {
            margin-bottom: 0; 
        }
        .source-text-content > div {
             margin-bottom: 0; 
        }

        .annotations-column {
            flex: 1; 
            min-width: 280px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }

        .word-span {
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            padding: 1px 2px; 
            border-radius: 3px;
            display: inline; 
        }
        .phrase-span {
            display: inline !important; 
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            padding: 2px 3px; 
            border-radius: 3px;
        }

        .source-text-content.keywords-mode-active .word-span:not(.highlight-keyword):not(.highlight-idea):hover {
            background-color: #bee3f8; 
        }
        .source-text-content.ideas-mode-active .phrase-span:not(.highlight-keyword):not(.highlight-idea):hover {
            background-color: #c6f6d5; 
            box-shadow: 0 0 0 1px #a7f3d0; 
        }

        .highlight-keyword { 
            background-color: #bfdbfe !important; 
        }
        .highlight-idea { 
            background-color: #bbf7d0 !important; 
        }

        .highlight-keyword:hover, .highlight-idea:hover {
            background-color: #fecaca !important; 
            text-decoration: line-through;
            text-decoration-color: #7f1d1d; 
        }

        .annotation-box {
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            background-color: #f9fafb; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .annotation-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background-color: #e5e7eb; 
            border-top-left-radius: 7px; 
            border-top-right-radius: 7px;
            padding: 8px 12px; 
            cursor: pointer; 
            transition: background-color 0.3s ease;
        }
        .annotation-header.active-mode {
            background-color: #3b82f6; 
            color: white;
        }
        .annotation-header h4 { 
            font-weight: 600; 
            color: #374151; 
            flex-grow: 1; 
            font-size: 0.9rem;
        }
        .annotation-header.active-mode h4 { 
            color: white; 
        }

        .annotation-box textarea {
            width: 100%; 
            min-height: 120px; 
            border: none; 
            padding: 12px; 
            border-radius: 0 0 7px 7px; 
            font-size: 0.9rem; 
            resize: vertical;
            background-color: #ffffff; 
            border-top: 1px solid #d1d5db; 
            color: #1f2937; 
        }
        #keyIdeasTextarea { 
            min-height: 180px; 
        }
        .annotation-box textarea::placeholder {
            color: #9ca3af; 
        }
        .clear-btn {
            background-color: #6b7280; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.75rem; 
            line-height: 1;
            transition: background-color 0.3s ease;
            margin-left: 8px; 
        }
        .clear-btn:hover { 
            background-color: #4b5563; 
        }

        .global-action-buttons { 
            margin-top: 25px; 
            display: flex; 
            gap: 12px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }
        .global-action-buttons button {
            background-color: #2563eb; 
            color: white; 
            border: none; 
            padding: 10px 20px;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.95rem; 
            font-weight: 500;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .global-action-buttons button:hover { 
            background-color: #1d4ed8; 
        }
        .global-action-buttons button#copyAnnotationsBtn {
            background-color: #059669; 
        }
        .global-action-buttons button#copyAnnotationsBtn:hover {
             background-color: #047857;
        }
        #feedbackArea { 
            margin-top: 20px; 
            text-align: center; 
            font-weight: 500; 
            min-height: 24px; 
            color: #16a34a; 
        }
        #feedbackArea.error {
            color: #dc2626; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Activité d'Annotation Étudiante</h1>
        <h2>Le Monde Super des Écosystèmes</h2>

        <div class="main-content-wrapper"> 
            <div class="left-column"> 
                <div class="source-text-column">
                    <h3>Texte Source <span style="font-weight:400; font-size: 0.85rem;">(Sélectionnez le mode à droite, puis cliquez pour surligner)</span></h3>
                    <div id="sourceTextContent" class="source-text-content">
                        </div>
                </div>
                <div class="annotation-box" id="summaryAnnotationBox"> 
                    <div class="annotation-header" style="cursor:default;"> 
                        <h4>Mon court résumé</h4> 
                        <button class="clear-btn" data-clear-target="summaryTextarea" title="Effacer le résumé">Effacer</button>
                    </div>
                    <textarea id="summaryTextarea" aria-label="Mon court résumé" placeholder="Écrivez votre court résumé ici..."></textarea>
                </div>
            </div>

            <div class="annotations-column"> 
                <div class="annotation-box" id="keywordsAnnotationBox">
                    <div class="annotation-header" id="keywordsHeader">
                        <h4>Mots-clés & Vocabulaire <span style="color: #3b82f6; font-size: 1.5em; vertical-align: middle;">•</span></h4>
                        <button class="clear-btn" data-clear-type="keywords" title="Effacer les mots-clés et le texte">Effacer</button>
                    </div>
                    <textarea id="keywordsTextarea" aria-label="Mots-clés et Vocabulaire" placeholder="Les mots-clés surlignés apparaîtront ici..."></textarea>
                </div>

                <div class="annotation-box" id="keyIdeasAnnotationBox">
                    <div class="annotation-header" id="keyIdeasHeader">
                        <h4>Idées Clés <span style="color: #16a34a; font-size: 1.5em; vertical-align: middle;">•</span></h4>
                        <button class="clear-btn" data-clear-type="ideas" title="Effacer les idées clés et le texte">Effacer</button>
                    </div>
                    <textarea id="keyIdeasTextarea" aria-label="Idées Clés" placeholder="Les idées clés (phrases) surlignées apparaîtront ici..."></textarea>
                </div>
            </div>
        </div> 
        <div class="global-action-buttons">
            <button id="saveAnnotationsBtn">Sauvegarder</button>
            <button id="loadAnnotationsBtn">Charger</button>
            <button id="copyAnnotationsBtn">Copier</button>
        </div>
        <div id="feedbackArea" role="status" aria-live="polite"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { 
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
             };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'student-annotation-ecosystems-fr-super-default';

        let app;
        let auth;
        let db;
        let userId = null; 
        let isAuthReady = false; 

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erreur d'initialisation Firebase:", error);
        }
        
        let currentMode = 'keywords'; 
        let sourceWords = []; 
        let sourcePhrases = []; 
        
        let highlightedKeywordIds = new Set(); 
        let highlightedIdeaIds = new Set();    

        const ecosystemTextParagraphs = [
            "Bonjour! Viens découvrir le monde très intéressant des écosystèmes. Ce sont des endroits dans la nature où les choses vivantes et non vivantes vivent ensemble et sont connectées. Pense à un écosystème comme à un quartier, qui peut être très grand comme un océan, ou petit comme une flaque d'eau. Dans chaque écosystème, il y a des parties vivantes, les éléments biotiques : les plantes, les animaux et les microorganismes (des êtres vivants très petits). Il y a aussi les éléments abiotiques, les choses non vivantes comme le soleil, l'eau, la terre, l'air et la température. Toutes ces parties sont liées. Les animaux mangent les plantes, les plantes ont besoin d'eau et de soleil. Quand ils meurent, des petites bêtes les décomposent et redonnent de la nourriture à la terre. C'est un grand cercle où tout le monde a besoin des autres.",
            "Sur la Terre, il y a beaucoup de sortes d'écosystèmes. Il y a les déserts (très secs), les régions arctiques (très froides), les prairies (avec beaucoup d'herbe), les terres humides (pleines d'eau), les forêts (pleines d'arbres) et les océans. Chaque endroit a son propre temps, sa taille, et ses plantes et animaux. Ces choses spéciales aident à dire combien de sortes de plantes et d'animaux différents peuvent vivre là. C'est ce qu'on appelle la biodiversité. Par exemple, dans les forêts chaudes et humides, il y a beaucoup plus de sortes d'animaux et de plantes que dans les déserts froids.",
            "Les écosystèmes sont aussi très importants pour notre planète. Les forêts et les terres humides, par exemple, aident à lutter contre les changements climatiques. Ils gardent les gaz à effet de serre pour qu'ils ne polluent pas l'air. On peut étudier ces endroits importants avec des loupes ou des appareils photo. Toi aussi, tu peux être un explorateur! Va voir dans un parc ou près d'un lac. Regarde les choses vivantes et non vivantes et pense à comment elles sont connectées. Si on comprend bien les écosystèmes et si on les protège, on aide toute notre planète."
        ];

        const sourceTextContentDiv = document.getElementById('sourceTextContent');
        const keywordsHeader = document.getElementById('keywordsHeader');
        const keyIdeasHeader = document.getElementById('keyIdeasHeader');
        const keywordsTextarea = document.getElementById('keywordsTextarea');
        const keyIdeasTextarea = document.getElementById('keyIdeasTextarea');
        const summaryTextarea = document.getElementById('summaryTextarea');
        const saveAnnotationsBtn = document.getElementById('saveAnnotationsBtn');
        const loadAnnotationsBtn = document.getElementById('loadAnnotationsBtn');
        const copyAnnotationsBtn = document.getElementById('copyAnnotationsBtn');
        const feedbackArea = document.getElementById('feedbackArea');
        const clearButtons = document.querySelectorAll('.clear-btn');

        function displayFeedback(message, isError = false) {
            if (!feedbackArea) return;
            feedbackArea.textContent = message;
            feedbackArea.className = isError ? 'error' : ''; 
             setTimeout(() => {
                if(feedbackArea) { 
                    feedbackArea.textContent = '';
                    feedbackArea.className = '';
                }
            }, 5000); 
        }
        
        function splitIntoSentences(paragraphText) {
            const sentences = paragraphText.match(/[^.!?…]+[.!?…]+\s*(?=[A-ZÀÂÄÈÉÊËÎÏÔŒÙÛÜŸÇ0-9]|$)|[^.!?…]+[.!?…]?$/g) || [paragraphText];
            return sentences.map(s => s.trim()).filter(s => s.length > 0);
        }

        // Regex to identify sequences of word characters (letters, accents, apostrophes, hyphens)
        const wordCharPattern = /^[a-zA-ZàâäèéêëîïôœùûüÿçÀÂÄÈÉÊËÎÏÔŒÙÛÜŸÇ'-]+$/;
        // Regex to split by sequences of non-word characters (delimiters), keeping the delimiters
        const delimiterSplitPattern = /([^a-zA-ZàâäèéêëîïôœùûüÿçÀÂÄÈÉÊËÎÏÔŒÙÛÜŸÇ'-]+)/g;

        function prepareTextData() {
            sourceWords = [];
            sourcePhrases = [];
            let globalWordId = 0;
            let globalPhraseIdCounter = 0;

            ecosystemTextParagraphs.forEach((paragraphText, pIndex) => {
                // Sentence splitting for "Key Ideas" mode (this part remains the same)
                const sentences = splitIntoSentences(paragraphText); 
                sentences.forEach((sentenceText, sIndex) => {
                    const phraseId = `phrase_${pIndex}_${sIndex}_${globalPhraseIdCounter++}`;
                    sourcePhrases.push({
                        id: phraseId,
                        text: sentenceText, 
                        paragraphIndex: pIndex, 
                        spanElement: null
                    });
                });

                // Word tokenization for "Keywords" mode
                const tokens = paragraphText.split(delimiterSplitPattern).filter(t => t && t.length > 0); 
                tokens.forEach(token => {
                    if (wordCharPattern.test(token)) { 
                        sourceWords.push({
                            id: globalWordId++,
                            text: token, 
                            paragraphIndex: pIndex,
                            spanElement: null,
                            originalText: token 
                        });
                    }
                });
            });
        }

        function loadInteractiveText() {
            if (!sourceTextContentDiv) return;
            sourceTextContentDiv.innerHTML = ''; 
            
            if (currentMode === 'keywords') {
                sourceWords.forEach(sw => sw.spanElement = null); 
                const singleWordContainer = document.createElement('div');
                ecosystemTextParagraphs.forEach((fullParagraphText, pIndex) => {
                    const displayTokens = fullParagraphText.split(delimiterSplitPattern).filter(t => t && t.length > 0);
                    displayTokens.forEach(token => {
                        if (wordCharPattern.test(token)) { 
                            const wordObj = sourceWords.find(sw => sw.originalText === token && 
                                                                 sw.paragraphIndex === pIndex && 
                                                                 !sw.spanElement);
                            if (wordObj) {
                                const span = document.createElement('span');
                                span.textContent = token; 
                                span.classList.add('word-span');
                                span.dataset.wordId = wordObj.id;
                                wordObj.spanElement = span; 
                                if (highlightedKeywordIds.has(wordObj.id)) {
                                    span.classList.add('highlight-keyword');
                                }
                                span.addEventListener('click', () => handleWordSpanClick(wordObj.id));
                                singleWordContainer.appendChild(span);
                            } else {
                                // This might happen if a word appears in text but not in sourceWords (e.g. due to normalization differences)
                                // Or if the same word instance is being sought multiple times without resetting spanElement logic properly for duplicates
                                singleWordContainer.appendChild(document.createTextNode(token)); 
                            }
                        } else { 
                            // This token is a delimiter (punctuation, spaces)
                            singleWordContainer.appendChild(document.createTextNode(token)); 
                        }
                    });
                    if (pIndex < ecosystemTextParagraphs.length - 1) {
                         singleWordContainer.appendChild(document.createTextNode(" ")); // Ensure space between joined paragraphs
                    }
                });
                sourceTextContentDiv.appendChild(singleWordContainer);

            } else if (currentMode === 'ideas') {
                sourcePhrases.forEach(sp => sp.spanElement = null); 
                const singlePhraseContainer = document.createElement('div'); 
                sourcePhrases.forEach(phraseObj => {
                    const span = document.createElement('span');
                    span.textContent = phraseObj.text + " "; 
                    span.classList.add('phrase-span');
                    span.dataset.phraseId = phraseObj.id;
                    phraseObj.spanElement = span; 
                    if (highlightedIdeaIds.has(phraseObj.id)) {
                        span.classList.add('highlight-idea');
                    }
                    span.addEventListener('click', () => handlePhraseSpanClick(phraseObj.id));
                    singlePhraseContainer.appendChild(span); 
                });
                sourceTextContentDiv.appendChild(singlePhraseContainer); 
            }
            updateAnnotationModeUIStyle(); 
        }
        
        function updateAnnotationModeUIStyle() {
            if (!sourceTextContentDiv) return;
            sourceTextContentDiv.classList.toggle('keywords-mode-active', currentMode === 'keywords');
            sourceTextContentDiv.classList.toggle('ideas-mode-active', currentMode === 'ideas');
        }

        function switchAnnotationMode(newMode) {
            if (currentMode === newMode && sourceTextContentDiv.hasChildNodes()) return; 
            currentMode = newMode;
            if(keywordsHeader) keywordsHeader.classList.toggle('active-mode', currentMode === 'keywords');
            if(keyIdeasHeader) keyIdeasHeader.classList.toggle('active-mode', currentMode === 'ideas');
            loadInteractiveText(); 
        }

        function handleWordSpanClick(wordId) {
            const wordObj = sourceWords.find(w => w.id === wordId);
            if (!wordObj || !wordObj.spanElement) return;

            if (highlightedKeywordIds.has(wordId)) {
                highlightedKeywordIds.delete(wordId);
                wordObj.spanElement.classList.remove('highlight-keyword');
            } else {
                highlightedKeywordIds.add(wordId);
                wordObj.spanElement.classList.add('highlight-keyword');
            }
            updateKeywordsTextarea();
        }

        function handlePhraseSpanClick(phraseId) {
            const phraseObj = sourcePhrases.find(p => p.id === phraseId);
            if (!phraseObj || !phraseObj.spanElement) return;

            if (highlightedIdeaIds.has(phraseId)) {
                highlightedIdeaIds.delete(phraseId);
                phraseObj.spanElement.classList.remove('highlight-idea');
            } else {
                highlightedIdeaIds.add(phraseId);
                phraseObj.spanElement.classList.add('highlight-idea');
            }
            updateKeyIdeasTextarea();
        }
        
        function updateKeywordsTextarea() {
            if (!keywordsTextarea) return;
            const sortedKeywordIds = Array.from(highlightedKeywordIds).sort((a,b) => a - b); 
            const keywords = sortedKeywordIds
                                .map(id => sourceWords.find(w => w.id === id)?.text)
                                .filter(Boolean); 
            keywordsTextarea.value = keywords.join(', ');
        }

        function updateKeyIdeasTextarea() {
            if (!keyIdeasTextarea) return;
            const sortedPhraseIds = Array.from(highlightedIdeaIds).sort((idA, idB) => {
                const phraseA = sourcePhrases.find(p => p.id === idA);
                const phraseB = sourcePhrases.find(p => p.id === idB);
                if (!phraseA || !phraseB) return 0;
                const numA = parseInt(phraseA.id.split('_').pop());
                const numB = parseInt(phraseB.id.split('_').pop());
                return numA - numB;
            });
            const ideas = sortedPhraseIds
                            .map(id => sourcePhrases.find(p => p.id === id)?.text)
                            .filter(Boolean);
            keyIdeasTextarea.value = ideas.join('\n---\n');
        }
        
        function clearAnnotations(type) {
            let type_fr = type;
            if (type === 'keywords') type_fr = 'Mots-clés';
            if (type === 'ideas') type_fr = 'Idées';
            if (type === 'summary') type_fr = 'Résumé';

            if (type === 'keywords') {
                highlightedKeywordIds.forEach(id => {
                    const wordObj = sourceWords.find(w => w.id === id);
                    if (wordObj && wordObj.spanElement) {
                        wordObj.spanElement.classList.remove('highlight-keyword');
                    }
                });
                highlightedKeywordIds.clear();
                updateKeywordsTextarea();
            } else if (type === 'ideas') {
                 highlightedIdeaIds.forEach(id => {
                    const phraseObj = sourcePhrases.find(p => p.id === id);
                    if (phraseObj && phraseObj.spanElement) {
                        phraseObj.spanElement.classList.remove('highlight-idea');
                    }
                });
                highlightedIdeaIds.clear();
                updateKeyIdeasTextarea();
            } else if (type === 'summary' && summaryTextarea) {
                summaryTextarea.value = '';
            }
            displayFeedback(`${type_fr} effacé(e)(s).`, false);
        }

        async function saveAnnotations() {
            if (!userId || !db) { displayFeedback("Impossible de sauvegarder : Problème Auth/BD.", true); return; }
            if (!appId) { displayFeedback("Impossible de sauvegarder : ID d'app manquant.", true); return; }

            const annotationsData = {
                keywords: Array.from(highlightedKeywordIds), 
                ideas: Array.from(highlightedIdeaIds),       
                summary: summaryTextarea ? summaryTextarea.value : '',
                lastSaved: serverTimestamp()
            };

            try {
                const docRef = doc(db, "artifacts", appId, "users", userId, "activity_data", "annotations");
                await setDoc(docRef, annotationsData);
                displayFeedback("Annotations sauvegardées avec succès !", false);
            } catch (error) {
                console.error("Erreur de sauvegarde:", error);
                displayFeedback("Erreur lors de la sauvegarde.", true);
            }
        }

        async function loadAnnotations() {
            if (!userId || !db) { displayFeedback("Impossible de charger : Problème Auth/BD.", true); return; }
            if (!appId) { displayFeedback("Impossible de charger : ID d'app manquant.", true); return; }

            try {
                const docRef = doc(db, "artifacts", appId, "users", userId, "activity_data", "annotations");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    highlightedKeywordIds = new Set(data.keywords || []);
                    highlightedIdeaIds = new Set(data.ideas || []);
                    if (summaryTextarea) summaryTextarea.value = data.summary || '';
                    
                    loadInteractiveText(); 
                    updateKeywordsTextarea(); 
                    updateKeyIdeasTextarea();
                    displayFeedback("Annotations chargées avec succès !", false);
                } else {
                    displayFeedback("Aucune annotation sauvegardée trouvée.", false);
                    clearAnnotations('keywords');
                    clearAnnotations('ideas');
                    clearAnnotations('summary');
                    loadInteractiveText();
                }
            } catch (error) {
                console.error("Erreur de chargement:", error);
                displayFeedback("Erreur lors du chargement.", true);
                loadInteractiveText();
            }
        }

        function copyAllAnnotationsToClipboard() {
            let textToCopy = "Annotations de l'étudiant:\n\n";

            if (keywordsTextarea && keywordsTextarea.value.trim() !== "") {
                textToCopy += "--- Mots-clés & Vocabulaire ---\n";
                textToCopy += keywordsTextarea.value.trim() + "\n\n";
            }

            if (keyIdeasTextarea && keyIdeasTextarea.value.trim() !== "") {
                textToCopy += "--- Idées Clés ---\n";
                textToCopy += keyIdeasTextarea.value.trim().replace(/\n---\n/g, "\n\n") + "\n\n";
            }

            if (summaryTextarea && summaryTextarea.value.trim() !== "") {
                textToCopy += "--- Mon Court Résumé ---\n";
                textToCopy += summaryTextarea.value.trim() + "\n";
            }
            
            if (textToCopy === "Annotations de l'étudiant:\n\n") {
                displayFeedback("Aucune annotation à copier.", true);
                return;
            }

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    displayFeedback('Annotations copiées dans le presse-papiers !', false); 
                } else {
                    displayFeedback('Échec de la copie des annotations.', true);
                }
            } catch (err) {
                console.error('Erreur de copie:', err);
                displayFeedback('Échec de la copie. Voir la console pour les détails.', true);
            }
            document.body.removeChild(tempTextArea);
        }
        
        if (keywordsHeader) {
            keywordsHeader.addEventListener('click', () => switchAnnotationMode('keywords'));
        }
        if (keyIdeasHeader) {
            keyIdeasHeader.addEventListener('click', () => switchAnnotationMode('ideas'));
        }

        clearButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const clearType = e.target.dataset.clearType;
                const clearTarget = e.target.dataset.clearTarget;
                if (clearType) {
                    clearAnnotations(clearType);
                } else if (clearTarget && document.getElementById(clearTarget)) {
                     document.getElementById(clearTarget).value = '';
                     if (clearTarget === 'summaryTextarea') clearAnnotations('summary'); 
                     displayFeedback("Résumé effacé.", false);
                }
            });
        });
        
        if (saveAnnotationsBtn) saveAnnotationsBtn.addEventListener('click', saveAnnotations);
        if (loadAnnotationsBtn) loadAnnotationsBtn.addEventListener('click', loadAnnotations);
        if (copyAnnotationsBtn) copyAnnotationsBtn.addEventListener('click', copyAllAnnotationsToClipboard);

        function initializeAppActivity() { 
            if (!isAuthReady) {
                console.log("Auth non prête pour initializeAppActivity");
                return;
            }
            
            prepareTextData(); 
            if(keywordsHeader) keywordsHeader.classList.toggle('active-mode', currentMode === 'keywords');
            if(keyIdeasHeader) keyIdeasHeader.classList.toggle('active-mode', currentMode === 'ideas');
            
            loadInteractiveText(); 
            loadAnnotations(); 
        }

        if (auth) {
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    if (!isAuthReady) { isAuthReady = true; initializeAppActivity(); }
                } else {
                    if (initialAuthToken && !auth.currentUser) {
                        try { await signInWithCustomToken(auth, initialAuthToken); } 
                        catch (error) { console.error("Erreur de connexion (jeton):", error); if (!auth.currentUser) trySignInAnonymously(); }
                    } else if (!auth.currentUser) {
                         trySignInAnonymously();
                    }
                }
            }, async (error) => { 
                console.error("Erreur d'état d'auth:", error);
                if (!auth.currentUser) trySignInAnonymously();
            });

            setTimeout(async () => {
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        try { await signInWithCustomToken(auth, initialAuthToken); }
                        catch (e) { if (!auth.currentUser) trySignInAnonymously(); }
                    } else {
                        if (!auth.currentUser) trySignInAnonymously();
                    }
                } else if (!isAuthReady) { 
                    userId = auth.currentUser.uid;
                    isAuthReady = true; 
                    initializeAppActivity();
                }
            }, 300);
        } else { 
            userId = 'local_user_' + crypto.randomUUID();
            isAuthReady = true; 
            initializeAppActivity();
        }

        async function trySignInAnonymously() {
            if (auth.currentUser) return; 
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Erreur de connexion (anonyme):", error);
                displayFeedback("Impossible d'authentifier l'utilisateur.", true);
                if (!userId) userId = 'fallback_anonyme_' + crypto.randomUUID(); 
                if (!isAuthReady) { 
                    isAuthReady = true; 
                    initializeAppActivity(); 
                }
            }
        }
    </script>
</body>
</html>
