<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set List Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Print Logic */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; color: black; }
            .print-black { color: black !important; }
            
            /* Default Print (CTRL+P): Show all sets in grid */
            .set-container { break-inside: avoid; border: 1px solid #ccc !important; box-shadow: none !important; margin-bottom: 20px; }
            .bg-gray-800 { background-color: white !important; color: black !important; }
            .text-gray-400 { color: #666 !important; }
            .text-green-400 { color: black !important; font-weight: bold; border-bottom: 2px solid #ccc; display: block; width: 100%; }
            .text-cyan-400 { color: black !important; font-weight: bold; }
            
            #song-bank-section, .tab-nav, header, #add-song-form { display: none !important; } 

            /* Single Set Print Mode */
            body.print-single-mode > :not(#print-area-wrapper) { display: none !important; }
            body.print-single-mode #print-area-wrapper { 
                display: block !important; 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
            }
            body.print-single-mode #print-area-wrapper .set-container {
                width: 100% !important;
                border: none !important;
            }
        }
        
        #print-area-wrapper { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans selection:bg-indigo-500 selection:text-white pb-20">

    <div class="container mx-auto max-w-6xl p-4 md:p-8">
        
        <!-- Header -->
        <header class="mb-6 text-center flex flex-col md:flex-row justify-between items-end border-b border-gray-700 pb-4 gap-4">
            <div class="text-left">
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Set List Creator</h1>
                <p class="text-gray-400 text-sm mt-1">4 Sets • Total Time: <span id="grand-total-time" class="text-white font-mono">0:00:00</span></p>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="downloadAllImage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg transition text-sm flex items-center gap-2 border border-indigo-500 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    Save All as Image
                </button>
                <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg transition text-sm flex items-center gap-2 border border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    Print All
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 flex space-x-1 bg-gray-800 p-1 rounded-xl no-print tab-nav">
            <button onclick="switchTab('christmas')" id="tab-christmas" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-white bg-gray-700 shadow">Christmas Party 2025</button>
            <button onclick="switchTab('custom')" id="tab-custom" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750">Create Your Own</button>
            <button onclick="switchTab('originals')" id="tab-originals" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750">Band Originals</button>
        </div>

        <!-- Input Section -->
        <div class="no-print bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
            <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4 border-b border-gray-700 pb-2">Add New / Custom Song</h3>
            <form id="add-song-form" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2" for="song-title">Song Title & Artist</label>
                    <input type="text" id="song-title" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition" placeholder="e.g. White Christmas - Bing Crosby" required>
                </div>
                <div class="w-full md:w-32">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2" for="song-duration">Time</label>
                    <input type="text" id="song-duration" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition text-center" placeholder="3:30">
                </div>
                <div class="w-full md:w-40">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2" for="target-set">Add To</label>
                    <select id="target-set" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition">
                        <option value="0">Set 1</option>
                        <option value="1">Set 2</option>
                        <option value="2">Set 3</option>
                        <option value="3">Set 4</option>
                    </select>
                </div>
                <button type="submit" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add
                </button>
            </form>
        </div>

        <!-- Sets Grid -->
        <div id="sets-capture-area" class="p-2 -m-2 bg-gray-900">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
                
                <!-- Set 1 -->
                <div id="set-container-0" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col">
                    <div class="p-4 bg-gray-750 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                        <h2 class="text-xl font-bold text-green-400">Set 1</h2>
                        <!-- Header populated in JS -->
                    </div>
                    <ul id="list-set-0" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow"></ul>
                </div>

                <!-- Set 2 -->
                <div id="set-container-1" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col">
                    <div class="p-4 bg-gray-750 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                        <h2 class="text-xl font-bold text-green-400">Set 2</h2>
                    </div>
                    <ul id="list-set-1" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow"></ul>
                </div>

                <!-- Set 3 -->
                <div id="set-container-2" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col">
                    <div class="p-4 bg-gray-750 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                        <h2 class="text-xl font-bold text-green-400">Set 3</h2>
                    </div>
                    <ul id="list-set-2" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow"></ul>
                </div>

                <!-- Set 4 -->
                <div id="set-container-3" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col">
                    <div class="p-4 bg-gray-750 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                        <h2 class="text-xl font-bold text-green-400">Set 4</h2>
                    </div>
                    <ul id="list-set-3" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow"></ul>
                </div>

            </div>
        </div>

        <!-- Master Song Bank -->
        <div id="song-bank-section" class="no-print bg-gray-900 border border-gray-700 rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 bg-gray-800 border-b border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-bold text-indigo-400 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                    Master Song Bank
                </h2>
                <div class="relative w-full md:w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <input type="text" id="bank-search" oninput="renderBank()" class="w-full bg-gray-900 text-white border border-gray-600 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:border-indigo-500 text-sm" placeholder="Search song bank...">
                </div>
            </div>
            
            <div class="p-6 bg-gray-850">
                <div id="bank-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Bank items render here -->
                </div>
            </div>
        </div>


        <div class="mt-8 text-center no-print">
            <button onclick="resetToDefault()" class="text-indigo-400 hover:text-indigo-300 text-sm underline transition mr-4">Reset Current Tab</button>
            <button onclick="clearAll()" class="text-red-400 hover:text-red-300 text-sm underline transition">Clear Current Tab</button>
        </div>

        <!-- Hidden Wrapper for Single Set Printing -->
        <div id="print-area-wrapper"></div>

    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2">
        <span id="toast-message">Action successful</span>
    </div>

    <script>
        // --- Data ---
        // 1. Christmas Data (Imported)
        const christmasData = [
            // Set 1
            [
                { title: "Cleopatra (The Lumineers)", durationStr: "0:00" },
                { title: "Island In The Sun (Weezer)", durationStr: "0:00" },
                { title: "Ahead By A Century (Tragically Hip)", durationStr: "0:00" },
                { title: "Blue Christmas (Elvis Presley)", durationStr: "0:00" },
                { title: "Dont Walk Away Eileen (Sam Roberts)", durationStr: "0:00" },
                { title: "A Little Something (Melissa Majeau)", durationStr: "0:00" },
                { title: "Green River (CCR)", durationStr: "0:00" },
                { title: "Flowers (Miley Cyrus)", durationStr: "0:00" },
                { title: "Dancing In The Dark (Bruce Springsteen)", durationStr: "0:00" },
                { title: "Blow At High Dough (Tragically Hip)", durationStr: "0:00" },
                { title: "ALL APOLOGIES (Nirvana)", durationStr: "0:00" },
                { title: "I Need Never Get Old (Nathaniel Rateliff)", durationStr: "0:00" },
                { title: "Santa Bring My Baby Back To Me (Elvis)", durationStr: "0:00" },
                { title: "Dreams (Fleetwood Mac)", durationStr: "0:00" },
                { title: "Folsom Prison Blues (Johnny Cash)", durationStr: "0:00" },
                { title: "My Babe (Willie Dixon)", durationStr: "0:00" },
                { title: "Harvest Moon (Neil Young)", durationStr: "0:00" },
                { title: "Jolene (Dolly Parton)", durationStr: "0:00" },
                { title: "Colors (Black Pumas)", durationStr: "0:00" },
                { title: "Fishin In The Dark", durationStr: "0:00" }
            ],
            // Set 2
            [
                { title: "SOMETHING IN THE ORANGE (Zach Bryan)", durationStr: "0:00" },
                { title: "Christmas (Baby Please Come Home)", durationStr: "0:00" },
                { title: "Don't Want to Wait (Darren Maltais)", durationStr: "0:00" },
                { title: "Blindman River (Melissa Majeau)", durationStr: "0:00" },
                { title: "I'm On Fire", durationStr: "0:00" },
                { title: "Those Days", durationStr: "0:00" },
                { title: "Jingle Bell Rock (Bobby Helms)", durationStr: "0:00" },
                { title: "Steal My Kisses (Ben Harper)", durationStr: "0:00" },
                { title: "Blank Space (Ryan Adams)", durationStr: "0:00" },
                { title: "Pride And Joy", durationStr: "0:00" },
                { title: "Tonight in Black and White (Jeff McLellan)", durationStr: "0:00" },
                { title: "No Diggity", durationStr: "0:00" },
                { title: "Santa Claus Is Coming To Town", durationStr: "0:00" },
                { title: "I Shot The Sheriff (Bob Marley)", durationStr: "0:00" },
                { title: "REAL LOVE BABY (Father John Misty)", durationStr: "0:00" },
                { title: "Five Dollar Bill (Corb Lund)", durationStr: "0:00" },
                { title: "American Girl (Tom Petty)", durationStr: "0:00" },
                { title: "Get Back (The Beatles)", durationStr: "0:00" },
                { title: "King Of The Road (Dean Martin/Roger Miller)", durationStr: "0:00" },
                { title: "Heart of Glass (Blondie)", durationStr: "0:00" },
                { title: "Johnny B Goode", durationStr: "0:00" },
                { title: "Zombie (The Cranberries)", durationStr: "0:00" },
                { title: "You Wreck Me (Tom Petty)", durationStr: "0:00" },
                { title: "Rhiannon (Fleetwood Mac)", durationStr: "0:00" },
                { title: "No Bright Light (Darren Maltais)", durationStr: "0:00" },
                { title: "Blister In The Sun (Violent Femmes)", durationStr: "0:00" }
            ],
            // Set 3
            [
                { title: "Cant Let Go", durationStr: "0:00" },
                { title: "Hand it over (Darren Maltais)", durationStr: "0:00" },
                { title: "Back To Black (Amy Winehouse)", durationStr: "0:00" },
                { title: "Thats All Right Mama (Beatles)", durationStr: "0:00" },
                { title: "Runaround Sue (Dion)", durationStr: "0:00" },
                { title: "You Cant Judge A Book By The Cover", durationStr: "0:00" },
                { title: "Paper Planes", durationStr: "0:00" },
                { title: "Blitzkrieg Bop (The Ramones)", durationStr: "0:00" },
                { title: "Day Tripper (The Beatles)", durationStr: "0:00" },
                { title: "Sob (Nathaniel Rateliff)", durationStr: "0:00" },
                { title: "Driving My Life Away (Eddie Rabbitt)", durationStr: "0:00" },
                { title: "Baby What You Want Me To Do", durationStr: "0:00" },
                { title: "Tennessee Whiskey (Chris Stapleton)", durationStr: "0:00" },
                { title: "Another Road Home (Jeff McLellan)", durationStr: "0:00" },
                { title: "Oh Boy (Buddy Holly)", durationStr: "0:00" },
                { title: "Life Of Sin", durationStr: "0:00" },
                { title: "Hungry Like The Wolf", durationStr: "0:00" },
                { title: "Beautiful things (Darren Maltais)", durationStr: "0:00" },
                { title: "Cry Me A River (Justin Timberlake)", durationStr: "0:00" },
                { title: "Still Falling (Jeff McLellan)", durationStr: "0:00" }
            ],
            // Set 4
            [
                { title: "Paranoid (Black Sabbath)", durationStr: "0:00" },
                { title: "Faith (Wham)", durationStr: "0:00" },
                { title: "Rocket Man (Elton John)", durationStr: "0:00" },
                { title: "Driving My Life Away (Reprise?)", durationStr: "0:00" },
                { title: "Norwegian Wood (The Beatles)", durationStr: "0:00" },
                { title: "Bottom Feeders (Melissa Majeau)", durationStr: "0:00" },
                { title: "Creep (Radiohead)", durationStr: "0:00" },
                { title: "What'd I Say (Ray Charles)", durationStr: "0:00" },
                { title: "Before Our Graves (Jeff McLellan)", durationStr: "0:00" },
                { title: "Long Ride (Melissa Majeau)", durationStr: "0:00" },
                { title: "It Takes a Lot to Laugh (Bob Dylan)", durationStr: "0:00" },
                { title: "The Thrill Is Gone (BB King)", durationStr: "0:00" },
                { title: "Flowers In Your Hair", durationStr: "0:00" }
            ]
        ];

        // 2. Band Originals Data (Filtered)
        const originalsData = [
            [], [], [], [] // 4 empty sets to fill
        ];

        const jeffSongs = ["Tonight in Black and White (Jeff McLellan)", "Still Fallin' (Jeff McLellan)", "Before Our Graves (Jeff McLellan)", "Another Road Home (Jeff McLellan)", "Havens to Hendrix (Jeff McLellan)", "Spark (Jeff McLellan)"];
        const melissaSongs = ["A Little Something (Melissa Majeau)", "Blindman River (Melissa Majeau)", "Bottom Feeders (Melissa Majeau)", "Long Ride (Melissa Majeau)", "No Denial (Melissa Majeau)", "Sugar Daddy (Melissa Majeau)"];
        const darrenSongs = ["No Bright Light (Darren Maltais)", "Hand it Over (Darren Maltais)", "Beautiful Things (Darren Maltais)", "Don't Want to Wait (Darren Maltais)", "A Simple Thing (Darren Maltais)", "Is Your Heart a Map (Darren Maltais)", "Just Another Number (Darren Maltais)", "Lonesome Grave (Darren Maltais)", "I Wonder (Darren Maltais)", "Memento (Darren Maltais)"];

        // Pre-populate Originals Tab
        originalsData[0] = jeffSongs.map(t => ({ title: t, durationStr: "0:00" }));
        originalsData[1] = melissaSongs.map(t => ({ title: t, durationStr: "0:00" }));
        originalsData[2] = darrenSongs.map(t => ({ title: t, durationStr: "0:00" }));

        // 3. Custom Data (Empty start)
        let customData = [[], [], [], []];

        // State Management
        let currentTab = 'christmas'; // 'christmas', 'custom', 'originals'
        let setCollections = {
            christmas: JSON.parse(JSON.stringify(christmasData)),
            custom: customData,
            originals: JSON.parse(JSON.stringify(originalsData))
        };

        // Load custom data from LocalStorage if available
        if(localStorage.getItem('myCustomSets')) {
            try {
                setCollections.custom = JSON.parse(localStorage.getItem('myCustomSets'));
            } catch(e) {
                console.error("Could not load saved sets");
            }
        }

        // The Master Bank List
        const rawBankData = [
            "A Little Something (Melissa Majeau)", "A Simple Thing (Darren Maltais)", "Ahead by a Century", "All Apologies", 
            "American Girl (Tom Petty)", "Another Road Home", "As It Was", "Auld Lang Syne", 
            "Baby It's Cold Outside", "Baby What You Want", "Baby What you Want me to Do?", "Back to Black", "Beautiful Things", 
            "Before our Graves", "Big Change", "Big River", "Blank Space (Ryan Adams)", "Blindman River", 
            "Blister in the Sun", "Blitzkrieg Bop", "Blow at High Dough", "Blue Christmas", 
            "Bobcaygeon", "Bottom Feeders", "Brown Eyed Girl", "Cadillac Ranch", "California Stars", 
            "Can't Let Go", "Christmas (Baby Please Come Home)", "Christmas All Over Again", "Cleopatra", "Cold Shot", 
            "Colors (The Black Pumas)", "Creep", "Cry Me a River", "Cry to Me", "Dancing in the Dark", 
            "Day Tripper", "Dirty Old Town", "Don't Walk Away Eileen", "Don't Want to Wait (Darren Maltais)", "Dreams", 
            "Drivin' my Life Away", "Faith", "Fishin' in the Dark", "Five Dollar Bill", "Flowers", 
            "Flowers in your Hair", "Folsom Prison Blues", "Galway Girl", "Get Back", "Green River", 
            "Guitar Town", "Hand it Over", "Hard Sun", "Harlem River Blues (JTE)", "Harvest Moon", 
            "Hasn't Hit Me Yet", "Havens to Hendrix (Jeff McLellan)", "Heart of Glass", "Here Comes Santa Claus", "Hey Ya", 
            "Holly Jolly Christmas", "Honey Bee (Tom Petty)", "Hungry Like the Wolf", "I Shot the Sheriff", "I Walk the Line", 
            "I Wonder (Darren Maltais)", "I'm on Fire", "Is Your Heart a Map (Darren Maltais)", "Island In The Sun", "It Takes a lot to Laugh", 
            "It's Beginning to Look a Lot Like Christmas", "Jambalaya", "Jingle Bell Rock", "Jingle Bells", "Johnny B. Goode", "Jolene", "Joy of my Life", 
            "Just Another Number (Darren Maltais)", "Just What I Needed", "KD and Lunch Meat (Boy Golden)", "Keep on Rockin in the Free World", 
            "Kill the Lights", "King of the Road", "Layla", "Learning to Fly", "Let it Snow", "Life of Sin", 
            "Little Lion Man", "Lonesome Grave (Darren Maltais)", "Long Ride", "Looking Out My Back Door", 
            "Lost Together (Blue Rodeo)", "Marshmallow World", "Mary Mac", "Mele Kalikimaka", "Memento (Darren Maltais)", "Midnight Rider", "My Babe", 
            "Need Never Get Old", "No Bright Light", "No Denial (Melissa Majeau)", "No Diggity", "Norwegian Wood", 
            "Oh Boy", "One Love", "Ophelia (The Band)", "Paper Planes", "Paranoid", "Pride and Joy", 
            "Real Love Baby", "Rhiannon", "Ring of Fire", "Rockin' Around the Christmas Tree", "Rocket Man", "Rudolph", "Runaround Sue", 
            "Santa Bring My Baby Back To Me", "Santa Claus Is Coming To Town", "Seven Nation Army", 
            "Silver Bells", "SOB", "So Many Days", "Something in the Orange", "Spark (Darren Maltais)", 
            "Steal My Kisses", "Still Fallin'", "Sugar Daddy (Melissa Majeau)", "Sunflower", "Tennessee Whiskey", 
            "That's Alright", "The Man Who Sold the World", "The One I Love (REM)", "The Thrill is Gone", 
            "The Weight", "Those Days", "Tonight in Black and White", "Too Sweet", "Valerie", 
            "Wagon Wheel", "What'd I say?", "When Doves Cry", "White Christmas", "Wild Rover", "Winter Wonderland", "You Can't Judge a Book", 
            "You Wreck Me", "Zombie"
        ];

        // Sort Bank Alphabetically
        const masterBank = rawBankData.sort();

        // --- Logic ---

        function switchTab(tabId) {
            currentTab = tabId;
            ['christmas', 'custom', 'originals'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tabId) {
                    btn.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-gray-750');
                    btn.classList.add('text-white', 'bg-gray-700', 'shadow');
                } else {
                    btn.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-gray-750');
                    btn.classList.remove('text-white', 'bg-gray-700', 'shadow');
                }
            });
            render();
            showToast(`Switched to ${document.getElementById(`tab-${tabId}`).innerText}`);
        }

        function saveCustomData() {
            if (currentTab === 'custom') {
                localStorage.setItem('myCustomSets', JSON.stringify(setCollections.custom));
            }
        }

        function timeToSeconds(str) {
            if(!str) return 0;
            const p = str.split(':').reverse();
            let s = 0;
            if(p[0]) s += parseInt(p[0]) || 0;
            if(p[1]) s += (parseInt(p[1]) || 0) * 60;
            if(p[2]) s += (parseInt(p[2]) || 0) * 3600;
            return s;
        }

        function secondsToTime(s) {
            const h = Math.floor(s/3600);
            const m = Math.floor((s%3600)/60);
            const sec = s%60;
            const secStr = sec.toString().padStart(2, '0');
            if(h > 0) {
                const mStr = m.toString().padStart(2, '0');
                return `${h}:${mStr}:${secStr}`;
            }
            return `${m}:${secStr}`;
        }

        function render() {
            let grandTotalSeconds = 0;
            const activeSets = setCollections[currentTab];

            for(let i=0; i<4; i++) {
                const container = document.getElementById(`set-container-${i}`);
                const listEl = document.getElementById(`list-set-${i}`);
                const setSongs = activeSets[i];
                
                // Clear and Rebuild Header
                const headerDiv = container.querySelector('.p-4');
                let title = `Set ${i+1}`;
                if(currentTab === 'originals') {
                    const titles = ["Jeff's Originals", "Melissa's Originals", "Darren's Originals", "Other / Unassigned"];
                    title = titles[i];
                }

                // Calculate Time
                let setSeconds = 0;
                setSongs.forEach(s => setSeconds += timeToSeconds(s.durationStr));
                grandTotalSeconds += setSeconds;

                headerDiv.innerHTML = `
                    <h2 class="text-xl font-bold text-green-400">${title}</h2>
                    <div class="flex items-center gap-3">
                        <span class="font-mono text-gray-400 bg-gray-900 px-2 py-1 rounded text-sm">${secondsToTime(setSeconds)}</span>
                        <div class="flex gap-1 no-print" data-html2canvas-ignore>
                            <button onclick="downloadSetImage(${i})" class="text-gray-400 hover:text-white p-1 hover:bg-gray-600 rounded" title="Save Image">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                            </button>
                            <button onclick="printSingleSet(${i})" class="text-gray-400 hover:text-white p-1 hover:bg-gray-600 rounded" title="Print Set">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            </button>
                        </div>
                    </div>
                `;
                
                listEl.innerHTML = '';

                if(setSongs.length === 0) {
                    listEl.innerHTML = `<li class="p-4 text-gray-500 text-center text-sm italic">Empty Set</li>`;
                } else {
                    setSongs.forEach((song, idx) => {
                        listEl.innerHTML += `
                            <li class="group flex items-center justify-between p-3 hover:bg-gray-750 transition border-l-4 border-transparent hover:border-indigo-500 bg-gray-800 odd:bg-gray-800 even:bg-gray-800/50">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <span class="text-gray-500 font-mono text-xs w-5 text-right no-print">${idx + 1}.</span>
                                    <div class="truncate pr-2">
                                        <div class="text-gray-200 text-sm md:text-base print-black truncate" title="${song.title}">${song.title}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <input type="text" 
                                        value="${song.durationStr === '0:00' ? '' : song.durationStr}" 
                                        placeholder="0:00"
                                        class="w-12 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none focus:text-white placeholder-gray-600 no-print"
                                        onchange="updateDuration(${i}, ${idx}, this.value)"
                                    >
                                    <span class="hidden print-block text-sm font-mono text-black">${song.durationStr}</span>
                                    
                                    <!-- Controls -->
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity no-print">
                                        <button onclick="moveSong(${i}, ${idx}, -1)" class="p-1 hover:text-white text-gray-500" ${idx === 0 ? 'disabled class="invisible"' : ''}>↑</button>
                                        <button onclick="moveSong(${i}, ${idx}, 1)" class="p-1 hover:text-white text-gray-500" ${idx === setSongs.length - 1 ? 'disabled class="invisible"' : ''}>↓</button>
                                        <button onclick="deleteSong(${i}, ${idx})" class="p-1 hover:text-red-400 text-gray-600">×</button>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                }
            }

            document.getElementById('grand-total-time').textContent = secondsToTime(grandTotalSeconds);
        }

        function renderBank() {
            const container = document.getElementById('bank-list');
            const searchVal = document.getElementById('bank-search').value.toLowerCase();
            const filtered = masterBank.filter(s => s.toLowerCase().includes(searchVal));

            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-span-3 text-center text-gray-500 py-4">No songs found</div>`;
                return;
            }

            container.innerHTML = filtered.map(song => `
                <div class="bg-gray-800 border border-gray-700 p-2 rounded flex justify-between items-center group hover:bg-gray-750">
                    <span class="text-sm text-gray-300 truncate mr-2" title="${song}">${song}</span>
                    <div class="flex gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
                        <button onclick="addFromBank('${song.replace(/'/g, "\\'")}', 0)" class="text-[10px] font-bold bg-gray-700 hover:bg-indigo-600 text-gray-300 hover:text-white w-5 h-5 rounded flex items-center justify-center transition" title="Add to Set 1">1</button>
                        <button onclick="addFromBank('${song.replace(/'/g, "\\'")}', 1)" class="text-[10px] font-bold bg-gray-700 hover:bg-indigo-600 text-gray-300 hover:text-white w-5 h-5 rounded flex items-center justify-center transition" title="Add to Set 2">2</button>
                        <button onclick="addFromBank('${song.replace(/'/g, "\\'")}', 2)" class="text-[10px] font-bold bg-gray-700 hover:bg-indigo-600 text-gray-300 hover:text-white w-5 h-5 rounded flex items-center justify-center transition" title="Add to Set 3">3</button>
                        <button onclick="addFromBank('${song.replace(/'/g, "\\'")}', 3)" class="text-[10px] font-bold bg-gray-700 hover:bg-indigo-600 text-gray-300 hover:text-white w-5 h-5 rounded flex items-center justify-center transition" title="Add to Set 4">4</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Actions ---
        const form = document.getElementById('add-song-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('song-title').value.trim();
            const duration = document.getElementById('song-duration').value.trim() || "0:00";
            const setIndex = parseInt(document.getElementById('target-set').value);
            setCollections[currentTab][setIndex].push({ title, durationStr: duration });
            saveCustomData();
            render();
            document.getElementById('song-title').value = '';
            document.getElementById('song-duration').value = '';
            showToast('Song Added to Set ' + (setIndex + 1));
        });

        function addFromBank(title, setIdx) {
            setCollections[currentTab][setIdx].push({ title: title, durationStr: "0:00" });
            saveCustomData();
            render();
            showToast(`${title} added to Set ${setIdx + 1}`);
        }

        function updateDuration(setIdx, songIdx, newVal) {
            let cleanVal = newVal.trim();
             if (cleanVal.length === 3 && !cleanVal.includes(':') && !isNaN(cleanVal)) {
                cleanVal = cleanVal.charAt(0) + ':' + cleanVal.substring(1);
            } else if (cleanVal.length === 4 && !cleanVal.includes(':') && !isNaN(cleanVal)) {
                cleanVal = cleanVal.substring(0,2) + ':' + cleanVal.substring(2);
            }
            setCollections[currentTab][setIdx][songIdx].durationStr = cleanVal || "0:00";
            saveCustomData();
            render();
        }

        function moveSong(setIdx, songIdx, direction) {
            const arr = setCollections[currentTab][setIdx];
            const newIdx = songIdx + direction;
            [arr[songIdx], arr[newIdx]] = [arr[newIdx], arr[songIdx]];
            saveCustomData();
            render();
        }

        function deleteSong(setIdx, songIdx) {
            setCollections[currentTab][setIdx].splice(songIdx, 1);
            saveCustomData();
            render();
        }

        function clearAll() {
            if(confirm("Clear all songs from the CURRENT tab?")) {
                setCollections[currentTab] = [[], [], [], []];
                saveCustomData();
                render();
            }
        }

        function resetToDefault() {
            if(confirm("Reset the CURRENT tab to its default state?")) {
                if(currentTab === 'christmas') setCollections.christmas = JSON.parse(JSON.stringify(christmasData));
                if(currentTab === 'custom') setCollections.custom = [[],[],[],[]];
                if(currentTab === 'originals') setCollections.originals = JSON.parse(JSON.stringify(originalsData));
                saveCustomData();
                render();
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function downloadAllImage() {
            window.scrollTo(0,0);
            const element = document.getElementById('sets-capture-area');
            showToast("Generating image...");
            html2canvas(element, { backgroundColor: "#111827", scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `setlist-full-${currentTab}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Image downloaded!");
            });
        }

        // --- Single Set Actions ---

        function downloadSetImage(index) {
            const element = document.getElementById(`set-container-${index}`);
            showToast("Processing image...");
            
            html2canvas(element, {
                scale: 2,
                backgroundColor: "#1f2937", // Matches bg-gray-800
                useCORS: true,
                windowHeight: document.documentElement.scrollHeight + 1500, // Ensure ample vertical space
                onclone: (clonedDoc) => {
                    const container = clonedDoc.getElementById(`set-container-${index}`);
                    const list = clonedDoc.getElementById(`list-set-${index}`);
                    
                    if (container) {
                        container.style.height = 'auto';
                        container.style.overflow = 'visible';
                        container.style.paddingBottom = '40px'; // Extra breathing room at bottom of container
                    }
                    if (list) {
                        list.style.maxHeight = 'none';
                        list.style.overflow = 'visible';
                    }

                    // Fix 1: Un-restrict all parents that might be hiding content
                    const overflowHidden = container.querySelectorAll('.overflow-hidden');
                    overflowHidden.forEach(el => {
                        el.style.overflow = 'visible';
                        el.style.height = 'auto';
                    });

                    // Fix 2: Relax text wrapping and add padding for descenders (g, j, p, q, y)
                    const textItems = container.querySelectorAll('.truncate');
                    textItems.forEach(el => {
                        el.style.whiteSpace = 'normal';       // Allow wrapping
                        el.style.overflow = 'visible';        // Show overflow
                        el.style.textOverflow = 'clip';       // No ellipses
                        el.style.lineHeight = '1.5';          // Increase line height
                        el.style.paddingBottom = '5px';       // Add padding for tails/descenders
                        el.style.display = 'block';           // Ensure padding takes effect
                    });
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `set-${index+1}-${currentTab}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Set saved!");
            }).catch(err => {
                console.error(err);
                showToast("Error generating image");
            });
        }

        function downloadAllImage() {
            window.scrollTo(0,0);
            const element = document.getElementById('sets-capture-area');
            showToast("Processing full image...");
            
            html2canvas(element, { 
                backgroundColor: "#111827", // Matches bg-gray-900
                scale: 2,
                windowHeight: document.documentElement.scrollHeight + 3000, 
                onclone: (clonedDoc) => {
                    // Expand ALL containers
                    const containers = clonedDoc.querySelectorAll('.set-container');
                    containers.forEach(container => {
                        container.style.height = 'auto';
                        container.style.overflow = 'visible';
                        container.style.marginBottom = '40px';
                    });

                    // Expand ALL lists
                    const lists = clonedDoc.querySelectorAll('ul[id^="list-set-"]');
                    lists.forEach(list => {
                        list.style.maxHeight = 'none';
                        list.style.overflow = 'visible';
                    });

                    // Unlock all overflow-hidden parents
                    const overflowHidden = clonedDoc.querySelectorAll('.overflow-hidden');
                    overflowHidden.forEach(el => {
                        el.style.overflow = 'visible';
                        el.style.height = 'auto';
                    });

                    // Fix text rendering for everything
                    const textItems = clonedDoc.querySelectorAll('.truncate');
                    textItems.forEach(el => {
                        el.style.whiteSpace = 'normal';
                        el.style.overflow = 'visible';
                        el.style.textOverflow = 'clip';
                        el.style.lineHeight = '1.5';
                        el.style.paddingBottom = '5px'; 
                        el.style.display = 'block';
                    });
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `setlist-full-${currentTab}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Image downloaded!");
            }).catch(err => {
                console.error(err);
                showToast("Error generating image");
            });
        }

        function printSingleSet(index) {
            // Get content
            const content = document.getElementById(`set-container-${index}`).innerHTML;
            const wrapper = document.getElementById('print-area-wrapper');
            
            // Re-wrap in a clean container for print
            wrapper.innerHTML = `
                <div class="set-container print-black border p-4 bg-white text-black">
                    ${content}
                </div>
            `;
            
            document.body.classList.add('print-single-mode');
            window.print();
            
            // Clean up immediately after print dialog closes/interacts
            // Using timeout as onafterprint isn't 100% reliable across all browsers for immediate cleanup
            setTimeout(() => {
                 document.body.classList.remove('print-single-mode');
                 wrapper.innerHTML = '';
            }, 1000);
        }

        // Init
        render();
        renderBank();

    </script>
</body>
</html>
