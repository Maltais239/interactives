<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Word Matching Game</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f7f4;
            color: #333;
            padding: 1rem; /* Use rem for responsive padding */
            box-sizing: border-box;
        }
        canvas {
            border: 2px solid #005f73;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            /* Responsive canvas styling */
            width: 100%;
            max-width: 800px;
            height: auto;
            aspect-ratio: 800 / 600;
        }
        #learned-words-container {
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }
        h2 {
            color: #005f73;
            text-align: center;
        }
        #learned-words-list {
            list-style-type: none;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
            columns: 4;
            -webkit-columns: 4;
            -moz-columns: 4;
        }
        #learned-words-list li {
            padding: 4px 12px;
            font-size: 14px;
        }
        /* Media query for smaller screens */
        @media (max-width: 600px) {
            #learned-words-list {
                columns: 2;
                -webkit-columns: 2;
                -moz-columns: 2;
            }
            body {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="learned-words-container">
        <h2>Learned Words (<span id="learned-count">0</span>)</h2>
        <ul id="learned-words-list">
        </ul>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const learnedWordsList = document.getElementById('learned-words-list');
        const learnedCountSpan = document.getElementById('learned-count');

        // --- Configuration & Styling ---
        const PALETTE = {
            background: '#ffffff',
            text: '#003049',
            card: '#eae2b7',
            cardHover: '#f77f00',
            cardSelected: '#0077b6',
            correct: '#2a9d8f',
            incorrect: '#e63946',
            reveal: '#ffb703',
            shadow: 'rgba(0,0,0,0.1)'
        };
        
        const ROUND_SIZE = 8;

        const MASTER_WORD_LIST = [
            // --- CORE VOCABULARY (with examples for sentence builder) ---
            { spanish: 'hola', english: 'hello', example: { spanish: ['Hola,', 'Â¿cÃ³mo', 'estÃ¡s?'], english: 'Hello, how are you?' } },
            { spanish: 'adiÃ³s', english: 'goodbye', example: { spanish: ['AdiÃ³s,', 'hasta', 'maÃ±ana.'], english: 'Goodbye, see you tomorrow.' } },
            { spanish: 'por favor', english: 'please', example: { spanish: ['Un', 'cafÃ©,', 'por', 'favor.'], english: 'A coffee, please.' } },
            { spanish: 'gracias', english: 'thank you', example: { spanish: ['Muchas', 'gracias', 'por', 'tu', 'ayuda.'], english: 'Thank you very much for your help.' } },
            { spanish: 'de nada', english: 'you\'re welcome', example: { spanish: ['De', 'nada,', 'fue', 'un', 'placer.'], english: 'You\'re welcome, it was a pleasure.' } },
            { spanish: 'sÃ­', english: 'yes', example: { spanish: ['SÃ­,', 'quiero', 'un', 'poco', 'mÃ¡s.'], english: 'Yes, I want a little more.' } },
            { spanish: 'no', english: 'no', example: { spanish: ['No,', 'gracias,', 'estoy', 'bien.'], english: 'No, thank you, I am fine.' } },
            { spanish: 'buenos dÃ­as', english: 'good morning', example: { spanish: ['Buenos', 'dÃ­as,', 'seÃ±or.'], english: 'Good morning, sir.' } },
            { spanish: 'buenas tardes', english: 'good afternoon', example: { spanish: ['Buenas', 'tardes,', 'Â¿en', 'quÃ©', 'puedo', 'ayudar?'], english: 'Good afternoon, how can I help?' } },
            { spanish: 'buenas noches', english: 'good night', example: { spanish: ['Buenas', 'noches,', 'que', 'descanses.'], english: 'Good night, have a good rest.' } },
            { spanish: 'Â¿cÃ³mo estÃ¡s?', english: 'how are you?', example: { spanish: ['Hola,', 'Â¿cÃ³mo', 'estÃ¡s', 'hoy?'], english: 'Hi, how are you today?' } },
            { spanish: 'muy bien', english: 'very well', example: { spanish: ['Estoy', 'muy', 'bien,', 'gracias.'], english: 'I am very well, thank you.' } },
            { spanish: 'la cuenta', english: 'the bill', example: { spanish: ['La', 'cuenta,', 'por', 'favor.'], english: 'The bill, please.' } },
            { spanish: 'una mesa', english: 'a table', example: { spanish: ['Una', 'mesa', 'para', 'dos,', 'por', 'favor.'], english: 'A table for two, please.' } },
            { spanish: 'el menÃº', english: 'the menu', example: { spanish: ['Â¿Puedo', 'ver', 'el', 'menÃº?'], english: 'Can I see the menu?' } },
            { spanish: 'quiero', english: 'I want', example: { spanish: ['Quiero', 'un', 'vaso', 'de', 'agua.'], english: 'I want a glass of water.' } },
            { spanish: 'para comer', english: 'to eat', example: { spanish: ['Â¿QuÃ©', 'hay', 'para', 'comer?'], english: 'What is there to eat?' } },
            { spanish: 'para beber', english: 'to drink', example: { spanish: ['Quiero', 'algo', 'para', 'beber.'], english: 'I want something to drink.' } },
            { spanish: 'agua', english: 'water', example: { spanish: ['Necesito', 'beber', 'mÃ¡s', 'agua.'], english: 'I need to drink more water.' } },
            { spanish: 'vino', english: 'wine', example: { spanish: ['Prefiero', 'el', 'vino', 'tinto.'], english: 'I prefer red wine.' } },
            { spanish: 'cerveza', english: 'beer', example: { spanish: ['Una', 'cerveza', 'frÃ­a,', 'por', 'favor.'], english: 'A cold beer, please.' } },
            { spanish: 'cafÃ©', english: 'coffee', example: { spanish: ['Me', 'gusta', 'el', 'cafÃ©', 'por', 'la', 'maÃ±ana.'], english: 'I like coffee in the morning.' } },
            { spanish: 'pollo', english: 'chicken', example: { spanish: ['Voy', 'a', 'pedir', 'el', 'pollo', 'asado.'], english: 'I am going to order the roasted chicken.' } },
            { spanish: 'pescado', english: 'fish', example: { spanish: ['El', 'pescado', 'es', 'muy', 'saludable.'], english: 'Fish is very healthy.' } },
            { spanish: 'ensalada', english: 'salad', example: { spanish: ['Una', 'ensalada', 'fresca', 'para', 'empezar.'], english: 'A fresh salad to start.' } },
            { spanish: 'postre', english: 'dessert', example: { spanish: ['Â¿QuÃ©', 'tienen', 'de', 'postre?'], english: 'What do you have for dessert?' } },
            { spanish: 'ser', english: 'to be (identity)', example: { spanish: ['Es', 'importante', 'ser', 'honesto.'], english: 'It is important to be honest.' } },
            { spanish: 'estar', english: 'to be (state)', example: { spanish: ['El', 'niÃ±o', 'estÃ¡', 'feliz.'], english: 'The boy is happy.' } },
            { spanish: 'tener', english: 'to have', example: { spanish: ['Tengo', 'dos', 'hermanos.'], english: 'I have two brothers.' } },
            { spanish: 'hacer', english: 'to do/make', example: { spanish: ['Voy', 'a', 'hacer', 'la', 'tarea.'], english: 'I am going to do the homework.' } },
            { spanish: 'ir', english: 'to go', example: { spanish: ['Vamos', 'a', 'ir', 'a', 'la', 'playa.'], english: 'We are going to go to the beach.' } },
            { spanish: 'ver', english: 'to see', example: { spanish: ['Â¿Puedes', 'ver', 'ese', 'pÃ¡jaro?'], english: 'Can you see that bird?' } },
            { spanish: 'comer', english: 'to eat', example: { spanish: ['Me', 'gusta', 'comer', 'pasta.'], english: 'I like to eat pasta.' } },
            { spanish: 'beber', english: 'to drink', example: { spanish: ['Es', 'bueno', 'beber', 'mucha', 'agua.'], english: 'It is good to drink a lot of water.' } },
            { spanish: 'hablar', english: 'to speak', example: { spanish: ['Ella', 'habla', 'tres', 'idiomas.'], english: 'She speaks three languages.' } },
            { spanish: 'necesitar', english: 'to need', example: { spanish: ['Necesito', 'ayuda', 'con', 'esto.'], english: 'I need help with this.' } },
            { spanish: 'comprar', english: 'to buy', example: { spanish: ['Voy', 'a', 'comprar', 'pan.'], english: 'I am going to buy bread.' } },
            { spanish: 'pagar', english: 'to pay', example: { spanish: ['Â¿Puedes', 'pagar', 'con', 'tarjeta?'], english: 'Can you pay with a card?' } },
            { spanish: 'vivir', english: 'to live', example: { spanish: ['Vivo', 'en', 'una', 'ciudad', 'grande.'], english: 'I live in a big city.' } },
            { spanish: 'escribir', english: 'to write', example: { spanish: ['Me', 'gusta', 'escribir', 'historias.'], english: 'I like to write stories.' } },
            { spanish: 'leer', english: 'to read', example: { spanish: ['Leo', 'un', 'libro', 'cada', 'semana.'], english: 'I read a book every week.' } },
            { spanish: 'saber', english: 'to know (facts)', example: { spanish: ['No', 'sÃ©', 'la', 'respuesta.'], english: 'I don\'t know the answer.' } },
            { spanish: 'querer', english: 'to want', example: { spanish: ['Quiero', 'viajar', 'por', 'el', 'mundo.'], english: 'I want to travel the world.' } },
            { spanish: 'poder', english: 'to be able', example: { spanish: ['Puedes', 'hacerlo', 'si', 'lo', 'intentas.'], english: 'You can do it if you try.' } },

            // --- EXPANDED VOCABULARY (no examples) ---
            { spanish: 'gente', english: 'people' }, { spanish: 'hombre', english: 'man' }, { spanish: 'mujer', english: 'woman' }, { spanish: 'niÃ±o/a', english: 'child' }, { spanish: 'padre', english: 'father' }, { spanish: 'madre', english: 'mother' }, { spanish: 'hermano/a', english: 'sibling' }, { spanish: 'abuelo/a', english: 'grandfather/grandmother' }, { spanish: 'amigo/a', english: 'friend' }, { spanish: 'mundo', english: 'world' }, { spanish: 'paÃ­s', english: 'country' }, { spanish: 'ciudad', english: 'city' }, { spanish: 'calle', english: 'street' }, { spanish: 'casa', english: 'house' }, { spanish: 'escuela', english: 'school' }, { spanish: 'tienda', english: 'store' }, { spanish: 'mercado', english: 'market' }, { spanish: 'restaurante', english: 'restaurant' }, { spanish: 'hotel', english: 'hotel' }, { spanish: 'hospital', english: 'hospital' }, { spanish: 'banco', english: 'bank' }, { spanish: 'iglesia', english: 'church' }, { spanish: 'parque', english: 'park' }, { spanish: 'playa', english: 'beach' }, { spanish: 'montaÃ±a', english: 'mountain' }, { spanish: 'comida', english: 'food' }, { spanish: 'pan', english: 'bread' }, { spanish: 'carne', english: 'meat' }, { spanish: 'queso', english: 'cheese' }, { spanish: 'fruta', english: 'fruit' }, { spanish: 'verdura', english: 'vegetable' }, { spanish: 'arroz', english: 'rice' }, { spanish: 'azÃºcar', english: 'sugar' }, { spanish: 'sal', english: 'salt' }, { spanish: 'leche', english: 'milk' }, { spanish: 'cuerpo', english: 'body' }, { spanish: 'cabeza', english: 'head' }, { spanish: 'ojo', english: 'eye' }, { spanish: 'nariz', english: 'nose' }, { spanish: 'boca', english: 'mouth' }, { spanish: 'mano', english: 'hand' }, { spanish: 'pie', english: 'foot' }, { spanish: 'corazÃ³n', english: 'heart' }, { spanish: 'tiempo', english: 'time/weather' }, { spanish: 'aÃ±o', english: 'year' }, { spanish: 'mes', english: 'month' }, { spanish: 'semana', english: 'week' }, { spanish: 'dÃ­a', english: 'day' }, { spanish: 'noche', english: 'night' }, { spanish: 'hora', english: 'hour' }, { spanish: 'minuto', english: 'minute' }, { spanish: 'segundo', english: 'second' }, { spanish: 'hoy', english: 'today' }, { spanish: 'maÃ±ana', english: 'tomorrow/morning' }, { spanish: 'ayer', english: 'yesterday' }, { spanish: 'vida', english: 'life' }, { spanish: 'amor', english: 'love' }, { spanish: 'paz', english: 'peace' }, { spanish: 'guerra', english: 'war' }, { spanish: 'idea', english: 'idea' }, { spanish: 'pregunta', english: 'question' }, { spanish: 'respuesta', english: 'answer' }, { spanish: 'problema', english: 'problem' }, { spanish: 'cosa', english: 'thing' }, { spanish: 'nombre', english: 'name' }, { spanish: 'dar', english: 'to give' }, { spanish: 'decir', english: 'to say/tell' }, { spanish: 'encontrar', english: 'to find' }, { spanish: 'pensar', english: 'to think' }, { spanish: 'sentir', english: 'to feel' }, { spanish: 'trabajar', english: 'to work' }, { spanish: 'jugar', english: 'to play' }, { spanish: 'dormir', english: 'to sleep' }, { spanish: 'despertar', english: 'to wake up' }, { spanish: 'caminar', english: 'to walk' }, { spanish: 'correr', english: 'to run' }, { spanish: 'mirar', english: 'to look/watch' }, { spanish: 'escuchar', english: 'to listen' }, { spanish: 'ayudar', english: 'to help' }, { spanish: 'cambiar', english: 'to change' }, { spanish: 'empezar', english: 'to begin/start' }, { spanish: 'terminar', english: 'to finish/end' }, { spanish: 'grande', english: 'big' }, { spanish: 'pequeÃ±o', english: 'small' }, { spanish: 'bueno', english: 'good' }, { spanish: 'malo', english: 'bad' }, { spanish: 'nuevo', english: 'new' }, { spanish: 'viejo', english: 'old' }, { spanish: 'joven', english: 'young' }, { spanish: 'feliz', english: 'happy' }, { spanish: 'triste', english: 'sad' }, { spanish: 'fÃ¡cil', english: 'easy' }, { spanish: 'difÃ­cil', english: 'difficult' }, { spanish: 'caliente', english: 'hot' }, { spanish: 'frÃ­o', english: 'cold' }, { spanish: 'bonito', english: 'pretty' }, { spanish: 'feo', english: 'ugly' }, { spanish: 'rico/a', english: 'rich/delicious' }, { spanish: 'pobre', english: 'poor' }, { spanish: 'importante', english: 'important' }, { spanish: 'interesante', english: 'interesting' }, { spanish: 'mismo/a', english: 'same' }, { spanish: 'diferente', english: 'different' }, { spanish: 'largo', english: 'long' }, { spanish: 'corto', english: 'short' }, { spanish: 'aquÃ­', english: 'here' }, { spanish: 'allÃ­', english: 'there' }, { spanish: 'ahora', english: 'now' }, { spanish: 'despuÃ©s', english: 'after' }, { spanish: 'antes', 'english': 'before' }, { 'spanish': 'siempre', 'english': 'always' }, { 'spanish': 'nunca', 'english': 'never' }, { 'spanish': 'muy', 'english': 'very' }, { 'spanish': 'mÃ¡s', 'english': 'more' }, { 'spanish': 'menos', 'english': 'less' }, { 'spanish': 'tambiÃ©n', 'english': 'also' }, { 'spanish': 'solo', 'english': 'only' }, { 'spanish': 'porque', 'english': 'because' }, { 'spanish': 'pero', 'english': 'but' }, { 'spanish': 'si', 'english': 'if' }, { 'spanish': 'con', 'english': 'with' }, { 'spanish': 'sin', 'english': 'without' }, { 'spanish': 'en', 'english': 'in/on' }, { 'spanish': 'a', 'english': 'to/at' }, { 'spanish': 'de', 'english': 'of/from' }, { 'spanish': 'por', 'english': 'for/by' }, { 'spanish': 'para', 'english': 'for/in order to' },
            { spanish: 'abrir', english: 'to open' }, { spanish: 'acabar', english: 'to finish' }, { spanish: 'aceptar', english: 'to accept' }, { spanish: 'alcanzar', english: 'to reach' }, { spanish: 'aparecer', english: 'to appear' }, { spanish: 'aprender', english: 'to learn' }, { spanish: 'asÃ­', english: 'like this/so' }, { spanish: 'aunque', english: 'although/even though' }, { spanish: 'bajo', english: 'under/low' }, { spanish: 'bastante', english: 'enough/quite' }, { spanish: 'caber', english: 'to fit' }, { spanish: 'caer', english: 'to fall' }, { spanish: 'casi', english: 'almost' }, { spanish: 'caso', english: 'case' }, { spanish: 'claro', english: 'clear/of course' }, { spanish: 'coger', english: 'to grab/take' }, { spanish: 'comenzar', english: 'to begin/start' }, { spanish: 'comprender', english: 'to understand' }, { spanish: 'conocer', english: 'to know (people/places)' }, { spanish: 'conseguir', english: 'to get/obtain' }, { spanish: 'considerar', english: 'to consider' }, { spanish: 'contar', english: 'to count/tell' }, { spanish: 'contestar', english: 'to answer' }, { spanish: 'continuar', english: 'to continue' }, { spanish: 'convertir', english: 'to convert/turn into' }, { spanish: 'crear', english: 'to create' }, { spanish: 'crecer', english: 'to grow' }, { spanish: 'creer', english: 'to believe' }, { spanish: 'cuando', english: 'when' }, { spanish: 'cuanto', english: 'how much/many' }, { spanish: 'cubrir', english: 'to cover' }, { spanish: 'cumplir', english: 'to fulfill/complete' }, { spanish: 'deber', english: 'should/must' }, { spanish: 'dejar', english: 'to leave/let' }, { spanish: 'demasiado', english: 'too much' }, { spanish: 'desde', english: 'from/since' }, { spanish: 'desear', english: 'to wish/desire' }, { spanish: 'descubrir', english: 'to discover' }, { spanish: 'dirigir', english: 'to direct/manage' }, { spanish: 'donde', english: 'where' }, { spanish: 'durante', english: 'during' }, { spanish: 'echar', english: 'to throw' }, { spanish: 'elegir', english: 'to choose/elect' }, { spanish: 'entender', english: 'to understand' }, { spanish: 'entonces', english: 'then/so' }, { spanish: 'entrar', english: 'to enter' }, { spanish: 'entre', english: 'between/among' }, { spanish: 'enviar', english: 'to send' }, { spanish: 'esperar', english: 'to wait/hope' }, { spanish: 'existir', english: 'to exist' }, { spanish: 'explicar', english: 'to explain' }, { spanish: 'falta', english: 'lack/absence' }, { spanish: 'formar', english: 'to form' }, { spanish: 'frente', english: 'front' }, { spanish: 'fuera', english: 'outside' }, { spanish: 'fuerza', english: 'strength/force' }, { spanish: 'ganar', english: 'to win/earn' }, { spanish: 'general', english: 'general' }, { spanish: 'gustar', english: 'to like' }, { spanish: 'haber', english: 'to have (auxiliary)' }, { spanish: 'hasta', english: 'until' }, { spanish: 'incluir', english: 'to include' }, { spanish: 'incluso', english: 'even/including' }, { spanish: 'intentar', english: 'to try/attempt' }, { spanish: 'junto', english: 'together' }, { spanish: 'lado', english: 'side' }, { spanish: 'lanzar', english: 'to throw/launch' }, { spanish: 'llegar', english: 'to arrive' }, { spanish: 'llevar', english: 'to carry/wear' }, { spanish: 'lograr', english: 'to achieve' }, { spanish: 'luego', english: 'then/later' }, { spanish: 'lugar', english: 'place' }, { spanish: 'llamar', english: 'to call' }, { spanish: 'mantener', english: 'to maintain' }, { spanish: 'mayor', english: 'older/bigger' }, { spanish: 'mejor', english: 'better' }, { spanish: 'menor', english: 'younger/smaller' }, { spanish: 'meter', english: 'to put in' }, { spanish: 'mientras', english: 'while' }, { spanish: 'morir', english: 'to die' }, { spanish: 'mostrar', english: 'to show' }, { spanish: 'mover', english: 'to move' }, { spanish: 'nacer', english: 'to be born' }, { spanish: 'nadie', english: 'nobody' }, { spanish: 'negar', english: 'to deny' }, { spanish: 'oÃ­r', english: 'to hear' }, { spanish: 'ofrecer', english: 'to offer' }, { spanish: 'olvidar', english: 'to forget' }, { spanish: 'parecer', english: 'to seem/appear' }, { spanish: 'partir', english: 'to leave/divide' }, { spanish: 'pasar', english: 'to pass/happen' }, { spanish: 'pedir', english: 'to ask for/order' }, { spanish: 'perder', english: 'to lose' }, { spanish: 'permitir', english: 'to permit/allow' }, { spanish: 'poco', english: 'little/few' }, { spanish: 'poner', english: 'to put/place' }, { spanish: 'preguntar', english: 'to ask' }, { spanish: 'presentar', english: 'to present/introduce' }, { spanish: 'producir', english: 'to produce' }, { spanish: 'quedar', english: 'to stay/remain' }, { spanish: 'quitar', english: 'to remove' }, { spanish: 'realmente', english: 'really/actually' }, { spanish: 'recibir', english: 'to receive' }, { spanish: 'reconocer', english: 'to recognize' }, { spanish: 'recordar', english: 'to remember' }, { spanish: 'resultar', english: 'to turn out/result' }, { spanish: 'sacar', english: 'to take out' }, { 'spanish': 'salir', 'english': 'to leave/go out' }, { 'spanish': 'seguir', 'english': 'to follow/continue' }, { 'spanish': 'segÃºn', 'english': 'according to' }, { 'spanish': 'seguro', 'english': 'sure/safe' }, { 'spanish': 'sentar', 'english': 'to sit' }, { 'spanish': 'servir', 'english': 'to serve' }, { 'spanish': 'sobre', 'english': 'on/about' }, { 'spanish': 'suponer', 'english': 'to suppose' }, { 'spanish': 'tan', 'english': 'so/as' }, { 'spanish': 'tanto', 'english': 'so much/many' }, { 'spanish': 'tarde', 'english': 'late/afternoon' }, { 'spanish': 'temprano', 'english': 'early' }, { 'spanish': 'tocar', 'english': 'to touch/play (instrument)' }, { 'spanish': 'tomar', 'english': 'to take/drink' }, { 'spanish': 'tratar', 'english': 'to treat/try' }, { 'spanish': 'Ãºltimo', 'english': 'last/final' }, { 'spanish': 'Ãºnico', 'english': 'unique/only' }, { 'spanish': 'usar', 'english': 'to use' }, { 'spanish': 'utilizar', 'english': 'to utilize/use' }, { 'spanish': 'valer', 'english': 'to be worth' }, { 'spanish': 'venir', 'english': 'to come' }, { 'spanish': 'verdad', 'english': 'truth' }, { 'spanish': 'vez', 'english': 'time (occasion)' }, { 'spanish': 'viajar', 'english': 'to travel' }, { 'spanish': 'volver', 'english': 'to return' },
            { spanish: 'color', english: 'color' }, { spanish: 'rojo', english: 'red' }, { spanish: 'verde', english: 'green' }, { spanish: 'azul', english: 'blue' }, { spanish: 'amarillo', english: 'yellow' }, { spanish: 'negro', english: 'black' }, { spanish: 'blanco', english: 'white' }, { spanish: 'marrÃ³n', english: 'brown' }, { spanish: 'gris', english: 'gray' }, { spanish: 'naranja', english: 'orange' }, { spanish: 'rosa', english: 'pink' }, { spanish: 'morado', english: 'purple' }, { spanish: 'ropa', english: 'clothing' }, { spanish: 'camisa', english: 'shirt' }, { spanish: 'pantalones', english: 'pants' }, { spanish: 'zapatos', english: 'shoes' }, { spanish: 'vestido', english: 'dress' }, { spanish: 'falda', english: 'skirt' }, { spanish: 'chaqueta', english: 'jacket' }, { spanish: 'sombrero', english: 'hat' }, { spanish: 'calcetines', english: 'socks' }, { spanish: 'cero', english: 'zero' }, { spanish: 'cuatro', english: 'four' }, { spanish: 'cinco', english: 'five' }, { spanish: 'seis', english: 'six' }, { spanish: 'siete', english: 'seven' }, { spanish: 'ocho', english: 'eight' }, { spanish: 'nueve', english: 'nine' }, { spanish: 'once', english: 'eleven' }, { spanish: 'doce', english: 'twelve' }, { spanish: 'trece', english: 'thirteen' }, { spanish: 'catorce', english: 'fourteen' }, { spanish: 'quince', english: 'fifteen' }, { spanish: 'veinte', english: 'twenty' }, { spanish: 'treinta', english: 'thirty' }, { spanish: 'cuarenta', english: 'forty' }, { spanish: 'cincuenta', english: 'fifty' }, { spanish: 'cien', english: 'one hundred' }, { spanish: 'mil', english: 'one thousand' }, { spanish: 'millÃ³n', english: 'million' }, { spanish: 'primero', english: 'first' }, { spanish: 'tercero', english: 'third' }, { spanish: 'lunes', english: 'Monday' }, { spanish: 'martes', english: 'Tuesday' }, { spanish: 'miÃ©rcoles', english: 'Wednesday' }, { spanish: 'jueves', english: 'Thursday' }, { spanish: 'viernes', english: 'Friday' }, { spanish: 'sÃ¡bado', english: 'Saturday' }, { spanish: 'domingo', english: 'Sunday' }, { spanish: 'enero', english: 'January' }, { spanish: 'febrero', english: 'February' }, { spanish: 'marzo', english: 'March' }, { spanish: 'abril', english: 'April' }, { spanish: 'mayo', english: 'May' }, { spanish: 'junio', english: 'June' }, { spanish: 'julio', english: 'July' }, { spanish: 'agosto', english: 'August' }, { spanish: 'septiembre', english: 'September' }, { spanish: 'octubre', english: 'October' }, { spanish: 'noviembre', english: 'November' }, { spanish: 'diciembre', english: 'December' }, { spanish: 'primavera', english: 'spring' }, { spanish: 'verano', english: 'summer' }, { spanish: 'otoÃ±o', english: 'autumn' }, { spanish: 'invierno', english: 'winter' }, { spanish: 'norte', english: 'north' }, { spanish: 'sur', english: 'south' }, { spanish: 'este', english: 'east' }, { spanish: 'oeste', english: 'west' }
        ];
        
        let gameState = {
            score: 0,
            round: 1,
            totalLearned: new Set(),
            currentWords: [],
            cards: [],
            speakerButtons: [],
            dontKnowButtons: [],
            roundUnknowns: [],
            isReviewingSentences: false,
            isPracticingSentences: false,
            practice: {},
            review: {},
            selectedSpanish: null,
            selectedEnglish: null,
            feedback: null,
            isRoundOver: false,
            isGameOver: false,
            mouse: { x: 0, y: 0 },
            buttons: {}
        };

        // --- Utility Functions ---
        function speak(text, lang = 'es-ES') {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                window.speechSynthesis.speak(utterance);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getUnusedWords(count) {
            const unused = MASTER_WORD_LIST.filter(word => !gameState.totalLearned.has(word.spanish));
            // **FIX**: No longer shuffling the main list to preserve logical order.
            // Shuffling happens in startRound if needed.
            return unused.slice(0, count);
        }
        
        function drawRoundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }

        function isMouseOver(mouse, rect) {
            if (!rect) return false;
            // **FIX for responsiveness**: Use scaled mouse coordinates
            const scaledMouse = getScaledMousePos(mouse);
            return scaledMouse.x > rect.x && scaledMouse.x < rect.x + rect.width && scaledMouse.y > rect.y && scaledMouse.y < rect.y + rect.height;
        }

        function isMouseOverCircle(mouse, circle) {
            if (!circle) return false;
            // **FIX for responsiveness**: Use scaled mouse coordinates
            const scaledMouse = getScaledMousePos(mouse);
            const dx = scaledMouse.x - circle.x;
            const dy = scaledMouse.y - circle.y;
            return Math.sqrt(dx*dx + dy*dy) < circle.radius;
        }

        function getScaledMousePos(mouse) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (mouse.x - rect.left) * scaleX,
                y: (mouse.y - rect.top) * scaleY
            };
        }


        function resetGame() {
            gameState.isGameOver = false;
            gameState.isRoundOver = false;
            if(learnedWordsList) learnedWordsList.innerHTML = '';
            if(learnedCountSpan) learnedCountSpan.textContent = 0;
            gameState.totalLearned.clear();
            gameState.score = 0;
            gameState.round = 1;
            gameState.feedback = null;
            gameState.buttons = {};
        }

        // --- Game Logic ---
        function startRound() {
            gameState.currentWords = getUnusedWords(ROUND_SIZE);
            if (gameState.currentWords.length === 0) {
                 gameState.isGameOver = true;
                 return;
            }
            const shuffledEnglish = gameState.currentWords.map(w => ({ english: w.english, spanish: w.spanish }));
            shuffleArray(shuffledEnglish);
            
            gameState.isRoundOver = false;
            gameState.isReviewingSentences = false;
            gameState.isPracticingSentences = false;
            gameState.roundUnknowns = [];
            gameState.cards = [];
            gameState.dontKnowButtons = [];
            gameState.speakerButtons = [];
            gameState.selectedSpanish = null;
            gameState.selectedEnglish = null;
            gameState.feedback = null;
            
            const cardWidth = 250;
            const cardHeight = 50;
            const y_start = 120;
            const y_step = (canvas.height - y_start - 50) / ROUND_SIZE;
            const spanish_x = canvas.width / 4 - cardWidth / 2 - 20; // Shift left for buttons
            const english_x = (canvas.width * 3) / 4 - cardWidth / 2;

            for(let i = 0; i < gameState.currentWords.length; i++) {
                const spanishCard = { type: 'spanish', word: gameState.currentWords[i].spanish, x: spanish_x, y: y_start + i * y_step, width: cardWidth, height: cardHeight, matched: false, shake: 0 };
                gameState.cards.push(spanishCard);
                const englishCard = { type: 'english', word: shuffledEnglish[i].english, x: english_x, y: y_start + i * y_step, width: cardWidth, height: cardHeight, matched: false, shake: 0 };
                gameState.cards.push(englishCard);
                const buttonRadius = 12;
                const dkBtnX = spanish_x + cardWidth + 20;
                const speakerBtnX = dkBtnX + 30;
                const buttonY = spanishCard.y + cardHeight / 2;
                gameState.dontKnowButtons.push({ x: dkBtnX, y: buttonY, radius: buttonRadius, spanishCard: spanishCard });
                gameState.speakerButtons.push({ x: speakerBtnX, y: buttonY, radius: buttonRadius, word: spanishCard.word });
            }
        }
        
        function handleRoundEnd() {
            if (gameState.cards.every(c => c.matched)) {
                // Filter for unknowns that actually have sentences to review
                const unknownsWithExamples = gameState.roundUnknowns.filter(w => w.example);
                if (unknownsWithExamples.length > 0) {
                    gameState.isReviewingSentences = true;
                    setupSentenceScramble(gameState.review, unknownsWithExamples);
                } else {
                    gameState.isRoundOver = true;
                }
               if (getUnusedWords(1).length === 0) gameState.isGameOver = true;
            }
        }
        
        function setupSentenceScramble(stateObject, wordList) {
            stateObject.step = stateObject.step || 0;
            const wordToReview = wordList[stateObject.step];
            
            if(!wordToReview || !wordToReview.example) {
                // If no more words to review, or word has no example, end review
                if (gameState.isReviewingSentences) {
                    gameState.isReviewingSentences = false;
                    gameState.isRoundOver = true;
                } else if(gameState.isPracticingSentences) {
                    stateObject.feedback = 'no_sentences';
                }
                return;
            }

            stateObject.currentWord = wordToReview;
            stateObject.correctSentence = wordToReview.example.spanish;
            stateObject.scrambled = [...wordToReview.example.spanish].map(word => ({ word, rect: null }));
            shuffleArray(stateObject.scrambled);
            
            stateObject.built = [];
            stateObject.feedback = null;
        }
        
        // --- Drawing ---
        function gameLoop() {
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = PALETTE.background;
            ctx.fillRect(0,0,canvas.width, canvas.height);

            if (gameState.isReviewingSentences) {
                drawSentenceBuilder("Review Sentences", gameState.review, gameState.roundUnknowns.filter(w => w.example));
                return;
            }
            if(gameState.isPracticingSentences) {
                drawSentenceBuilder("Practice Sentences", gameState.practice);
                return;
            }

            // --- Main Game Screen ---
            ctx.fillStyle = PALETTE.text;
            ctx.font = "bold 32px 'Segoe UI'";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("Spanish Word Matching", canvas.width / 2, 50);
            
            const practiceBtn = {x: canvas.width - 200, y: 35, width: 180, height: 40};
            gameState.buttons.practice = practiceBtn;
            ctx.fillStyle = isMouseOver(gameState.mouse, practiceBtn) ? PALETTE.cardHover : PALETTE.card;
            drawRoundRect(ctx, practiceBtn.x, practiceBtn.y, practiceBtn.width, practiceBtn.height, 8);
            ctx.fillStyle = PALETTE.text;
            ctx.font = "18px 'Segoe UI'";
            ctx.fillText("Practice Sentences", practiceBtn.x + practiceBtn.width/2, practiceBtn.y + practiceBtn.height/2);

            ctx.fillStyle = '#666';
            const correctInRound = gameState.cards.filter(c => c.type === 'spanish' && c.matched).length;
            ctx.fillText(`Round: ${gameState.round} | Score: ${correctInRound} / ${ROUND_SIZE}`, canvas.width / 2, 90);

            // Cards
            gameState.cards.forEach(card => {
                if (card.matched) return;
                let x = card.x;
                if(card.shake > 0) { x += Math.sin(card.shake * Math.PI) * 5; card.shake--; }
                
                const isHovered = isMouseOver(gameState.mouse, card);
                ctx.shadowColor = PALETTE.shadow;
                ctx.shadowBlur = isHovered ? 15 : 5;
                ctx.shadowOffsetY = isHovered ? 8 : 4;
                
                ctx.fillStyle = PALETTE.card;
                if (gameState.selectedSpanish === card || gameState.selectedEnglish === card) ctx.fillStyle = PALETTE.cardSelected;
                if (gameState.feedback && gameState.feedback.cards.includes(card)) ctx.fillStyle = PALETTE[gameState.feedback.type];
                drawRoundRect(ctx, x, card.y, card.width, card.height, 10);
                
                ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;

                ctx.fillStyle = (gameState.selectedSpanish === card || gameState.selectedEnglish === card || (gameState.feedback && gameState.feedback.cards.includes(card))) ? '#FFF' : PALETTE.text;
                ctx.font = "20px 'Segoe UI'";
                ctx.fillText(card.word, x + card.width / 2, card.y + card.height / 2);
            });
            
            // Buttons next to Spanish cards
            gameState.dontKnowButtons.forEach((button, i) => {
                if (button.spanishCard.matched) return;
                const speakerBtn = gameState.speakerButtons[i];

                // "?" button
                let isHovered = isMouseOverCircle(gameState.mouse, button);
                ctx.fillStyle = isHovered ? PALETTE.cardHover : PALETTE.text;
                ctx.beginPath(); ctx.arc(button.x, button.y, button.radius, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = PALETTE.background; ctx.font = "bold 18px 'Segoe UI'";
                ctx.fillText("?", button.x, button.y + 1);

                // Speaker button
                isHovered = isMouseOverCircle(gameState.mouse, speakerBtn);
                ctx.fillStyle = isHovered ? PALETTE.cardHover : PALETTE.text;
                ctx.beginPath(); ctx.arc(speakerBtn.x, speakerBtn.y, speakerBtn.radius, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = PALETTE.background; ctx.font = "bold 16px 'Segoe UI'";
                ctx.fillText("ðŸ”Š", speakerBtn.x, speakerBtn.y + 1);
            });

            if (gameState.isRoundOver && !gameState.isGameOver) drawOverlay("Round Complete!", "Next Round");
            if (gameState.isGameOver) drawOverlay("All Words Learned!", "Play Again");
        }
        
        function drawSentenceBuilder(title, stateObject) {
            const wordToReview = stateObject.currentWord;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = "bold 36px 'Segoe UI'";
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(title, canvas.width / 2, 60);

            // Exit button for practice mode
            if(gameState.isPracticingSentences) {
                const exitBtn = {x: canvas.width - 120, y: 45, width: 100, height: 40};
                gameState.buttons.exit = exitBtn;
                ctx.fillStyle = isMouseOver(gameState.mouse, exitBtn) ? PALETTE.incorrect : '#888';
                drawRoundRect(ctx, exitBtn.x, exitBtn.y, exitBtn.width, exitBtn.height, 8);
                ctx.fillStyle = 'white'; ctx.font = "bold 20px 'Segoe UI'";
                ctx.fillText("Exit", exitBtn.x + exitBtn.width/2, exitBtn.y + exitBtn.height/2);
            }

            if(stateObject.feedback === 'no_sentences') {
                ctx.fillStyle = '#ccc';
                ctx.font = "24px 'Segoe UI'";
                ctx.fillText("Learn more words to practice building sentences!", canvas.width / 2, canvas.height/2);
                return;
            }

            // English Prompt & Speaker
            ctx.fillStyle = '#ccc';
            ctx.font = "italic 22px 'Segoe UI'";
            ctx.textAlign = 'center';
            ctx.fillText(wordToReview.example.english, canvas.width / 2, 140);

            const speakerBtn = {x: 50, y: 140, radius: 15, sentence: stateObject.correctSentence.join(' ') };
            gameState.buttons.sentenceSpeaker = speakerBtn;
            let isHovered = isMouseOverCircle(gameState.mouse, speakerBtn);
            ctx.fillStyle = isHovered ? PALETTE.cardHover : PALETTE.text;
            ctx.beginPath(); ctx.arc(speakerBtn.x, speakerBtn.y, speakerBtn.radius, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = "bold 20px 'Segoe UI'";
            ctx.fillText("ðŸ”Š", speakerBtn.x, speakerBtn.y + 1);

            
            // Built Sentence Area
            const builtY = 220;
            ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.setLineDash([5, 10]);
            ctx.strokeRect(50, builtY - 35, canvas.width - 100, 70); ctx.setLineDash([]);
            
            let currentX = 60;
            ctx.font = "bold 24px 'Segoe UI'";
            stateObject.built.forEach(wordObj => {
                const metrics = ctx.measureText(wordObj.word);
                wordObj.rect = { x: currentX, y: builtY - 25, width: metrics.width + 20, height: 50 };
                ctx.fillStyle = PALETTE.cardSelected;
                if (stateObject.feedback) ctx.fillStyle = PALETTE[stateObject.feedback];
                drawRoundRect(ctx, wordObj.rect.x, wordObj.rect.y, wordObj.rect.width, wordObj.rect.height, 8);
                ctx.fillStyle = 'white'; ctx.fillText(wordObj.word, currentX + wordObj.rect.width/2, builtY);
                currentX += wordObj.rect.width + 10;
            });
            
            // Scrambled Word Bank
            const bankY = 350;
            ctx.font = "bold 24px 'Segoe UI'";
            const totalWidth = stateObject.scrambled.reduce((acc, w) => acc + ctx.measureText(w.word).width + 30, -10);
            currentX = (canvas.width - totalWidth) / 2;
            stateObject.scrambled.forEach(wordObj => {
                const metrics = ctx.measureText(wordObj.word);
                wordObj.rect = { x: currentX, y: bankY - 25, width: metrics.width + 20, height: 50 };
                isHovered = isMouseOver(gameState.mouse, wordObj.rect);
                ctx.fillStyle = isHovered ? PALETTE.cardHover : PALETTE.card;
                drawRoundRect(ctx, wordObj.rect.x, wordObj.rect.y, wordObj.rect.width, wordObj.rect.height, 8);
                ctx.fillStyle = PALETTE.text; ctx.fillText(wordObj.word, currentX + wordObj.rect.width/2, bankY);
                currentX += wordObj.rect.width + 10;
            });

            // Buttons (Check / Next)
            const btn = { x: canvas.width / 2 - 100, y: canvas.height - 80, width: 200, height: 50 };
            gameState.buttons.main = btn;
            let buttonText = "";
            let canClick = false;

            if (stateObject.feedback === 'correct') {
                buttonText = gameState.isPracticingSentences ? "Next Sentence" : "Continue";
                canClick = true;
            } else if (stateObject.built.length === stateObject.correctSentence.length) {
                buttonText = "Check";
                canClick = true;
            }

            if(canClick){
                ctx.fillStyle = isMouseOver(gameState.mouse, btn) ? PALETTE.cardHover : PALETTE.card;
                drawRoundRect(ctx, btn.x, btn.y, btn.width, btn.height, 10);
                ctx.fillStyle = PALETTE.text; ctx.font = "bold 24px 'Segoe UI'";
                ctx.fillText(buttonText, canvas.width / 2, btn.y + btn.height / 2 + 3);
            }
        }

        // --- Event Handling & Logic ---
        function checkMatch() {
            if (gameState.selectedSpanish === null || gameState.selectedEnglish === null) return;
            const spanishCard = gameState.selectedSpanish, englishCard = gameState.selectedEnglish;
            const spanishWordObj = MASTER_WORD_LIST.find(w => w.spanish === spanishCard.word);

            if (spanishWordObj && spanishWordObj.english === englishCard.word) {
                gameState.feedback = { type: 'correct', cards: [spanishCard, englishCard] };
                setTimeout(() => {
                    spanishCard.matched = true; englishCard.matched = true;
                    if (!gameState.totalLearned.has(spanishWordObj.spanish)) {
                        gameState.totalLearned.add(spanishWordObj.spanish);
                        updateLearnedList(spanishWordObj);
                    }
                    gameState.score++;
                    gameState.selectedSpanish = null; gameState.selectedEnglish = null; gameState.feedback = null;
                    handleRoundEnd();
                }, 500);
            } else {
                gameState.feedback = { type: 'incorrect', cards: [spanishCard, englishCard] };
                spanishCard.shake = 15; englishCard.shake = 15;
                setTimeout(() => {
                    gameState.selectedSpanish = null; gameState.selectedEnglish = null; gameState.feedback = null;
                }, 700);
            }
        }
        
        function revealAnswer(spanishCard) {
            const spanishWordObj = MASTER_WORD_LIST.find(w => w.spanish === spanishCard.word);
            if (!spanishWordObj) return;
            const englishCard = gameState.cards.find(c => c.type === 'english' && c.word === spanishWordObj.english && !c.matched);
            if (!englishCard) return;
            if(!gameState.roundUnknowns.find(w => w.spanish === spanishWordObj.spanish)) gameState.roundUnknowns.push(spanishWordObj);
            gameState.feedback = { type: 'reveal', cards: [spanishCard, englishCard] };
            setTimeout(() => {
                spanishCard.matched = true; englishCard.matched = true;
                gameState.selectedSpanish = null; gameState.selectedEnglish = null; gameState.feedback = null;
                handleRoundEnd();
            }, 800);
        }
        
        function handleSentenceBuilderClick(mouse, stateObject, wordList) {
            const scrambledClicked = stateObject.scrambled.find(w => isMouseOver(mouse, w.rect));
            if (scrambledClicked && stateObject.feedback !== 'correct') {
                stateObject.built.push(scrambledClicked);
                stateObject.scrambled = stateObject.scrambled.filter(w => w !== scrambledClicked);
                stateObject.feedback = null; return;
            }
            const builtClicked = stateObject.built.find(w => isMouseOver(mouse, w.rect));
            if (builtClicked && stateObject.feedback !== 'correct') {
                stateObject.scrambled.push(builtClicked);
                stateObject.built = stateObject.built.filter(w => w !== builtClicked);
                stateObject.feedback = null; return;
            }
            if(isMouseOver(mouse, gameState.buttons.main)) {
                if (stateObject.feedback === 'correct') { // "Next" or "Continue"
                    stateObject.step++;
                    if (wordList && stateObject.step >= wordList.length) {
                         gameState.isReviewingSentences = false; gameState.isRoundOver = true;
                    } else if (gameState.isPracticingSentences) {
                        const learnedWords = MASTER_WORD_LIST.filter(w => gameState.totalLearned.has(w.spanish) && w.example);
                        shuffleArray(learnedWords);
                        setupSentenceScramble(gameState.practice, learnedWords);
                    } else {
                        setupSentenceScramble(stateObject, wordList);
                    }
                } else if (stateObject.built.length === stateObject.correctSentence.length) { // "Check"
                    const builtString = stateObject.built.map(w => w.word).join(' ');
                    const correctString = stateObject.correctSentence.join(' ');
                    stateObject.feedback = builtString === correctString ? 'correct' : 'incorrect';
                }
            }
            if(gameState.buttons.sentenceSpeaker && isMouseOverCircle(mouse, gameState.buttons.sentenceSpeaker)) {
                speak(gameState.buttons.sentenceSpeaker.sentence);
            }
            if(gameState.buttons.exit && isMouseOver(mouse, gameState.buttons.exit)) {
                gameState.isPracticingSentences = false;
            }
        }

        function drawOverlay(title, buttonText) { /* Draws overlays like "Round Complete" */
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white'; ctx.font = "bold 48px 'Segoe UI'";
            ctx.textAlign = 'center'; ctx.textBaseline = "middle";
            ctx.fillText(title, canvas.width / 2, canvas.height / 2 - 50);
            const btn = { x: canvas.width / 2 - 100, y: canvas.height / 2 + 20, width: 200, height: 50 };
            gameState.buttons.main = btn;
            ctx.fillStyle = isMouseOver(gameState.mouse, btn) ? PALETTE.cardHover : PALETTE.card;
            drawRoundRect(ctx, btn.x, btn.y, btn.width, btn.height, 10);
            ctx.fillStyle = PALETTE.text; ctx.font = "bold 24px 'Segoe UI'";
            ctx.fillText(buttonText, canvas.width / 2, btn.y + btn.height / 2 + 3);
        }

        function updateLearnedList(wordObj) { /* Updates the HTML list below canvas */
            const li = document.createElement('li'); li.textContent = wordObj.spanish;
            learnedWordsList.appendChild(li); learnedWordsList.scrollTop = learnedWordsList.scrollHeight;
            learnedCountSpan.textContent = gameState.totalLearned.size;
        }

        function handleMouseClick(e) {
            const mouse = {x: e.clientX, y: e.clientY}; // Raw mouse coords
            if (gameState.isReviewingSentences) { 
                const unknownsWithExamples = gameState.roundUnknowns.filter(w => w.example);
                handleSentenceBuilderClick(mouse, gameState.review, unknownsWithExamples); 
                return; 
            }
            if (gameState.isPracticingSentences) { 
                const learnedWords = MASTER_WORD_LIST.filter(w => gameState.totalLearned.has(w.spanish) && w.example);
                handleSentenceBuilderClick(mouse, gameState.practice, learnedWords); 
                return; 
            }
            if (gameState.isRoundOver || gameState.isGameOver) {
                if(isMouseOver(mouse, gameState.buttons.main)) {
                    if (gameState.isGameOver) resetGame();
                    else gameState.round++;
                    startRound();
                }
                return;
            }

            if (gameState.feedback) return;

            const clickedSpeaker = gameState.speakerButtons.find(btn => !btn.spanishCard?.matched && isMouseOverCircle(mouse, btn));
            if(clickedSpeaker) { speak(clickedSpeaker.word); return; }
            const clickedDK = gameState.dontKnowButtons.find(btn => !btn.spanishCard.matched && isMouseOverCircle(mouse, btn));
            if (clickedDK) { revealAnswer(clickedDK.spanishCard); return; }
            const clickedCard = gameState.cards.find(card => !card.matched && isMouseOver(mouse, card));
            if (clickedCard) {
                if(clickedCard.type === 'spanish') gameState.selectedSpanish = clickedCard;
                else if (clickedCard.type === 'english') gameState.selectedEnglish = clickedCard;
                checkMatch();
            }
            if(isMouseOver(mouse, gameState.buttons.practice)) {
                const learnedWordsWithSentences = MASTER_WORD_LIST.filter(w => gameState.totalLearned.has(w.spanish) && w.example);
                if (learnedWordsWithSentences.length > 0) {
                    shuffleArray(learnedWordsWithSentences);
                    gameState.isPracticingSentences = true;
                    setupSentenceScramble(gameState.practice, learnedWordsWithSentences);
                } else {
                    console.log("Not enough words learned to practice sentences yet.");
                }
            }
        }
        
        function handleMouseMove(e) {
            // Store raw mouse coords for use in scaled calculations
            gameState.mouse.x = e.clientX;
            gameState.mouse.y = e.clientY;
        }

        canvas.addEventListener('click', handleMouseClick);
        canvas.addEventListener('mousemove', handleMouseMove);

        startRound();
        gameLoop();
    </script>
</body>
</html>
