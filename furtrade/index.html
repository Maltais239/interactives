<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fur Trade Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        .bounce { animation: bounce 1s infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .inventory-scroll::-webkit-scrollbar { width: 6px; }
        .inventory-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .inventory-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        /* Prevent layout shift during icon loading */
        .lucide { width: 1.5rem; height: 1.5rem; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="bg-amber-50 min-h-screen font-sans text-slate-800 selection:bg-amber-200">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4"></div>

    <script>
        // --- DATA & VALUES ---
        const ITEMS = {
            // FURS (Gold)
            beaver: { name: "Beaver Pelt", icon: "squirrel", type: "fur", value: 10, color: "text-amber-800", desc: "10 Gold" },
            otter: { name: "Otter Pelt", icon: "waves", type: "fur", value: 5, color: "text-slate-600", desc: "5 Gold" },
            bear: { name: "Bear Skin", icon: "paw-print", type: "fur", value: 4, color: "text-stone-900", desc: "4 Gold" },
            deer: { name: "Deerskin", icon: "venetian-mask", type: "fur", value: 3, color: "text-orange-900", desc: "3 Gold" }, 
            mink: { name: "Mink Pelt", icon: "cat", type: "fur", value: 2, color: "text-slate-500", desc: "2 Gold" },
            muskrat: { name: "Muskrat Pelt", icon: "rat", type: "fur", value: 1, color: "text-stone-500", desc: "1 Gold" },
            
            // GOODS (Prestige)
            musket: { name: "Musket", icon: "crosshair", type: "good", value: 10, color: "text-slate-800", desc: "10 Pts" },
            cauldron: { name: "Cauldron", icon: "cooking-pot", type: "good", value: 5, color: "text-orange-700", desc: "5 Pts" },
            shirt: { name: "Shirt", icon: "shirt", type: "good", value: 4, color: "text-blue-700", desc: "4 Pts" },
            blanket: { name: "Blanket", icon: "scroll", type: "good", value: 3, color: "text-red-700", desc: "3 Pts" },
            silver: { name: "Trade Silver", icon: "gem", type: "good", value: 2, color: "text-gray-400", desc: "2 Pts" },
            tools: { name: "Metal Tools", icon: "hammer", type: "good", value: 1, color: "text-slate-600", desc: "1 Pt" }
        };

        const ROLES = {
            trader: {
                title: "Fort Merchant",
                objective: "Accumulate Wealth",
                desc: "You manage a remote trading post.",
                scoring: "Gold Pieces",
                opponent: "trapper",
                opponentLabel: "Visiting Trapper",
                startLocation: "Trading Post",
                gatherVerb: "Stock Shelves",
                travelText: "The river thaws. Canoes approach your post.",
                travelIcon: "tent",
                theme: "bg-red-900",
                lightTheme: "bg-red-50",
                bankLabel: "Ship to Europe",
                bankIcon: "ship"
            },
            trapper: {
                title: "Cree Trapper",
                objective: "Gain Prestige",
                desc: "You are a skilled hunter from the Cree Nation.",
                scoring: "Prestige Points",
                opponent: "trader",
                opponentLabel: "Company Store",
                startLocation: "Winter Hunting Grounds",
                gatherVerb: "Hunt & Gather",
                travelText: "Paddling downriver to the Trading Post.",
                travelIcon: "ship",
                theme: "bg-emerald-800",
                lightTheme: "bg-emerald-50",
                bankLabel: "Back to Village",
                bankIcon: "tent"
            }
        };

        const COMPANIES = {
            hbc: { name: "Hudson's Bay Co.", location: "York Factory", color: "text-blue-900", bg: "bg-blue-900", strictness: "strict" },
            nwc: { name: "North West Co.", location: "Fort William", color: "text-red-900", bg: "bg-red-900", strictness: "relaxed" }
        };

        const DICE_TABLES = {
            trader: [
                { id: 'musket', count: 1, label: "1 Musket" },
                { id: 'cauldron', count: 2, label: "2 Cauldrons" },
                { id: 'blanket', count: 3, label: "3 Blankets" },
                { id: 'silver', count: 5, label: "5 Trade Silver" },
                { id: 'tools', count: 6, label: "6 Metal Tools" },
                { id: 'shirt', count: 2, label: "2 Shirts" }
            ],
            trapper: [
                { id: 'beaver', count: 1, label: "1 Beaver" },
                { id: 'otter', count: 2, label: "2 Otters" },
                { id: 'bear', count: 3, label: "3 Bear Skins" },
                { id: 'deer', count: 3, label: "3 Deerskins" },
                { id: 'mink', count: 5, label: "5 Minks" },
                { id: 'muskrat', count: 6, label: "6 Muskrats" }
            ]
        };

        // --- STATE ---
        let state = {
            screen: 'start',
            year: 1,
            maxYears: 3,
            role: null,
            company: 'hbc',
            companyChosenThisTurn: false,
            inventory: [], // Items currently held for trading
            bankedItems: [], // Items secured/shipped/sent home
            opponentInventory: [],
            rollsLeft: 3,
            tradeStage: 'constructing', 
            playerOffer: [],
            playerRequest: [],
            log: [],
            showHelp: false
        };

        const app = document.getElementById('app');

        // --- CORE FUNCTIONS ---

        function render() {
            app.innerHTML = '';
            let content = '';
            
            if (state.showHelp) content += renderHelpModal();
            
            switch(state.screen) {
                case 'start': content += renderStart(); break;
                case 'role_select': content += renderRoleSelect(); break;
                case 'gathering': content += renderGathering(); break;
                case 'travel': content += renderTravel(); break;
                case 'trading': content += renderTrading(); break;
                case 'summary': content += renderSummary(); break;
            }
            app.innerHTML = content;
            lucide.createIcons();
        }

        function getGroupedItems(itemArray) {
            const counts = {};
            itemArray.forEach(item => {
                if (!counts[item.id]) {
                    counts[item.id] = { ...ITEMS[item.id], id: item.id, count: 0, instances: [] };
                }
                counts[item.id].count++;
                counts[item.id].instances.push(item);
            });
            return Object.values(counts).sort((a,b) => b.value - a.value); 
        }

        // --- SCREENS ---

        function renderHelpModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="toggleHelp()">
                    <div class="bg-white rounded-2xl max-w-4xl w-full p-8 shadow-2xl relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <button onclick="toggleHelp()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><i data-lucide="x"></i></button>
                        <h2 class="text-3xl font-bold text-amber-900 mb-4 text-center">Value Guide</h2>
                        <p class="text-center text-slate-600 mb-6 text-lg">1 Gold Coin = 1 Prestige Point.<br>Try to match the values!</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="font-bold text-emerald-800 border-b border-emerald-100 pb-2 mb-2">Goods (Prestige)</h3>
                                <div class="space-y-2 text-sm">
                                    ${Object.values(ITEMS).filter(i => i.type === 'good').sort((a,b) => b.value - a.value).map(i => 
                                        `<div class="flex justify-between p-2 bg-slate-50 rounded"><span class="flex gap-2"><i data-lucide="${i.icon}"></i> ${i.name}</span> <span class="font-bold">${i.desc}</span></div>`
                                    ).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-amber-800 border-b border-amber-100 pb-2 mb-2">Furs (Gold)</h3>
                                <div class="space-y-2 text-sm">
                                    ${Object.values(ITEMS).filter(i => i.type === 'fur').sort((a,b) => b.value - a.value).map(i => 
                                        `<div class="flex justify-between p-2 bg-slate-50 rounded"><span class="flex gap-2"><i data-lucide="${i.icon}"></i> ${i.name}</span> <span class="font-bold">${i.desc}</span></div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStart() {
            return `
                <div class="max-w-2xl text-center space-y-8 fade-in">
                    <div class="flex justify-center mb-6">
                        <div class="bg-amber-900 p-6 rounded-full shadow-2xl relative">
                            <i data-lucide="scale" class="w-20 h-20 text-amber-100"></i>
                            <div class="absolute -top-2 -right-2 bg-yellow-500 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full animate-bounce">v3.1</div>
                        </div>
                    </div>
                    <h1 class="text-6xl font-extrabold text-amber-900 tracking-tight">Fur Trade Game</h1>
                    <p class="text-xl text-amber-800/80 max-w-lg mx-auto leading-relaxed">Step back to 1750. Negotiate fair trades to earn <strong>Gold</strong> or <strong>Prestige</strong>.</p>
                    <div class="flex flex-col gap-4 max-w-xs mx-auto">
                        <button onclick="setScreen('role_select')" class="px-8 py-4 bg-amber-700 hover:bg-amber-800 text-white text-xl font-bold rounded-2xl shadow-xl transform transition hover:scale-105">Start Journey</button>
                        <button onclick="toggleHelp()" class="px-8 py-3 bg-amber-100 hover:bg-amber-200 text-amber-900 font-bold rounded-xl transition">Value Guide</button>
                    </div>
                </div>
            `;
        }

        function renderRoleSelect() {
            return `
                <div class="flex flex-col items-center w-full max-w-5xl fade-in">
                    <button onclick="setScreen('start')" class="self-start mb-4 text-amber-800 font-bold hover:underline flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                    <h2 class="text-4xl font-bold text-amber-900 mb-2">Choose Your Path</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full mt-8">
                        <button onclick="selectRole('trader')" class="group relative overflow-hidden bg-white p-8 rounded-3xl shadow-lg border-4 border-transparent hover:border-red-700 transition-all text-left">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="ship" class="w-32 h-32 text-red-900"></i></div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="coins" class="w-8 h-8 text-red-700"></i></div>
                                <h3 class="text-3xl font-bold text-slate-800 mb-2">The Merchant</h3>
                                <p class="text-red-700 font-bold mb-4 uppercase text-sm">Goal: Wealth (Gold)</p>
                                <p class="text-slate-600 text-sm">"I need Beaver, Otter and Bear skins to sell in Europe."</p>
                            </div>
                        </button>
                        <button onclick="selectRole('trapper')" class="group relative overflow-hidden bg-white p-8 rounded-3xl shadow-lg border-4 border-transparent hover:border-emerald-700 transition-all text-left">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="trees" class="w-32 h-32 text-emerald-900"></i></div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="feather" class="w-8 h-8 text-emerald-700"></i></div>
                                <h3 class="text-3xl font-bold text-slate-800 mb-2">Cree Trapper</h3>
                                <p class="text-emerald-700 font-bold mb-4 uppercase text-sm">Goal: Prestige (Points)</p>
                                <p class="text-slate-600 text-sm">"I need Muskets, Cauldrons and Blankets for my village."</p>
                            </div>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderGathering() {
            const role = ROLES[state.role];
            let locationText = role.startLocation;
            if (state.role === 'trader') locationText = state.company === 'hbc' ? "York Factory (HBC)" : "Montreal Post (NWC)";
            
            const invHtml = getGroupedItems(state.inventory).map(g => `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2 slide-up">
                    <div class="relative">
                        <i data-lucide="${g.icon}" class="${g.color} w-6 h-6"></i>
                        <span class="absolute -top-2 -right-2 bg-slate-800 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full">${g.count}</span>
                    </div>
                    <span class="font-bold text-slate-700 text-sm">${g.name}</span>
                </div>
            `).join('');

            return `
                <div class="max-w-4xl w-full flex flex-col items-center">
                    <div class="flex justify-between items-end w-full mb-4 px-4">
                        <div><div class="text-xs font-bold uppercase tracking-widest text-slate-500">Year ${state.year} of ${state.maxYears}</div><h2 class="text-3xl font-bold text-slate-800">The Season of Gathering</h2></div>
                        <button onclick="toggleHelp()" class="text-amber-700 font-bold text-sm underline">Value Guide</button>
                    </div>
                    <div class="w-full bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[500px]">
                        <div class="${role.lightTheme} p-8 md:w-1/3 flex flex-col border-r border-slate-100">
                            <div class="mb-6"><div class="text-xs uppercase text-slate-500 font-bold mb-1">Location</div><div class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5"></i> ${locationText}</div></div>
                            <p class="text-slate-600 mb-6 flex-1 text-sm leading-relaxed">${role.desc}</p>
                            <div class="bg-white/50 p-4 rounded-xl border border-white/60"><div class="text-xs font-bold text-slate-500 uppercase mb-2">Total Score</div><div class="text-3xl font-bold text-slate-800">${calculateScore()} <span class="text-sm font-normal text-slate-500">${role.scoring === 'Gold Pieces' ? 'Gold' : 'Pts'}</span></div></div>
                        </div>
                        <div class="p-8 md:w-2/3 flex flex-col">
                            <div class="flex-1"><div class="text-sm font-bold text-slate-400 uppercase mb-4">Your Trading Stock</div><div class="grid grid-cols-2 lg:grid-cols-3 gap-3 content-start">${invHtml || '<div class="col-span-3 text-center text-slate-400 italic py-10 border-2 border-dashed border-slate-200 rounded-xl">Inventory empty. Roll to gather!</div>'}</div></div>
                            <div class="mt-6 border-t border-slate-100 pt-6">
                                ${state.log.length > 0 ? `<div class="text-amber-600 font-bold mb-2 text-sm text-center animate-bounce">${state.log[state.log.length-1]}</div>` : ''}
                                ${state.rollsLeft > 0 
                                    ? `<button onclick="rollDice()" class="w-full bg-slate-800 text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:bg-slate-700 transition flex items-center justify-center gap-3"><i data-lucide="dices"></i> ${role.gatherVerb} (${state.rollsLeft})</button>`
                                    : `<button onclick="setScreen('travel')" class="w-full ${role.theme} text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:opacity-90 transition flex items-center justify-center gap-3 animate-pulse"><i data-lucide="arrow-right"></i> ${state.role === 'trader' ? 'Open Trading Post' : 'Travel to Post'}</button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTravel() {
            if (state.role === 'trapper' && !state.companyChosenThisTurn) return renderCompanyChoice();
            setTimeout(() => { if(state.opponentInventory.length === 0) initOpponentInventory(); setScreen('trading'); }, 2500);
            return `
                <div class="text-center fade-in max-w-md mx-auto">
                    <div class="relative w-32 h-32 mx-auto mb-8"><div class="absolute inset-0 bg-blue-100 rounded-full animate-ping opacity-20"></div><div class="relative bg-white p-6 rounded-full shadow-xl z-10"><i data-lucide="${ROLES[state.role].travelIcon}" class="w-20 h-20 text-blue-500"></i></div></div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-4">Travelling...</h2>
                    <p class="text-xl text-slate-600 mb-2">${ROLES[state.role].travelText}</p>
                </div>
            `;
        }

        function renderCompanyChoice() {
            return `
                <div class="max-w-2xl w-full mx-auto fade-in">
                    <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">Where will you trade this season?</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onclick="chooseCompany('hbc')" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-blue-800 transition group text-left">
                            <div class="flex items-center gap-4 mb-4"><div class="bg-blue-100 p-3 rounded-lg"><i data-lucide="anchor" class="w-8 h-8 text-blue-800"></i></div><div><div class="font-bold text-blue-900 text-lg">Hudson's Bay Co.</div><div class="text-xs text-blue-600 font-semibold uppercase">York Factory</div></div></div>
                            <p class="text-slate-600 text-sm">Travel north. Strict traders, but <strong class="text-blue-800">massive inventory</strong>.</p>
                        </button>
                        <button onclick="chooseCompany('nwc')" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-red-800 transition group text-left">
                            <div class="flex items-center gap-4 mb-4"><div class="bg-red-100 p-3 rounded-lg"><i data-lucide="compass" class="w-8 h-8 text-red-800"></i></div><div><div class="font-bold text-red-900 text-lg">North West Co.</div><div class="text-xs text-red-600 font-semibold uppercase">Montreal Traders</div></div></div>
                            <p class="text-slate-600 text-sm">Meet the Voyageurs. Flexible deals, <strong class="text-red-800">limited stock</strong>.</p>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTrading() {
            const role = ROLES[state.role];
            const companyInfo = COMPANIES[state.company];
            const headerColor = state.company === 'hbc' ? 'bg-blue-900' : 'bg-red-900';
            
            // Available to Trade
            const groupedPlayerInv = getGroupedItems(state.inventory.filter(i => !state.playerOffer.some(o => o.uniqueId === i.uniqueId)));
            // Banked (Safe)
            const groupedBanked = getGroupedItems(state.bankedItems);
            // Opponent
            const groupedOpponentInv = getGroupedItems(state.opponentInventory.filter(i => !state.playerRequest.some(r => r.uniqueId === i.uniqueId)));
            
            return `
                <div class="w-full max-w-7xl h-[95vh] flex flex-col overflow-hidden">
                    <!-- HEADER -->
                    <div class="${headerColor} text-amber-50 px-6 py-4 rounded-t-2xl flex justify-between items-center shadow-lg z-20 shrink-0">
                        <div class="flex items-center gap-4"><div class="bg-white/10 p-2 rounded-lg"><i data-lucide="handshake" class="w-6 h-6"></i></div><div><h2 class="text-xl font-bold">${companyInfo.name} - Year ${state.year}</h2></div></div>
                        <div class="flex items-center gap-6">
                            <div class="text-right"><div class="text-xs uppercase opacity-70">Total Score</div><div class="font-bold text-xl">${calculateScore()}</div></div>
                            <button onclick="toggleHelp()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4"></i> Value Guide</button>
                            <button onclick="nextPhase()" class="bg-red-500/20 hover:bg-red-500/40 text-red-100 px-4 py-2 rounded-lg text-sm font-bold border border-red-500/30 transition">${state.year < state.maxYears ? 'End Year' : 'End Game'}</button>
                        </div>
                    </div>

                    <!-- BODY -->
                    <div class="flex-1 bg-amber-50 border-x border-b border-amber-900/10 rounded-b-2xl shadow-2xl flex overflow-hidden relative">
                        
                        <!-- LEFT COLUMN: PLAYER -->
                        <div class="w-1/4 bg-white border-r border-slate-200 flex flex-col">
                            
                            <!-- Top Half: Available Inventory -->
                            <div class="h-1/2 flex flex-col border-b border-slate-200">
                                <div class="p-3 bg-slate-50 border-b border-slate-100 font-bold text-xs uppercase text-slate-500 text-center sticky top-0 flex items-center justify-center gap-2"><i data-lucide="backpack" class="w-3 h-3"></i> Your Trading Stock</div>
                                <div class="p-3 overflow-y-auto inventory-scroll flex-1">
                                    ${groupedPlayerInv.map(g => `<button onclick="moveItemToTable('player', '${g.id}')" class="p-2 rounded-lg border flex items-center gap-2 w-full mb-2 bg-white border-slate-200 hover:bg-slate-50 hover:border-blue-300"><div class="relative"><i data-lucide="${g.icon}" class="${g.color} w-6 h-6"></i><span class="absolute -top-2 -right-2 bg-slate-700 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full">${g.count}</span></div><div class="flex-1 text-left ml-2"><div class="font-bold text-sm text-slate-700">${g.name}</div><div class="text-xs text-slate-400">${g.desc}</div></div></button>`).join('') || '<div class="text-center text-xs text-slate-400 mt-4">Empty</div>'}
                                </div>
                            </div>

                            <!-- Bottom Half: Banked/Safe -->
                            <div class="h-1/2 flex flex-col bg-slate-50/50">
                                <div class="p-3 bg-slate-100 border-b border-slate-200 font-bold text-xs uppercase text-slate-500 text-center sticky top-0 flex items-center justify-center gap-2"><i data-lucide="${role.bankIcon}" class="w-3 h-3"></i> ${role.bankLabel}</div>
                                <div class="p-3 overflow-y-auto inventory-scroll flex-1">
                                    ${groupedBanked.map(g => `<div class="p-2 rounded-lg border flex items-center gap-2 w-full mb-2 bg-slate-100 border-slate-200 opacity-80"><div class="relative"><i data-lucide="${g.icon}" class="${g.color} w-6 h-6 grayscale-[0.3]"></i><span class="absolute -top-2 -right-2 bg-emerald-700 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full">${g.count}</span></div><div class="flex-1 text-left ml-2"><div class="font-bold text-sm text-slate-600">${g.name}</div></div></div>`).join('') || '<div class="text-center text-xs text-slate-400 mt-4">No secured items yet</div>'}
                                </div>
                            </div>
                        </div>

                        <!-- CENTER COLUMN: TRADE TABLE -->
                        <div class="w-2/4 flex flex-col bg-slate-100 relative">
                            <div class="h-12 flex items-center justify-center bg-white border-b border-slate-200 px-4">${state.log.length > 0 ? `<div class="text-sm font-bold ${state.tradeStage === 'rejected' ? 'text-red-600' : 'text-emerald-600'} animate-bounce text-center">${state.log[state.log.length-1]}</div>` : '<div class="text-xs text-slate-400">Construct a deal...</div>'}</div>
                            <div class="flex-1 flex flex-col p-4 gap-4 overflow-hidden">
                                <div class="flex-1 bg-white rounded-xl border-2 border-dashed border-emerald-200 p-4 flex flex-col overflow-hidden relative">
                                    <div class="flex justify-between items-center mb-2"><div class="text-xs font-bold text-emerald-600 uppercase flex items-center gap-2"><i data-lucide="download" class="w-3 h-3"></i> You Get</div><div class="text-xs font-bold text-slate-400">Value: ${state.playerRequest.reduce((s,i)=>s+i.value,0)}</div></div>
                                    <div class="overflow-y-auto flex-1 pr-2">${getGroupedItems(state.playerRequest).map(g => `<button onclick="returnItemFromTable('opponent', '${g.id}')" class="bg-emerald-50 p-2 rounded border border-emerald-200 flex items-center gap-2 mb-2 w-full hover:bg-red-50 hover:border-red-200 group transition-colors"><div class="relative"><i data-lucide="${g.icon}" class="${g.color} w-5 h-5"></i><span class="absolute -top-2 -right-2 bg-emerald-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">${g.count}</span></div><span class="font-bold text-emerald-900 text-sm flex-1 text-left ml-1">${g.name}</span><i data-lucide="x" class="w-3 h-3 text-slate-400 group-hover:text-red-500"></i></button>`).join('') || '<div class="h-full flex items-center justify-center text-slate-300 text-sm italic">Click items from Store (Right)</div>'}</div>
                                </div>
                                <div class="flex justify-center -my-2 z-10"><div class="bg-slate-200 rounded-full p-1"><i data-lucide="arrow-up-down" class="w-4 h-4 text-slate-500"></i></div></div>
                                <div class="flex-1 bg-white rounded-xl border-2 border-dashed border-amber-200 p-4 flex flex-col overflow-hidden relative">
                                    <div class="flex justify-between items-center mb-2"><div class="text-xs font-bold text-amber-600 uppercase flex items-center gap-2"><i data-lucide="upload" class="w-3 h-3"></i> You Give</div><div class="text-xs font-bold text-slate-400">Value: ${state.playerOffer.reduce((s,i)=>s+i.value,0)}</div></div>
                                    <div class="overflow-y-auto flex-1 pr-2">${getGroupedItems(state.playerOffer).map(g => `<button onclick="returnItemFromTable('player', '${g.id}')" class="bg-amber-50 p-2 rounded border border-amber-200 flex items-center gap-2 mb-2 w-full hover:bg-red-50 hover:border-red-200 group transition-colors"><div class="relative"><i data-lucide="${g.icon}" class="${g.color} w-5 h-5"></i><span class="absolute -top-2 -right-2 bg-amber-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">${g.count}</span></div><span class="font-bold text-amber-900 text-sm flex-1 text-left ml-1">${g.name}</span><i data-lucide="x" class="w-3 h-3 text-slate-400 group-hover:text-red-500"></i></button>`).join('') || '<div class="h-full flex items-center justify-center text-slate-300 text-sm italic">Click items from Inventory (Left)</div>'}</div>
                                </div>
                            </div>
                            <div class="p-4 bg-white border-t border-slate-200 flex justify-center pb-8 gap-4">
                                <button onclick="tryOtherCompany()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300 transition items-center gap-2 flex">Try Other Post</button>
                                <button onclick="proposeTrade()" class="bg-slate-800 text-white px-10 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-700 transition disabled:opacity-50 flex items-center gap-2" ${state.playerOffer.length === 0 && state.playerRequest.length === 0 ? 'disabled' : ''}>Propose Deal</button>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: STORE -->
                        <div class="w-1/4 bg-white border-l border-slate-200 flex flex-col">
                             <div class="p-3 bg-slate-50 border-b border-slate-100 font-bold text-xs uppercase text-slate-500 text-center sticky top-0 flex items-center justify-center gap-2"><i data-lucide="store" class="w-3 h-3"></i> ${role.opponentLabel}</div>
                            <div class="p-3 overflow-y-auto inventory-scroll flex-1">
                                ${groupedOpponentInv.map(g => `<button onclick="moveItemToTable('opponent', '${g.id}')" class="p-2 rounded-lg border flex items-center gap-2 w-full mb-2 bg-white border-slate-200 hover:bg-slate-50 hover:border-emerald-300 text-left group"><div class="relative"><i data-lucide="${g.icon}" class="${g.color} w-6 h-6"></i><span class="absolute -top-2 -right-2 bg-slate-700 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full">${g.count}</span></div><div class="flex-1 text-left ml-2"><div class="font-bold text-sm text-slate-700">${g.name}</div><div class="text-xs text-slate-400">${g.desc}</div></div><i data-lucide="plus-circle" class="w-4 h-4 text-slate-300 group-hover:text-emerald-500"></i></button>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSummary() {
            return `
                <div class="max-w-md w-full bg-white p-8 rounded-3xl shadow-2xl text-center fade-in">
                    <div class="mb-6 flex justify-center"><div class="p-4 bg-amber-100 rounded-full ring-4 ring-amber-50"><i data-lucide="trophy" class="w-16 h-16 text-amber-600"></i></div></div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Retirement</h2>
                    <p class="text-slate-600 mb-8 text-sm leading-relaxed">${calculateScore() > 50 ? "A prosperous career." : "A hard life."}</p>
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8 relative overflow-hidden"><div class="text-xs uppercase tracking-wide text-slate-400 font-bold mb-1">Final Wealth</div><div class="text-6xl font-black text-amber-900 mb-2">${calculateScore()}</div></div>
                    <button onclick="setScreen('start')" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition shadow-lg">Play Again</button>
                </div>
            `;
        }

        // --- LOGIC ---

        function toggleHelp() { state.showHelp = !state.showHelp; render(); }
        // Score includes both banked items and remaining inventory
        function calculateScore() { 
            const invVal = state.inventory.reduce((s,i) => s + i.value, 0);
            const bankedVal = state.bankedItems.reduce((s,i) => s + i.value, 0);
            return invVal + bankedVal; 
        }
        function setScreen(s) { state.screen = s; state.log = []; if(s === 'start') resetGame(); render(); }
        
        function resetGame() {
            state = { screen: 'start', year: 1, maxYears: 3, role: null, company: 'hbc', companyChosenThisTurn: false, inventory: [], bankedItems: [], opponentInventory: [], rollsLeft: 3, tradeStage: 'constructing', playerOffer: [], playerRequest: [], log: [], showHelp: false };
        }

        function selectRole(r) { state.role = r; if(r === 'trader') state.company = Math.random() > 0.5 ? 'hbc' : 'nwc'; setScreen('gathering'); }

        function rollDice() {
            if(state.rollsLeft <= 0) return;
            const table = DICE_TABLES[state.role];
            const result = table[Math.floor(Math.random() * table.length)];
            for(let i=0; i<result.count; i++) state.inventory.push({ ...ITEMS[result.id], id: result.id, uniqueId: Math.random().toString(36).substr(2, 9) });
            state.rollsLeft--;
            state.log.push(`Found ${result.label}!`);
            render();
        }

        function chooseCompany(c) { state.company = c; state.companyChosenThisTurn = true; render(); }

        function initOpponentInventory() {
            const oppRoleKey = ROLES[state.role].opponent;
            const table = DICE_TABLES[oppRoleKey];
            state.opponentInventory = [];
            
            // HBC gets significantly more stock (8 rolls) vs NWC (4 rolls)
            // This gives HBC a higher chance of having high-tier items (Muskets/Beavers)
            const rolls = state.company === 'hbc' ? 8 : 4;

            for(let r=0; r < rolls; r++) {
                const result = table[Math.floor(Math.random() * table.length)];
                for(let i=0; i<result.count; i++) state.opponentInventory.push({ ...ITEMS[result.id], id: result.id, uniqueId: Math.random().toString(36).substr(2, 9) });
            }
        }

        function moveItemToTable(source, itemId) {
            let sArr = source === 'player' ? state.inventory : state.opponentInventory;
            let tArr = source === 'player' ? state.playerOffer : state.playerRequest;
            const item = sArr.find(i => i.id === itemId && !tArr.some(t => t.uniqueId === i.uniqueId));
            if (item) { tArr.push(item); state.tradeStage = 'constructing'; state.log = []; render(); }
        }

        function returnItemFromTable(source, itemId) {
            let tArr = source === 'player' ? state.playerOffer : state.playerRequest;
            const idx = tArr.findIndex(i => i.id === itemId);
            if (idx > -1) { tArr.splice(idx, 1); state.tradeStage = 'constructing'; state.log = []; render(); }
        }

        function proposeTrade() {
            let valGiven = state.playerOffer.reduce((s, i) => s + i.value, 0);
            let valGot = state.playerRequest.reduce((s, i) => s + i.value, 0);

            if (state.playerOffer.length === 0) { state.log = ["Give something to get something!"]; state.tradeStage = 'rejected'; render(); return; }

            let balance = valGiven - valGot; 
            let threshold = COMPANIES[state.company].strictness === 'relaxed' ? -2 : 0;

            if (balance >= threshold) {
                // Execute Trade
                
                // 1. Remove Offered items from Inventory
                state.playerOffer.forEach(o => {
                    const idx = state.inventory.findIndex(i => i.uniqueId === o.uniqueId);
                    if(idx > -1) state.inventory.splice(idx, 1);
                });

                // 2. Remove Requested items from Opponent Inventory
                state.playerRequest.forEach(r => {
                    const idx = state.opponentInventory.findIndex(i => i.uniqueId === r.uniqueId);
                    if(idx > -1) state.opponentInventory.splice(idx, 1);
                });

                // 3. Add Requested items to BANKED ITEMS (not inventory)
                state.bankedItems.push(...state.playerRequest);

                // 4. Reset Tables
                state.playerOffer = []; state.playerRequest = [];
                state.log = ["Deal accepted! Goods secured."];
                state.tradeStage = 'accepted';
            } else {
                state.tradeStage = 'rejected';
                state.log = [`No deal. I need ${Math.abs(balance)} more value.`];
            }
            render();
        }

        function tryOtherCompany() {
            state.company = state.company === 'hbc' ? 'nwc' : 'hbc';
            state.tradeStage = 'constructing';
            state.log = [`Paddled to ${COMPANIES[state.company].name}.`];
            state.playerOffer = [];
            state.playerRequest = [];
            initOpponentInventory();
            render();
        }

        function nextPhase() {
            if(state.year < state.maxYears) {
                state.year++; state.rollsLeft = 3; state.playerOffer = []; state.playerRequest = []; state.companyChosenThisTurn = false;
                setScreen('gathering');
            } else { setScreen('summary'); }
        }

        render();
    </script>
</body>
</html>
