<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fur Trade Adventure: Barter & Trade</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Animation Styles -->
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        .bounce { animation: bounce 1s infinite; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Custom Scrollbar for Inventory */
        .inventory-scroll::-webkit-scrollbar { width: 6px; }
        .inventory-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .inventory-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    </style>
</head>
<body class="bg-amber-50 min-h-screen font-sans text-slate-800 selection:bg-amber-200">

    <!-- APP CONTAINER -->
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Content injects here -->
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS & DATA ---
        
        // Asymmetric Value System
        const ITEMS = {
            // FURS (High Value to Trader, Low to Trapper)
            beaver: { name: "Beaver Pelt", icon: "squirrel", type: "fur", traderValue: 25, trapperValue: 5, color: "text-amber-700", desc: "Prime winter fur." },
            fox: { name: "Silver Fox", icon: "dog", type: "fur", traderValue: 30, trapperValue: 5, color: "text-slate-500", desc: "Rare and luxurious." },
            bear: { name: "Bear Skin", icon: "paw-print", type: "fur", traderValue: 20, trapperValue: 10, color: "text-stone-800", desc: "Heavy and warm." },
            
            // GOODS (High Value to Trapper, Low to Trader)
            musket: { name: "Musket", icon: "crosshair", type: "good", traderValue: 10, trapperValue: 40, color: "text-slate-800", desc: "Essential for hunting." },
            kettle: { name: "Copper Kettle", icon: "cooking-pot", type: "good", traderValue: 5, trapperValue: 20, color: "text-orange-700", desc: "Durable cookware." },
            blanket: { name: "Wool Blanket", icon: "scroll", type: "good", traderValue: 3, trapperValue: 15, color: "text-red-700", desc: "Warmth for winter." },
            beads: { name: "Glass Beads", icon: "gem", type: "good", traderValue: 2, trapperValue: 10, color: "text-blue-600", desc: "Valuable for ceremony." }
        };

        const ROLES = {
            trader: {
                title: "Travelling Merchant",
                objective: "Accumulate Wealth",
                desc: "You come from Montreal with manufactured goods.",
                goalText: "The Trappers value your metal goods highly, but they have little use for furs beyond their own needs. Buy Furs cheaply!",
                scoring: "Wealth (£)",
                opponent: "trapper",
                startLocation: "Montreal Warehouse",
                gatherVerb: "Stock Up",
                theme: "bg-red-900",
                lightTheme: "bg-red-50",
                icon: "ship"
            },
            trapper: {
                title: "First Nations Trapper",
                objective: "Gain Prestige & Tools",
                desc: "You live on the land and hunt skilled game.",
                goalText: "The Merchant values your furs highly for European markets. You have plenty of furs, but metal tools are rare and precious to you.",
                scoring: "Prestige (Pts)",
                opponent: "trader",
                startLocation: "Winter Hunting Grounds",
                gatherVerb: "Hunt & Gather",
                theme: "bg-emerald-800",
                lightTheme: "bg-emerald-50",
                icon: "tent"
            }
        };

        const DICE_TABLES = {
            trader: [
                { id: 'musket', count: 1, label: "1 Musket" },
                { id: 'kettle', count: 2, label: "2 Kettles" },
                { id: 'blanket', count: 3, label: "3 Blankets" },
                { id: 'beads', count: 5, label: "Box of Beads" },
                { id: 'musket', count: 2, label: "2 Muskets" },
                { id: 'blanket', count: 5, label: "5 Blankets" }
            ],
            trapper: [
                { id: 'beaver', count: 2, label: "2 Beavers" },
                { id: 'fox', count: 1, label: "1 Silver Fox" },
                { id: 'bear', count: 1, label: "1 Bear Skin" },
                { id: 'beaver', count: 3, label: "3 Beavers" },
                { id: 'fox', count: 2, label: "2 Foxes" },
                { id: 'beaver', count: 1, label: "1 Beaver" }
            ]
        };

        // --- STATE ---
        let state = {
            screen: 'start',
            year: 1,
            maxYears: 3,
            role: null,
            inventory: [],
            opponentInventory: [],
            rollsLeft: 3,
            tradeStage: 'offer', // offer, review, result
            playerOffer: [],
            opponentOffer: [],
            score: 0,
            log: [],
            showHelp: false
        };

        // --- DOM ELEMENTS ---
        const app = document.getElementById('app');

        // --- RENDERER ---
        function render() {
            app.innerHTML = '';
            
            // Modal Overlay for Help
            let helpModal = '';
            if (state.showHelp) {
                helpModal = renderHelpModal();
            }

            let content = '';
            switch(state.screen) {
                case 'start': content = renderStart(); break;
                case 'role_select': content = renderRoleSelect(); break;
                case 'gathering': content = renderGathering(); break;
                case 'travel': content = renderTravel(); break;
                case 'trading': content = renderTrading(); break;
                case 'summary': content = renderSummary(); break;
            }

            app.innerHTML = content + helpModal;
            lucide.createIcons();
        }

        // --- COMPONENTS ---

        function renderHelpModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="toggleHelp()">
                    <div class="bg-white rounded-2xl max-w-2xl w-full p-8 shadow-2xl relative" onclick="event.stopPropagation()">
                        <button onclick="toggleHelp()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><i data-lucide="x"></i></button>
                        <h2 class="text-2xl font-bold text-amber-900 mb-4">Understanding Value</h2>
                        
                        <div class="grid grid-cols-2 gap-8 mb-6">
                            <div class="bg-red-50 p-4 rounded-xl">
                                <h3 class="font-bold text-red-900 mb-2 flex items-center gap-2"><i data-lucide="ship" class="w-4 h-4"></i> The Merchant</h3>
                                <p class="text-sm text-slate-700 mb-2">Needs <strong>Furs</strong> for Europe.</p>
                                <ul class="text-xs space-y-1 text-slate-600">
                                    <li class="flex justify-between"><span>Silver Fox</span> <span class="font-bold">High Value</span></li>
                                    <li class="flex justify-between"><span>Beaver</span> <span class="font-bold">Med Value</span></li>
                                    <li class="flex justify-between"><span>Goods</span> <span class="text-red-500">Low Value</span></li>
                                </ul>
                            </div>
                            <div class="bg-emerald-50 p-4 rounded-xl">
                                <h3 class="font-bold text-emerald-900 mb-2 flex items-center gap-2"><i data-lucide="tent" class="w-4 h-4"></i> The Trapper</h3>
                                <p class="text-sm text-slate-700 mb-2">Needs <strong>Tools</strong> for survival.</p>
                                <ul class="text-xs space-y-1 text-slate-600">
                                    <li class="flex justify-between"><span>Musket</span> <span class="font-bold">High Value</span></li>
                                    <li class="flex justify-between"><span>Kettle</span> <span class="font-bold">Med Value</span></li>
                                    <li class="flex justify-between"><span>Furs</span> <span class="text-emerald-500">Low Value</span></li>
                                </ul>
                            </div>
                        </div>

                        <p class="text-slate-600 italic text-sm border-t pt-4">
                            <strong>Tip:</strong> Buy low, sell high. Trade items that are cheap for you but expensive for them.
                        </p>
                    </div>
                </div>
            `;
        }

        // --- SCREENS ---

        function renderStart() {
            return `
                <div class="max-w-2xl text-center space-y-8 fade-in">
                    <div class="flex justify-center mb-6">
                        <div class="bg-amber-900 p-6 rounded-full shadow-2xl relative">
                            <i data-lucide="scale" class="w-20 h-20 text-amber-100"></i>
                            <div class="absolute -top-2 -right-2 bg-yellow-500 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full animate-bounce">v1.0</div>
                        </div>
                    </div>
                    <h1 class="text-6xl font-extrabold text-amber-900 tracking-tight">The Fur Trade</h1>
                    <p class="text-xl text-amber-800/80 max-w-lg mx-auto leading-relaxed">
                        A game of asymmetrical value. <br>
                        Negotiate trades over <strong>3 Years</strong> to maximize your fortune.
                    </p>
                    
                    <div class="flex flex-col gap-4 max-w-xs mx-auto">
                        <button onclick="setScreen('role_select')" class="px-8 py-4 bg-amber-700 hover:bg-amber-800 text-white text-xl font-bold rounded-2xl shadow-xl transform transition hover:scale-105">
                            Start Journey
                        </button>
                        <button onclick="toggleHelp()" class="px-8 py-3 bg-amber-100 hover:bg-amber-200 text-amber-900 font-bold rounded-xl transition">
                            How to Play
                        </button>
                    </div>
                </div>
            `;
        }

        function renderRoleSelect() {
            return `
                <div class="flex flex-col items-center w-full max-w-5xl fade-in">
                    <button onclick="setScreen('start')" class="self-start mb-4 text-amber-800 font-bold hover:underline flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                    <h2 class="text-4xl font-bold text-amber-900 mb-2">Choose Your Path</h2>
                    <p class="text-amber-800/70 mb-10">Each role values items differently.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                        <!-- Merchant Card -->
                        <button onclick="selectRole('trader')" class="group relative overflow-hidden bg-white p-8 rounded-3xl shadow-lg border-4 border-transparent hover:border-red-700 transition-all text-left">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                                <i data-lucide="ship" class="w-32 h-32 text-red-900"></i>
                            </div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mb-6">
                                    <i data-lucide="coins" class="w-8 h-8 text-red-700"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-slate-800 mb-2">The Merchant</h3>
                                <p class="text-red-700 font-bold mb-4 uppercase tracking-wider text-sm">Wealth (£)</p>
                                <p class="text-slate-600 text-sm mb-4">
                                    "I bring metal goods from Europe. I need Furs to sell in London."
                                </p>
                                <div class="bg-red-50 p-3 rounded-lg text-xs text-red-900 font-semibold">
                                    Goal: Trade cheap goods for expensive furs.
                                </div>
                            </div>
                        </button>

                        <!-- Trapper Card -->
                        <button onclick="selectRole('trapper')" class="group relative overflow-hidden bg-white p-8 rounded-3xl shadow-lg border-4 border-transparent hover:border-emerald-700 transition-all text-left">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                                <i data-lucide="trees" class="w-32 h-32 text-emerald-900"></i>
                            </div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center mb-6">
                                    <i data-lucide="feather" class="w-8 h-8 text-emerald-700"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-slate-800 mb-2">The Trapper</h3>
                                <p class="text-emerald-700 font-bold mb-4 uppercase tracking-wider text-sm">Prestige (Pts)</p>
                                <p class="text-slate-600 text-sm mb-4">
                                    "I hunt the land. I have many furs, but I need muskets and kettles."
                                </p>
                                <div class="bg-emerald-50 p-3 rounded-lg text-xs text-emerald-900 font-semibold">
                                    Goal: Trade abundant furs for rare tools.
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderGathering() {
            const role = ROLES[state.role];
            
            const invHtml = state.inventory.map(item => `
                <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2 slide-up text-sm">
                    <i data-lucide="${ITEMS[item.id].icon}" class="${ITEMS[item.id].color} w-4 h-4"></i>
                    <span class="font-bold text-slate-700 truncate">${item.name}</span>
                </div>
            `).join('');

            const actionButton = state.rollsLeft > 0 
                ? `<button onclick="rollDice()" class="w-full mt-4 bg-slate-800 text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:bg-slate-700 transition flex items-center justify-center gap-3">
                     <i data-lucide="dices"></i> Gather Supplies (${state.rollsLeft})
                   </button>`
                : `<button onclick="setScreen('travel')" class="w-full mt-4 ${role.theme} text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:opacity-90 transition flex items-center justify-center gap-3 animate-pulse">
                     <i data-lucide="arrow-right"></i> Travel to Trade Post
                   </button>`;

            return `
                <div class="max-w-4xl w-full flex flex-col items-center fade-in">
                    <!-- Header -->
                    <div class="flex justify-between items-end w-full mb-4 px-4">
                        <div>
                            <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Year ${state.year} of ${state.maxYears}</div>
                            <h2 class="text-3xl font-bold text-slate-800">The Season of Gathering</h2>
                        </div>
                        <button onclick="toggleHelp()" class="text-amber-700 font-bold text-sm underline">Value Guide</button>
                    </div>

                    <div class="w-full bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[500px]">
                        <!-- Left Panel: Context -->
                        <div class="${role.lightTheme} p-8 md:w-1/3 flex flex-col border-r border-slate-100">
                            <div class="mb-6">
                                <div class="text-xs uppercase text-slate-500 font-bold mb-1">Location</div>
                                <div class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-5 h-5"></i> ${role.startLocation}
                                </div>
                            </div>
                            <p class="text-slate-600 mb-6 flex-1 text-sm leading-relaxed">${role.desc}</p>
                            
                            <div class="bg-white/50 p-4 rounded-xl border border-white/60">
                                <div class="text-xs font-bold text-slate-500 uppercase mb-2">Current Wealth</div>
                                <div class="text-3xl font-bold text-slate-800">${calculateScore()}</div>
                            </div>
                        </div>

                        <!-- Right Panel: Action -->
                        <div class="p-8 md:w-2/3 flex flex-col">
                            <div class="flex-1">
                                <div class="text-sm font-bold text-slate-400 uppercase mb-4">Your Inventory</div>
                                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 content-start">
                                    ${invHtml || '<div class="col-span-3 text-center text-slate-400 italic py-10 border-2 border-dashed border-slate-200 rounded-xl">Inventory empty. Roll to gather!</div>'}
                                </div>
                            </div>
                            
                            <div class="mt-6 border-t border-slate-100 pt-6">
                                ${state.log.length > 0 ? `<div class="text-amber-600 font-bold mb-2 text-sm text-center animate-bounce">${state.log[state.log.length-1]}</div>` : ''}
                                ${actionButton}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTravel() {
            setTimeout(() => {
                if(state.opponentInventory.length === 0) initOpponentInventory();
                setScreen('trading');
            }, 2500);

            return `
                <div class="text-center fade-in max-w-md mx-auto">
                    <div class="relative w-32 h-32 mx-auto mb-8">
                        <div class="absolute inset-0 bg-blue-100 rounded-full animate-ping opacity-20"></div>
                        <div class="relative bg-white p-6 rounded-full shadow-xl z-10">
                            <i data-lucide="waves" class="w-20 h-20 text-blue-500"></i>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-4">Travelling...</h2>
                    <p class="text-xl text-slate-600">
                        Leaving ${ROLES[state.role].startLocation}...<br>
                        Approaching the Trading Post.
                    </p>
                </div>
            `;
        }

        function renderTrading() {
            const role = ROLES[state.role];
            const oppRole = ROLES[role.opponent];
            
            // Render Player Items (No fade-in on individual items to prevent flash)
            const playerInvHtml = state.inventory.map((item, i) => `
                <button onclick="toggleOffer(${i})" 
                    class="p-2 rounded-lg border flex items-center gap-3 w-full mb-2 transition-colors duration-100
                    ${state.playerOffer.some(o => o.uniqueId === item.uniqueId) 
                        ? 'bg-amber-100 border-amber-500 ring-1 ring-amber-500' 
                        : 'bg-white border-slate-200 hover:bg-slate-50'}
                ">
                    <i data-lucide="${ITEMS[item.id].icon}" class="${ITEMS[item.id].color} w-5 h-5"></i>
                    <div class="text-left flex-1">
                        <div class="font-bold text-sm text-slate-700">${item.name}</div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-wide">
                           Value to Them: <span class="${role.opponent === 'trader' ? 'text-green-600 font-bold' : 'text-slate-500'}">${role.opponent === 'trader' ? ITEMS[item.id].traderValue : ITEMS[item.id].trapperValue}</span>
                        </div>
                    </div>
                </button>
            `).join('');
            
            const opponentOfferHtml = state.opponentOffer.length > 0 
                ? state.opponentOffer.map(item => `
                    <div class="bg-emerald-50 p-2 rounded border border-emerald-200 flex items-center gap-2 mb-2">
                        <i data-lucide="${ITEMS[item.id].icon}" class="${ITEMS[item.id].color} w-4 h-4"></i>
                        <div class="flex-1">
                             <span class="font-bold text-emerald-900 text-sm">${item.name}</span>
                             <div class="text-[10px] text-slate-500">Value to You: ${role.role === 'trader' ? ITEMS[item.id].traderValue : ITEMS[item.id].trapperValue}</div>
                        </div>
                    </div>`).join('')
                : '<div class="text-slate-400 italic text-center py-10 text-sm">Waiting for negotiation...</div>';

            // Animation class only applied if transitioning
            const containerClass = state.previousScreen !== 'trading' ? 'fade-in' : '';

            return `
                <div class="w-full max-w-6xl h-[90vh] flex flex-col ${containerClass}">
                    
                    <!-- HEADER -->
                    <div class="bg-amber-900 text-amber-50 px-6 py-4 rounded-t-2xl flex justify-between items-center shadow-lg z-10">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/10 p-2 rounded-lg"><i data-lucide="handshake" class="w-6 h-6"></i></div>
                            <div>
                                <h2 class="text-xl font-bold">Trading Post - Year ${state.year}</h2>
                                <p class="text-sm text-amber-200/80">Goal: Trade for high value items.</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-right hidden md:block">
                                <div class="text-xs uppercase tracking-wide opacity-70">Opponent Wants</div>
                                <div class="font-bold text-amber-200">${state.role === 'trader' ? 'Furs' : 'Tools/Goods'}</div>
                            </div>
                             <div class="text-right">
                                <div class="text-xs uppercase tracking-wide opacity-70">Your Wealth</div>
                                <div class="font-bold text-xl">${calculateScore()}</div>
                            </div>
                            <button onclick="toggleHelp()" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition"><i data-lucide="info"></i></button>
                        </div>
                    </div>

                    <!-- MAIN AREA -->
                    <div class="flex-1 bg-amber-50 border-x border-b border-amber-900/10 rounded-b-2xl shadow-2xl flex overflow-hidden relative">
                        
                        <!-- LEFT: YOUR INVENTORY -->
                        <div class="w-1/3 bg-white border-r border-slate-200 flex flex-col">
                            <div class="p-3 bg-slate-50 border-b border-slate-100 font-bold text-xs uppercase text-slate-500 text-center sticky top-0">Your Inventory</div>
                            <div class="p-4 overflow-y-auto inventory-scroll flex-1">
                                ${state.inventory.length === 0 ? '<div class="text-center text-slate-400 text-sm mt-10">Empty.</div>' : playerInvHtml}
                            </div>
                        </div>

                        <!-- CENTER: THE TABLE -->
                        <div class="w-1/3 flex flex-col bg-slate-50/50">
                            
                            <!-- Opponent Offers -->
                            <div class="flex-1 p-4 overflow-y-auto border-b border-slate-200 bg-white">
                                <div class="text-center text-xs font-bold text-emerald-600 uppercase mb-3">Opponent Offers</div>
                                ${opponentOfferHtml}
                            </div>

                            <!-- Interaction Zone -->
                            <div class="min-h-[160px] p-4 bg-slate-100 border-y border-white shadow-inner flex flex-col items-center justify-center space-y-3 z-10">
                                ${renderTradeControls()}
                            </div>

                            <!-- Your Offers -->
                            <div class="flex-1 p-4 overflow-y-auto bg-white border-t border-slate-200">
                                <div class="text-center text-xs font-bold text-amber-600 uppercase mb-3">You Offer</div>
                                ${state.playerOffer.map(item => `
                                    <div class="bg-amber-50 p-2 rounded border border-amber-200 flex items-center gap-2 mb-2">
                                        <i data-lucide="${ITEMS[item.id].icon}" class="${ITEMS[item.id].color} w-4 h-4"></i>
                                        <span class="font-bold text-amber-900 text-sm flex-1">${item.name}</span>
                                        <button onclick="toggleOffer(${state.inventory.findIndex(i => i.uniqueId === item.uniqueId)})" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                                    </div>
                                `).join('')}
                                ${state.playerOffer.length === 0 ? '<div class="text-slate-300 italic text-center text-xs">Select items on left...</div>' : ''}
                            </div>

                        </div>

                        <!-- RIGHT: OPPONENT STATUS -->
                        <div class="w-1/3 bg-slate-50 flex flex-col items-center border-l border-slate-200 relative">
                             
                             <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
                                 <div class="relative mb-4">
                                     <div class="w-24 h-24 rounded-full bg-white shadow-md flex items-center justify-center border-4 ${state.role === 'trader' ? 'border-emerald-200' : 'border-red-200'}">
                                        <i data-lucide="${oppRole.icon}" class="w-12 h-12 text-slate-700"></i>
                                     </div>
                                     <div class="absolute -bottom-2 -right-2 bg-slate-800 text-white text-xs px-2 py-1 rounded-full font-bold">
                                        ${state.opponentInventory.length} Items
                                     </div>
                                 </div>
                                 <h3 class="text-lg font-bold text-slate-800">${oppRole.title}</h3>
                                 <div class="mt-2 text-xs bg-white border border-slate-200 p-2 rounded-lg text-slate-500 max-w-[200px] shadow-sm">
                                    "I have goods. I need what you have. Make me a fair offer."
                                 </div>
                             </div>

                             <!-- LEAVE BUTTON -->
                             <div class="w-full p-6 border-t border-slate-200 bg-white">
                                <button onclick="nextPhase()" class="w-full py-3 border-2 border-slate-200 rounded-xl font-bold text-slate-500 hover:border-slate-800 hover:text-slate-800 transition text-sm">
                                    ${state.year < state.maxYears ? 'Finish Trading (Next Year)' : 'End Game (Final Score)'}
                                </button>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTradeControls() {
            if (state.tradeStage === 'offer') {
                return `
                    <div class="text-xs text-slate-500">Select items to propose a trade</div>
                    <button onclick="makeOffer()" class="w-full max-w-[200px] bg-slate-800 text-white py-2 rounded-lg font-bold shadow hover:bg-slate-700 transition disabled:opacity-50 text-sm" ${state.playerOffer.length === 0 ? 'disabled' : ''}>
                        Propose Trade
                    </button>
                `;
            } else if (state.tradeStage === 'review') {
                return `
                    <div class="text-sm font-bold text-slate-800 text-center px-2 animate-pulse">${state.log[state.log.length-1]}</div>
                    <div class="flex gap-2 w-full justify-center">
                        <button onclick="acceptTrade()" class="flex-1 max-w-[100px] bg-emerald-600 text-white py-2 rounded-lg font-bold hover:bg-emerald-700 shadow text-sm">Accept</button>
                        <button onclick="rejectTrade()" class="flex-1 max-w-[100px] bg-red-100 text-red-700 py-2 rounded-lg font-bold hover:bg-red-200 shadow text-sm">Decline</button>
                    </div>
                `;
            } else if (state.tradeStage === 'rejected') {
                 return `
                    <div class="text-sm font-bold text-red-600 text-center px-2">${state.log[state.log.length-1]}</div>
                    <button onclick="resetTradeState()" class="mt-2 text-slate-500 underline text-xs">Try a different offer</button>
                `;
            }
        }

        function renderSummary() {
            const role = ROLES[state.role];
            const finalScore = calculateScore();
            
            let feedback = "";
            if(finalScore > 300) feedback = "Legendary! You have built a fortune that will last generations.";
            else if(finalScore > 150) feedback = "A prosperous career. You retired comfortable and respected.";
            else feedback = "A hard life. You survived, but fortune eluded you.";

            return `
                <div class="max-w-md w-full bg-white p-8 rounded-3xl shadow-2xl text-center fade-in">
                    <div class="mb-6 flex justify-center">
                         <div class="p-4 bg-amber-100 rounded-full ring-4 ring-amber-50">
                            <i data-lucide="trophy" class="w-16 h-16 text-amber-600"></i>
                         </div>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Retirement</h2>
                    <p class="text-slate-600 mb-8 text-sm leading-relaxed">${feedback}</p>
                    
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>
                        <div class="text-xs uppercase tracking-wide text-slate-400 font-bold mb-1">Final Wealth</div>
                        <div class="text-6xl font-black text-amber-900 mb-2">${finalScore}</div>
                        <div class="text-xs text-slate-400 font-medium">Accumulated over ${state.maxYears} Years</div>
                    </div>

                    <button onclick="setScreen('start')" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition shadow-lg">Play Again</button>
                </div>
            `;
        }


        // --- LOGIC ---

        function toggleHelp() {
            state.showHelp = !state.showHelp;
            render();
        }

        function calculateScore() {
            let score = 0;
            state.inventory.forEach(item => {
                // Score depends on WHO you are.
                if(state.role === 'trader') score += item.traderValue;
                if(state.role === 'trapper') score += item.trapperValue;
            });
            return score;
        }

        function setScreen(s) {
            state.previousScreen = state.screen; // Track previous screen to manage animations
            state.screen = s;
            state.log = [];
            if(s === 'start') resetGame();
            render();
        }

        function resetGame() {
            state = {
                screen: 'start',
                year: 1,
                maxYears: 3,
                role: null,
                inventory: [],
                opponentInventory: [],
                rollsLeft: 3,
                tradeStage: 'offer',
                playerOffer: [],
                opponentOffer: [],
                score: 0,
                log: [],
                showHelp: false
            };
        }

        function selectRole(r) {
            state.role = r;
            setScreen('gathering');
        }

        function rollDice() {
            if(state.rollsLeft <= 0) return;
            
            const table = DICE_TABLES[state.role];
            const rollIndex = Math.floor(Math.random() * table.length);
            const result = table[rollIndex];

            // Add unique IDs to items so we can track them individually
            for(let i=0; i<result.count; i++) {
                state.inventory.push({ ...ITEMS[result.id], id: result.id, uniqueId: Math.random().toString(36).substr(2, 9) });
            }

            state.rollsLeft--;
            state.log.push(`Found ${result.label}!`);
            render();
        }

        function initOpponentInventory() {
            const oppRoleKey = ROLES[state.role].opponent;
            const table = DICE_TABLES[oppRoleKey];
            
            // AI gets replenished every time you visit
            state.opponentInventory = [];
            
            // Give AI a good stock (5 rolls worth)
            for(let r=0; r<5; r++) {
                const result = table[Math.floor(Math.random() * table.length)];
                for(let i=0; i<result.count; i++) {
                    state.opponentInventory.push({ ...ITEMS[result.id], id: result.id, uniqueId: Math.random().toString(36).substr(2, 9) });
                }
            }
        }

        function toggleOffer(idx) {
            const item = state.inventory[idx];
            const offerIdx = state.playerOffer.findIndex(i => i.uniqueId === item.uniqueId);
            
            if(offerIdx >= 0) {
                state.playerOffer.splice(offerIdx, 1);
            } else {
                state.playerOffer.push(item);
            }
            // Do NOT change state.screen, just re-render to update UI
            render(); 
        }

        function makeOffer() {
            // 1. Calculate Value of Player's Offer TO THE AI
            // This is the core mechanic. AI only cares about what IT values.
            let valueToAI = 0;
            state.playerOffer.forEach(item => {
                if(state.role === 'trader') valueToAI += item.trapperValue; // AI is Trapper
                else valueToAI += item.traderValue; // AI is Trader
            });

            // 2. Reject Lowball
            if(valueToAI < 5) {
                state.log = ["That offers me nothing of value."];
                state.tradeStage = 'rejected';
                render();
                return;
            }

            // 3. AI Counter Offer
            // AI is willing to give items up to `valueToAI` + small bonus
            let targetValue = valueToAI * (0.9 + Math.random() * 0.2); // Random fairness
            let currentOfferValue = 0;
            state.opponentOffer = [];
            
            // Sort AI inventory: It gives away items it values LEAST first? 
            // Actually, for better gameplay, it should give items the PLAYER values MOST?
            // Let's mix it. It creates a bundle.
            let aiStock = [...state.opponentInventory];
            
            // Shuffle stock for variety
            aiStock.sort(() => Math.random() - 0.5);

            for(let item of aiStock) {
                // Value calculation
                let itemValToAI = (state.role === 'trader') ? item.trapperValue : item.traderValue;
                
                // If adding this item keeps us under the "Fair Trade" limit
                if (currentOfferValue + itemValToAI <= targetValue + 2) {
                    state.opponentOffer.push(item);
                    currentOfferValue += itemValToAI;
                }
            }

            if(state.opponentOffer.length === 0) {
                 state.log = ["I have nothing to trade for that."];
                 state.tradeStage = 'rejected';
            } else {
                 state.log = ["I offer this in exchange."];
                 state.tradeStage = 'review';
            }
            render();
        }

        function acceptTrade() {
            // Player loses offered items
            state.playerOffer.forEach(offerItem => {
                const idx = state.inventory.findIndex(i => i.uniqueId === offerItem.uniqueId);
                if(idx > -1) state.inventory.splice(idx, 1);
            });

            // AI loses offered items
            state.opponentOffer.forEach(offerItem => {
                const idx = state.opponentInventory.findIndex(i => i.uniqueId === offerItem.uniqueId);
                if(idx > -1) state.opponentInventory.splice(idx, 1);
            });

            // Player gains AI items
            state.inventory.push(...state.opponentOffer);

            resetTradeState();
            state.log = ["Trade successful!"];
            render();
        }

        function rejectTrade() {
            state.opponentOffer = []; // Clear what they showed
            state.tradeStage = 'offer'; // Back to selection
            state.log = ["Offer declined."];
            render();
        }

        function resetTradeState() {
            state.playerOffer = [];
            state.opponentOffer = [];
            state.tradeStage = 'offer';
        }

        function nextPhase() {
            if(state.year < state.maxYears) {
                state.year++;
                state.rollsLeft = 3; // Reset rolls for next year
                state.playerOffer = [];
                state.opponentOffer = [];
                setScreen('gathering');
            } else {
                setScreen('summary');
            }
        }

        // Init
        render();

    </script>
</body>
</html>
